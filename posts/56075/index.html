<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="Scheme入门教程, 博客 joytsing blog"><meta name="description" content="Scheme快速入门"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="theme-color" content="white"><title>Scheme入门教程 | JoyTsing</title><link rel="apple-touch-icon" href="/"><link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="/css/matery.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><style type="text/css">code[class*=language-],pre[class*=language-]{white-space:pre!important}</style><script src="/libs/jquery/jquery.min.js"></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="JoyTsing" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="/apple-touch-icon.png" class="logo-img" alt="LOGO"> <span class="logo-span">JoyTsing</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fa fa-home"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa fa-tags"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa fa-bookmark"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa fa-archive"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa fa-user-circle-o"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa fa-envelope"></i> <span>留言</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa fa-address-book"></i> <span>友链</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fa fa-search" title="搜索"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="/medias/avatars/touxiang2.jpg" class="logo-img circle responsive-img"><div class="logo-name">JoyTsing</div><div class="logo-desc">joytsing的个人博客</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa fa-fw fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa fa-fw fa-user-circle-o"></i> 关于</a></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa fa-fw fa-envelope"></i> 留言</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa fa-fw fa-address-book"></i> 友链</a></li><li><div class="divider"></div></li><li><a href="https://github.com/JoyTsing" class="waves-effect waves-light" target="_blank"><i class="fa fa-github-square fa-fw"></i>Follow Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#000;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/JoyTsing" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Follow Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(/medias/featureimages/6.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">Scheme入门教程</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{height:calc(100vh - 250px);overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/%E6%95%99%E7%A8%8B/"><span class="chip bg-color">教程</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fa fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E6%9D%82%E8%AE%B0/" class="post-category">杂记</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp; 2021-03-05</div><div class="post-date info-break-policy"><i class="fa fa-calendar-check-o fa-fw"></i>更新日期:&nbsp;&nbsp; 2024-03-21</div><div class="info-break-policy"><i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp; 26.9k</div><div class="info-break-policy"><i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp; 117 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp; <span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>虽然目前因为scheme过时，最新的SICP已经采用python作为系列语言，但是通过前两章的学习，可以说，Scheme（lisp方言）是一门充满魅力的语言，而且在之前有过关于用C设计lisp语言的学习，都用C写出来了lisp结果不熟悉lisp未免来说过于尴尬，因此决定恶补一下scheme。</p><h2 id="四种基本算术操作"><a href="#四种基本算术操作" class="headerlink" title="四种基本算术操作"></a>四种基本算术操作</h2><p>Scheme（以及大多数Lisp方言）都可以处理分数。</p><p>函数<code>exact-&gt;inexact</code> 用于把分数转换为浮点数。Scheme也可以处理复数。复数是形如<code>a+bi</code>的数，此处<code>a</code>称为实部，<code>b</code>称为虚部。<code>+</code>、<code>-</code>、<code>*</code>和<code>/</code>分别代表加、减、乘、除。这些函数都接受任意多的参数。</p><p>例：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token operator">-</span> <span class="token number">10</span> <span class="token number">3</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">;→ 7</span>
<span class="token punctuation">(</span><span class="token operator">-</span> <span class="token number">10</span> <span class="token number">3</span> <span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">;→ 2</span>
<span class="token punctuation">(</span><span class="token operator">*</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">;→ 6</span>
<span class="token punctuation">(</span><span class="token operator">*</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">;→ 24</span>
<span class="token punctuation">(</span><span class="token operator">/</span> <span class="token number">29</span> <span class="token number">3</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">;→ 29/3</span>
<span class="token punctuation">(</span><span class="token operator">/</span> <span class="token number">29</span> <span class="token number">3</span> <span class="token number">7</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">;→ 29/21</span>
<span class="token punctuation">(</span><span class="token operator">/</span> <span class="token number">9</span> <span class="token number">6</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">;→ 3/2</span>
<span class="token punctuation">(</span><span class="token function">exact->inexact</span> <span class="token punctuation">(</span><span class="token operator">/</span> <span class="token number">29</span> <span class="token number">3</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">;→ 1.380952380952381</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>括号可以像下面这样嵌套：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span> <span class="token number">5</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">;→ 10</span>
<span class="token punctuation">(</span><span class="token operator">/</span> <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">9</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">;→ 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>形如这些由<strong>括号</strong>、<strong>标记（token）</strong>以及<strong>分隔符</strong>组成的式子，被称为<strong>S-表达式</strong>。</p><h3 id="其它算术操作"><a href="#其它算术操作" class="headerlink" title="其它算术操作"></a>其它算术操作</h3><h3 id="quotient，remainder，modulo和sqrt"><a href="#quotient，remainder，modulo和sqrt" class="headerlink" title="quotient，remainder，modulo和sqrt"></a>quotient，remainder，modulo和sqrt</h3><ul><li>函数<code>quotient</code>用于求<strong>商数（quotient）</strong>。</li><li>函数<code>remainder</code>和<code>modulo</code>用于求<strong>余数（remainder）</strong>。</li><li>函数<code>sqrt</code>用于求参数的<strong>平方根（square root）</strong>。</li></ul><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">quotient</span> <span class="token number">7</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">;→ 2</span>
<span class="token punctuation">(</span><span class="token function">modulo</span> <span class="token number">7</span> <span class="token number">3</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">;→ 1</span>
<span class="token punctuation">(</span><span class="token function">sqrt</span> <span class="token number">8</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true">;→ 2.8284271247461903</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="三角函数"><a href="#三角函数" class="headerlink" title="三角函数"></a>三角函数</h3><p>数学上的三角函数，诸如<code>sin</code>，<code>cos</code>，<code>tan</code>，<code>asin</code>，<code>acos</code>和<code>atan</code>都可以在Scheme中使用。<code>atan</code>接受1个或2个参数。如果<code>atan</code>的参数为<code>1/2 π</code>，那么就要使用两个参数来计算。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">atan</span> <span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">;→ 0.7853981633974483</span>
<span class="token punctuation">(</span><span class="token function">atan</span> <span class="token number">1</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">;→ 1.5707963267948966</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="指数和对数"><a href="#指数和对数" class="headerlink" title="指数和对数"></a>指数和对数</h3><p>指数通过<code>exp</code>函数运算，对数通过<code>log</code>函数运算。<code>a</code>的<code>b</code>次幂可以通过<code>(expt a b)</code>来计算。</p><h2 id="生成表"><a href="#生成表" class="headerlink" title="生成表"></a>生成表</h2><p>作为Lisp语言大家族的一员，Scheme同样擅长于处理表。表在在后面章节中的递归函数和高阶函数中扮演重要角色。在本章中会讲解基本的表操作，例如<code>cons</code>，<code>car</code>，<code>cdr</code>，<code>list</code>和<code>quote</code>。</p><h3 id="Cons单元和表"><a href="#Cons单元和表" class="headerlink" title="Cons单元和表"></a>Cons单元和表</h3><h4 id="Cons单元"><a href="#Cons单元" class="headerlink" title="Cons单元"></a>Cons单元</h4><p>首先，让我解释一下表的元素：<strong>Cons单元（Cons cells）</strong>。Cons单元是一个存放了两个地址的内存空间。Cons单元可用函数<code>cons</code>生成。</p><p>在前端输入<code>(cons 1 2)</code></p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>系统返回<code>(1 . 2)</code>。如图一所示，函数<code>cons</code>给两个地址分配了内存空间，并把存放指向<code>1</code>的地址放在一个空间，把存放指向<code>2</code>的地址放在另一个空间。存放指向<code>1</code>的地址的内存空间被称作<code>car</code>部分，对应的，存放指向<code>2</code>的地址的内存空间被称作<code>cdr</code>部分。<code>car</code>和<code>cdr</code>分别是<strong>寄存器地址部分（Contents of the Address part of the Register）</strong>和<strong>寄存器减量部分（Contents of the Decrement part of the Register）</strong>的简称。这些名字最初来源于Lisp首次被实现所使用的硬件环境中内存空间的名字。这些名字同时也表明Cons单元的本质就是一个内存空间。<code>cons</code>这个名字是术语<strong>构造（construction）</strong>的简称。</p><p><img src="http://deathking.github.io/yast-cn/contents/figures/cons2.png" alt></p><p>Cons单元也可以被串起来。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token number">3</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这种情况的内存空间如图2所示。</p><p><img src="http://deathking.github.io/yast-cn/contents/figures/conss2.png" alt></p><p>Cons单元可以存放不同类型的数据也可以嵌套。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token builtin">cons</span> #\a <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token number">3</span> <span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 17: (#\a 3 . "hello")</span>

<span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token number">0</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 23: ((0 . 1) 2 . 3)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这是因为Scheme可以通过地址操作所有的数据。（<code>#\c</code>代表了一个字符<code>c</code>。例如，<code>#\a</code>就代表字符<code>a</code>）</p><h3 id="表"><a href="#表" class="headerlink" title="表"></a>表</h3><p>表是Cons单元通过用<code>cdr</code>部分连接到下一个<code>Cons</code>单元的开头实现的。表中包含的<code>’()</code>被称作空表。就算数据仅由一个Cons单元组成，只要它的<code>cdr</code>单元是<code>’()</code>，那它就是一个表。图3展示了表<code>(1 2 3)</code>的内存结构。</p><p><img src="http://deathking.github.io/yast-cn/contents/figures/list2.png" alt></p><p>事实上，表可以像下面这样递归地定义：</p><ol><li><code>‘()</code>是一个表</li><li>如果<code>ls</code>是一个表且<code>obj</code>是某种类型的数据，那么<code>(cons obj ls)</code>也是一个表 正因为表是一种被递归定义的数据结构，将它用在递归的函数中显然是合理的。</li></ol><p>###原子</p><p>不使用Cons单元的数据结构称为<strong>原子（atom）</strong>。数字，字符，字符串，向量和空表<code>’()</code>都是原子。<code>’()</code>既是原子，又是表。</p><h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><p>所有的记号都会依据Scheme的求值规则求值：所有记号都会从最内层的括号依次向外层括号求值，且最外层括号返回的值将作为S-表达式的值。一个被称为<strong>引用（quote）</strong>的形式可以用来阻止记号被求值。它是用来将符号或者表原封不动地传递给程序，而不是求值后变成其它的东西。</p><p>例如，<code>(+ 2 3)</code>会被求值为<code>5</code>，然而<code>(quote (+ 2 3))</code>则向程序返回<code>(+ 2 3)</code>本身。因为<code>quote</code>的使用频率很高，他被简写为<code>’</code>。</p><p>比如：</p><ul><li><code>’(+ 2 3)</code>代表列表<code>(+ 2 3)</code>本身；</li><li><code>’+</code>代表符号<code>+</code>本身；</li></ul><p>实际上，<code>’()</code>是对空表的引用，也就是说，尽管解释器返回<code>()</code>代表空表，你也应该用<code>’()</code>来表示空表。</p><h3 id="特殊形式"><a href="#特殊形式" class="headerlink" title="特殊形式"></a>特殊形式</h3><p>Scheme有两种不同类型的操作符：其一是函数。函数会对所有的参数求值并返回值。另一种操作符则是特殊形式。特殊形式不会对所有的参数求值。除了<code>quote</code>，<code>lambda</code>，<code>define</code>，<code>if</code>，<code>set!</code>，等都是特殊形式。</p><h3 id="car函数和cdr函数"><a href="#car函数和cdr函数" class="headerlink" title="car函数和cdr函数"></a>car函数和cdr函数</h3><p>返回一个Cons单元的<code>car</code>部分和<code>cdr</code>部分的函数分别是<code>car</code>和<code>cdr</code>函数。如果<code>cdr</code>部分串连着Cons单元，解释器会打印出整个<code>cdr</code>部分。如果Cons单元的<code>cdr</code>部分不是<code>’()</code>，那么其值稍后亦会被展示。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token builtin">car</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 1</span>

<span class="token punctuation">(</span><span class="token builtin">cdr</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 18: (2 3 4)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="list函数"><a href="#list函数" class="headerlink" title="list函数"></a>list函数</h3><p><code>list</code>函数使得我们可以构建包含数个元素的表。函数<code>list</code>有任意个数的参数，且返回由这些参数构成的表。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: ()</span>

<span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 24: (1)</span>

<span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">3</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 25: ((1 2) (3 4))</span>

<span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 26: (0)</span>

<span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 27: (1 2)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="定义函数"><a href="#定义函数" class="headerlink" title="定义函数"></a>定义函数</h2><p>由于Sheme是函数式编程语言，你需要通过编写小型函数来构造程序。因此，明白如何构造并组合这些函数对掌握Scheme尤为关键。</p><p>你可以使用<code>define</code>来将一个符号与一个值绑定。你可以通过这个操作符定义例如数、字符、表、函数等任何类型的全局参数。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token comment" spellcheck="true">; Hello world as a variable</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> vhello <span class="token string">"Hello world"</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">;1</span>

<span class="token comment" spellcheck="true">; Hello world as a function</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> fhello <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true">;2</span>
         <span class="token string">"Hello world"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>操作符<code>define</code>用于声明变量，它接受两个参数。<code>define</code>运算符会使用第一个参数作为全局参数，并将其与第二个参数绑定起来。因此，代码片段1的第1行中，我们声明了一个全局参数<code>vhello</code>，并将其与<code>&quot;Hello，World&quot;</code>绑定起来。</p><p>紧接着，在第2行声明了一个返回<code>“Hello World”</code>的过程。</p><p>特殊形式<code>lambda</code>用于定义过程。<code>lambda</code>需要至少一个的参数，第一个参数是由定义的过程所需的参数组成的表。因为本例<code>fhello</code>没有参数，所以参数表是空表。</p><p>在解释器中输入<code>vhello</code>，解释器返回“Hello，World”。如果你在解释器中输入<code>fhello</code>，它也会返回像下面这样的值：<code>#[compound-procedure 16 fhello]</code>，这说明了Scheme解释器把过程和常规数据类型用同样的方式对待。正如我们在前面章节中讲解的那样，Scheme解释器通过内存空间中的数据地址操作所有的数据，因此，所有存在于内存空间中的对象都以同样的方式处理。</p><p>如果把<code>fhello</code>当过程对待，你应该用括号括住这些符号，比如<code>(fhello)</code>。</p><p>然后解释器会按照第二章讲述的规则那样对它求值，并返回“Hello World”。</p><h3 id="定义有参数的函数"><a href="#定义有参数的函数" class="headerlink" title="定义有参数的函数"></a>定义有参数的函数</h3><p>可以通过在<code>lambda</code>后放一个参数表来定义有参数的函数。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token comment" spellcheck="true">; hello with name</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> hello
  <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token function">string-append</span> <span class="token string">"Hello "</span> name <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">; sum of three numbers</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> sum3
  <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token function">a</span> b c<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token operator">+</span> a b c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>函数<code>hello</code>有一个参数<code>(name)</code>，并会把<code>“Hello”</code>、<code>name的值</code>、和<code>&quot;!&quot;</code>连结在一起并返回。</p><p>预定义函数<code>string-append</code>可以接受任意多个数的参数，并返回将这些参数连结在一起后的字符串。</p><p><code>sum3</code>：此函数有三个参数并返回这三个参数的和。</p><h3 id="一种函数定义的短形式"><a href="#一种函数定义的短形式" class="headerlink" title="一种函数定义的短形式"></a>一种函数定义的短形式</h3><p>用<code>lambda</code>定义函数是一种规范的方法，但你也可以使用类似于代码片段3中展示的短形式。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token comment" spellcheck="true">; hello with name</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">hello</span> name<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">string-append</span> <span class="token string">"Hello "</span> name <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">; sum of three numbers</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">sum3</span> a b c<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token operator">+</span> a b c<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在这种形式中，函数按照它们被调用的形式被定义。代码片段2和代码片段3都是相同的。有些人不喜欢这种短形式的函数定义，但是在教程中使用这种形式，因为它可以使代码更短小。</p><h2 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>本章会讲解如何通过条件编写过程。这个是编写使用程序很重要的一步。</p><h3 id="if表达式"><a href="#if表达式" class="headerlink" title="if表达式"></a>if表达式</h3><p><code>if</code>表达式将过程分为两个部分。<code>if</code>的格式如下：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">if</span> predicate then_value else_value<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果<code>predicate</code>部分为真，那么<code>then_value</code>部分被求值，否则<code>else_value</code>部分被求值，并且求得的值会返回给<code>if</code>语句的括号外。<code>true</code>是除<code>false</code>以外的任意值，<code>true</code>使用<code>#t</code>表示，<code>false</code>用<code>#f</code>表示。</p><p>在R5RS中，<code>false</code>（<code>#f</code>）和空表<code>（’()）</code>是两个不同的对象。然而，在MIT-Scheme中，这两个为同一对象。这个不同可能是历史遗留问题，在以前的标准——R4RS中，<code>#f</code>和<code>’()</code>被定义为同一对象。</p><p>因此，从兼容性角度考虑，你不应该使用表目录作为谓词。使用函数<code>null?</code>来判断表是否为空。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token builtin">null?</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token builtin">null?</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">a</span> b c<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: ()   ;#f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>函数<code>not</code>可用于对谓词取反。此函数只有一个参数且如果参数值为<code>#f</code>则返回<code>#t</code>，反之，参数值为<code>#t</code>则返回<code>#f</code>。<code>if</code>表达式是一个特殊形式，因为它不对所有的参数求值。因为如果<code>predicate</code>为真，则只有<code>then_value</code>部分被求值。另一方面，如果<code>predicate</code>为假，只有<code>else_value</code>部分被求值。</p><p>例：首项为<code>a0</code>，增长率<code>r</code>，项数为<code>n</code>的几何增长（geometric progression）数列之和</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">sum-gp</span> a0 r n<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token operator">*</span> a0
     <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> r <span class="token number">1</span><span class="token punctuation">)</span>
         n
         <span class="token punctuation">(</span><span class="token operator">/</span> <span class="token punctuation">(</span><span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">(</span><span class="token function">expt</span> r n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span> <span class="token number">1</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">; !!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通常来说，几何增长数列的求和公式如下：</p><pre><code>a0 * (1 - r^n) / (1 - r)                      (r ≠ 1)
a0 * n                                        (r = 1)</code></pre><p>如果<code>if</code>表达式对所有参数求值的话，那么有<code>;!!</code>注释的那行就算在<code>r=1</code>时也会被求值，这将导致产生一个“除数为0”的错误。</p><p>你也可以省去<code>else_value</code>项。这样的话，当<code>predicate</code>为假时，返回值就没有被指定。如果你希望当<code>predicate</code>为假时返回<code>#f</code>，那么就要明确地将它写出来。</p><p><code>then_value</code>和<code>else_value</code>都应该是S-表达式。如果你需要副作用，那么就应该使用<code>begin</code>表达式。我们将在下一章讨论<code>begin</code>表达式。</p><h3 id="and和or"><a href="#and和or" class="headerlink" title="and和or"></a>and和or</h3><p><code>and</code>和<code>or</code>是用于组合条件的两个特殊形式。Scheme中的<code>and</code>和<code>or</code>不同于C语言中的约定。它们不返回一个布尔值（<code>#t</code>或<code>#f</code>），而是返回给定的参数之一。<code>and</code>和<code>or</code>可以使你的代码更加短小。</p><h4 id="and"><a href="#and" class="headerlink" title="and"></a>and</h4><p><code>and</code>具有任意个数的参数，并从左到右对它们求值。如果某一参数为<code>#f</code>，那么它就返回<code>#f</code>，而不对剩余参数求值。反过来说，如果所有的参数都不是<code>#f</code>，那么就返回最后一个参数的值。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">and</span> <span class="token boolean">#f</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: ()</span>

<span class="token punctuation">(</span><span class="token function">and</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 3</span>

<span class="token punctuation">(</span><span class="token function">and</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token boolean">#f</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: ()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="or"><a href="#or" class="headerlink" title="or"></a>or</h4><p><code>or</code>具有可变个数的参数，并从左到右对它们求值。它返回第一个不是值<code>#f</code>的参数，而余下的参数不会被求值。如果所有的参数的值都是<code>#f</code>的话，则返回最后一个参数的值。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">or</span> <span class="token boolean">#f</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 0</span>

<span class="token punctuation">(</span><span class="token function">or</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 1</span>

<span class="token punctuation">(</span><span class="token function">or</span> <span class="token boolean">#f</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 1</span>

<span class="token punctuation">(</span><span class="token function">or</span> <span class="token boolean">#f</span> <span class="token boolean">#f</span> <span class="token boolean">#f</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: ()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="cond表达式"><a href="#cond表达式" class="headerlink" title="cond表达式"></a>cond表达式</h3><p>尽管所有的分支都可以用<code>if</code>表达式表达，但当条件有更多的可能性时，你就需要使用嵌套的<code>if</code>表达式了，这将使代码变得复杂。处理这种情况可以使用<code>cond</code>表达式。<code>cond</code>表达式的格式如下：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">cond</span>
  <span class="token punctuation">(</span><span class="token function">predicate_1</span> clauses_1<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">predicate_2</span> clauses_2<span class="token punctuation">)</span>
    ......
  <span class="token punctuation">(</span><span class="token function">predicate_n</span> clauses_n<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">else</span>        clauses_else<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在<code>cond</code>表达式中，<code>predicates_i</code>是按照从上到下的顺序求值，而当<code>predicates_i</code>为真时，<code>clause_i</code>会被求值并返回。<code>i</code>之后的<code>predicates</code>和<code>clauses</code>不会被求值。如果所有的<code>predicates_i</code>都是假的话，则返回<code>cluase_else</code>。在一个子句中，你可以写数条S-表达式，而<code>clause</code>的值是最后一条S-表达式。</p><blockquote><p>例：城市游泳池的收费。</p><p>Foo市的城市游泳池按照顾客的年龄收费：</p><p>如果 age ≤ 3 或者 age ≥ 65 则 免费；<br>如果 介于 4 ≤ age ≤ 6 则 0.5美元；<br>如果 介于 7 ≤ age ≤ 12 则 1.0美元；<br>如果 介于 13 ≤ age ≤ 15 则 1.5美元；<br>如果 介于 16 ≤ age ≤ 18 则 1.8美元；<br>其它 则 2.0美元；</p><p>那么，一个返回城市游泳池收费的函数如下：</p></blockquote><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">fee</span> age<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">cond</span>
   <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">or</span> <span class="token punctuation">(</span><span class="token operator">&lt;=</span> age <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">>=</span> age <span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;=</span> <span class="token number">4</span> age <span class="token number">6</span><span class="token punctuation">)</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;=</span> <span class="token number">7</span> age <span class="token number">12</span><span class="token punctuation">)</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;=</span> <span class="token number">13</span> age <span class="token number">15</span><span class="token punctuation">)</span> <span class="token number">1.5</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;=</span> <span class="token number">16</span> age <span class="token number">18</span><span class="token punctuation">)</span> <span class="token number">1.8</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token keyword">else</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="做出判断的函数"><a href="#做出判断的函数" class="headerlink" title="做出判断的函数"></a>做出判断的函数</h3><p>将介绍一些用于做判断的函数。这些函数的名字都以<code>&#39;?&#39;</code>结尾。</p><h3 id="eq-、eqv-和equal"><a href="#eq-、eqv-和equal" class="headerlink" title="eq?、eqv?和equal?"></a>eq?、eqv?和equal?</h3><p>基本函数<code>eq?</code>、<code>eqv?</code>、<code>equal?</code>具有两个参数，用于检查这两个参数是否“一致”。这三个函数之间略微有些区别。</p><blockquote><p><code>eq?</code><br>该函数比较两个对象的地址，如果相同的话就返回<code>#t</code>。例如，<code>(eq? str str)</code>返回<code>#t</code>，因为<code>str</code>本身的地址是一致的。与此相对的，因为字符串<code>”hello”</code>和<code>”hello”</code>被储存在了不同的地址中，函数将返回<code>#f</code>。不要使用<code>eq?</code>来比较数字，因为不仅在R5RS中，甚至在MIT-Scheme实现中，它都没有指定返回值。使用<code>eqv?</code>或者<code>=</code>替代。</p></blockquote><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> str <span class="token string">"hello"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: str</span>

<span class="token punctuation">(</span><span class="token function">eq?</span> str str<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token function">eq?</span> <span class="token string">"hello"</span> <span class="token string">"hello"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: ()             ← It should be #f in R5RS </span>

<span class="token comment" spellcheck="true">;;; comparing numbers depends on implementations</span>
<span class="token punctuation">(</span><span class="token function">eq?</span> <span class="token number">1</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token function">eq?</span> <span class="token number">1.0</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: ()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>eqv?</code><br>该函数比较两个存储在内存中的对象的类型和值。如果类型和值都一致的话就返回<code>#t</code>。对于过程（<code>lambda</code>表达式）的比较依赖于具体的实现。这个函数不能用于类似于表和字符串一类的序列比较，因为尽管这些序列看起来是一致的，但它们的值是存储在不同的地址中。</p></blockquote><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">eqv?</span> <span class="token number">1.0</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token function">eqv?</span> <span class="token number">1</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: ()</span>

<span class="token comment" spellcheck="true">;;; don't use it to compare sequences</span>
<span class="token punctuation">(</span><span class="token function">eqv?</span> <span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: ()</span>

<span class="token punctuation">(</span><span class="token function">eqv?</span> <span class="token string">"hello"</span> <span class="token string">"hello"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: ()</span>

<span class="token comment" spellcheck="true">;;; the following depends on implementations</span>
<span class="token punctuation">(</span><span class="token function">eqv?</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: ()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>equal?</code><br>该函数用于比较类似于表或者字符串一类的序列。</p></blockquote><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">equal?</span> <span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token function">equal?</span> <span class="token string">"hello"</span> <span class="token string">"hello"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="用于检查数据类型的函数"><a href="#用于检查数据类型的函数" class="headerlink" title="用于检查数据类型的函数"></a>用于检查数据类型的函数</h3><p>下面列举了几个用于检查类型的函数。这些函数都只有一个参数。</p><ul><li><code>pair?</code> 如果对象为序对则返回<code>#t</code>；</li><li><code>list?</code> 如果对象是一个表则返回<code>#t</code>。要小心的是空表<code>’()</code>是一个表但是不是一个序对。</li><li><code>null?</code> 如果对象是空表’()的话就返回#t。</li><li><code>symbol?</code> 如果对象是一个符号则返回#t。</li><li><code>char?</code> 如果对象是一个字符则返回#t。</li><li><code>string?</code> 如果对象是一个字符串则返回#t。</li><li><code>number?</code> 如果对象是一个数字则返回#t。</li><li><code>complex?</code> 如果对象是一个复数则返回#t。</li><li><code>real?</code> 如果对象是一个实数则返回#t。</li><li><code>rational?</code> 如果对象是一个有理数则返回#t。</li><li><code>integer?</code> 如果对象是一个整数则返回#t。</li><li><code>exact?</code> 如果对象不是一个浮点数的话则返回#t。</li><li><code>inexact?</code> 如果对象是一个浮点数的话则返回#t。</li></ul><h3 id="用于比较数的函数"><a href="#用于比较数的函数" class="headerlink" title="用于比较数的函数"></a>用于比较数的函数</h3><blockquote><p><code>=</code>、<code>&gt;</code>、<code>&lt;</code>、<code>&lt;=</code>、<code>&gt;=</code><br>这些函数都有任意个数的参数。如果参数是按照这些函数的名字排序的话，函数就返回<code>#t</code>。</p></blockquote><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token operator">=</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>
<span class="token punctuation">(</span><span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>
<span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token operator">=</span> <span class="token number">2</span> <span class="token number">2</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">3.1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token operator">></span> <span class="token number">4</span> <span class="token number">1</span> <span class="token number">-0.2</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1.1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token operator">>=</span> <span class="token number">2</span> <span class="token number">1</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">3.9</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: ()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>odd?</code>、<code>even?</code>、<code>positive?</code>、<code>negative?</code>、<code>zero?</code><br>这些函数仅有一个参数，如果这些参数满足函数名所指示的条件话就返回<code>#t</code>。</p></blockquote><h3 id="用于比较符号的函数"><a href="#用于比较符号的函数" class="headerlink" title="用于比较符号的函数"></a>用于比较符号的函数</h3><p>在比较字符的时候可以使用<code>char=?</code>、<code>char&lt;?</code>、<code>char&gt;?</code>、<code>char&lt;=?</code>以及<code>char&gt;=?</code>函数。具体的细节请参见R5RS。</p><h3 id="用于比较字符串的函数"><a href="#用于比较字符串的函数" class="headerlink" title="用于比较字符串的函数"></a>用于比较字符串的函数</h3><p>比较字符串时，可以使用<code>string=?</code>和<code>string-ci=?</code>等函数。具体细节请参见R5RS。</p><h2 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h2><h3 id="let表达式"><a href="#let表达式" class="headerlink" title="let表达式"></a>let表达式</h3><p>使用<code>let</code>表达式可以定义局部变量。格式如下：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">let</span> binds body<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>变量在<code>binds</code>定义的形式中被声明并初始化。<code>body</code>由任意多个S-表达式构成。<code>binds</code>的格式如下：</p><pre><code>[binds] → ((p1 v1) (p2 v2) ...)</code></pre><p>声明了变量<code>p1</code>、<code>p2</code>，并分别为它们赋初值<code>v1</code>、<code>v2</code>。变量的<strong>作用域（Scope）</strong>为<code>body</code>体，也就是说变量只在<code>body</code>中有效。</p><blockquote><p>例1：声明局部变量<code>i</code>和<code>j</code>，将它们与<code>1</code>、<code>2</code>绑定，然后求二者的和。</p></blockquote><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">j</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token operator">+</span> i j<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><code>let</code>表达式可以嵌套使用。</p><blockquote><p>例2：声明局部变量<code>i</code>和<code>j</code>，并将分别将它们与<code>1</code>和<code>i+2</code>绑定，然后求它们的乘积。</p></blockquote><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">j</span> <span class="token punctuation">(</span><span class="token operator">+</span> i <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token operator">*</span> i j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>由于变量的作用域仅在<code>body</code>中，下列代码会产生错误，因为在变量<code>j</code>的作用域中没有变量<code>i</code>的定义。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">j</span> <span class="token punctuation">(</span><span class="token operator">+</span> i <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token operator">*</span> i j<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Error</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><code>let*</code>表达式可以用于引用定义在同一个绑定中的变量。实际上，<code>let*</code>只是嵌套的<code>let</code>表达式的语法糖而已。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">let*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">j</span> <span class="token punctuation">(</span><span class="token operator">+</span> i <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token operator">*</span> i j<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>例3：函数<code>quadric-equation</code>用于计算二次方程。它需要三个代表系数的参数：<code>a</code>、<code>b</code>、<code>c</code> （<code>ax^2 + bx + c = 0</code>），返回一个存放答案的实数表。通过逐步地使用<code>let</code>表达式，可以避免不必要的计算。</p></blockquote><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token comment" spellcheck="true">;;;The scopes of variables d,e, and f are the regions with the same background colors.</span>

<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">quadric-equation</span> a b c<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">zero?</span> a<span class="token punctuation">)</span>      
      <span class="token string">'error</span>                                      <span class="token comment" spellcheck="true">; 1</span>
      <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">d</span> <span class="token punctuation">(</span><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token operator">*</span> b b<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span> <span class="token number">4</span> a c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">; 2</span>
        <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">negative?</span> d<span class="token punctuation">)</span>
            <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                      <span class="token comment" spellcheck="true">; 3</span>
            <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">e</span> <span class="token punctuation">(</span><span class="token operator">/</span> b a <span class="token number">-2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token comment" spellcheck="true">; 4</span>
              <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">zero?</span> d<span class="token punctuation">)</span>
              <span class="token punctuation">(</span><span class="token builtin">list</span> e<span class="token punctuation">)</span>
              <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">f</span> <span class="token punctuation">(</span><span class="token operator">/</span> <span class="token punctuation">(</span><span class="token function">sqrt</span> d<span class="token punctuation">)</span> a <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">; 5</span>
                <span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token punctuation">(</span><span class="token operator">+</span> e f<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span> e f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">quadric-equation</span> <span class="token number">3</span> <span class="token number">5</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">; solution of 3x^2+5x+2=0</span>
<span class="token comment" spellcheck="true">;Value 12: (-2/3 -1)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>实际上，<code>let</code>表达式只是<code>lambda</code>表达式的一个语法糖：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">p1</span> v1<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">p2</span> v2<span class="token punctuation">)</span> ...<span class="token punctuation">)</span> exp1 exp2 ...<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;⇒</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token function">p1</span> p2 ...<span class="token punctuation">)</span>
    exp1 exp2 ...<span class="token punctuation">)</span> v1 v2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这是因为<code>lambda</code>表达式用于定义函数，它为变量建立了一个作用域。也就是闭包的概念</p><h2 id="重复"><a href="#重复" class="headerlink" title="重复"></a>重复</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p>Scheme中通常通过递归实现重复，而不是循环。</p><h3 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h3><p>在自己的定义中调用自己的函数叫做<strong>递归函数（Recursive Function）</strong>。虽然这听起来很奇怪，但是循环的常见方法。如果你把函数类比为机器的话，递归似乎毫无道理。然而，正因为函数是过程，函数调用自己是有意义的。比如说，让我们来考察一下文献调研吧。你可能需要去阅读你正在阅读的文献所引用的文献（cited-1）。进一步，你可能还需要去阅读文件（cite-1）所引用的其它文献。这样，文献调研就是一个递归的过程，你也可以重复这个调研过程直到满足了特定条件（比如说，你累了）。这样，将程序设计语言中的函数类比为人类活动（比如文献调研）将有助于理解递归函数。</p><p>我们通常使用计算阶乘来解释递归。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">fact</span> n<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> n <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token number">1</span>
      <span class="token punctuation">(</span><span class="token operator">*</span> n <span class="token punctuation">(</span><span class="token function">fact</span> <span class="token punctuation">(</span><span class="token operator">-</span> n <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>(fact 5)</code>的计算过程如下：</p><pre><code>(fact 5)
⇒ 5 * (fact 4)
⇒ 5 * 4 * (fact 3)
⇒ 5 * 4 * 3 * (fact 2)
⇒ 5 * 4 * 3 * 2 * (fact 1)
⇒ 5 * 4 * 3 * 2 * 1
⇒ 5 * 4 * 3 * 2
⇒ 5 * 4 * 6
⇒ 5 * 24
⇒ 120</code></pre><p><code>(fact 5)</code>调用<code>(fact 4)</code>，<code>(fact 4)</code>调用<code>(fact 3)</code>，最后<code>(fact 1)</code>被调用。<code>(fact 5)</code>，<code>(fact 4)</code>……以及<code>(fact 1)</code>都被分配了不同的存储空间，直到<code>(fact (- i 1))</code>返回一个值之前，<code>(fact i)</code>都会保留在内存中，由于存在函数调用的开销，这通常会占用更多地内存空间和计算时间。</p><p>然而，递归函数可以以一种简单的方式表达重复。表是被递归定义的，进而表和递归函数可以很好地配合。例如，一个让表中所有元素翻倍的函数可以像下面这样写。如果参数是空表，那么函数应该停止计算并返回一个空表。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token builtin">list</span>*2 ls<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">null?</span> ls<span class="token punctuation">)</span>
      <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token punctuation">(</span><span class="token operator">*</span> <span class="token number">2</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token punctuation">(</span><span class="token builtin">list</span>*2 <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="尾递归"><a href="#尾递归" class="headerlink" title="尾递归"></a>尾递归</h3><p>普通的递归调用并不高效因为它既浪费存储空间又具有函数调用开销。与之相反，尾递归函数包含了计算结果，当计算结束时直接将其返回。特别地，由于Scheme规范要求尾递归调用转化为循环，因此尾递归调用就不存在函数调用开销。</p><p>[代码片段2]展示了[代码片段1]中函数<code>fact</code>的尾递归版本。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">fact-tail</span> n<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">fact-rec</span> n n<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">fact-rec</span> n p<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> n <span class="token number">1</span><span class="token punctuation">)</span>
      p
      <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">m</span> <span class="token punctuation">(</span><span class="token operator">-</span> n <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token function">fact-rec</span> m <span class="token punctuation">(</span><span class="token operator">*</span> p m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>fact-tail</code>计算阶乘的过程像这样：</p><pre><code>(fact-tail 5)
⇒ (fact-rec 5 5)
⇒ (fact-rec 4 20)
⇒ (fact-rec 3 60)
⇒ (fact-rec 2 120)
⇒ (fact-rec 1 120)
⇒ 120</code></pre><p>因为<code>fact-rec</code>并不等待其它函数的计算结果，因此当它计算结束时即从内存中释放。计算通过修改<code>fact-rec</code>的参数来演进，这基本上等同于循环。如上文所述，Scheme将尾递归转化为循环，Scheme就无需提供循环的语法来实现重复。</p><h3 id="命名let"><a href="#命名let" class="headerlink" title="命名let"></a>命名let</h3><p>命名<code>let</code>（<strong>named let</strong>）可以用来表达循环。[代码片段3]中的函数<code>fact-let</code>展示了如何使用命名<code>let</code>来计算阶乘。<code>fact-let</code>函数使用了一个<strong>命名<code>let</code>表达式</strong><code>(loop)</code>，这与在[代码片段2]中展示的<code>fact-rec</code>函数是不同的。在被注释为<code>;1</code>的那行，代码将参数<code>n1</code>和<code>p</code>都初始化为<code>n</code>。再每次循环后，参数在被注释为<code>;2</code>的那行更新：将<code>n1</code>减1，而将<code>p</code>乘以<code>(n1 - 1)</code>。</p><p>在Scheme中，用命名<code>let</code>来表达循环是俗成的方法。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">fact-let</span> n<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> loop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">n1</span> n<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">p</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>           <span class="token comment" spellcheck="true">; 1</span>
    <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> n1 <span class="token number">1</span><span class="token punctuation">)</span>                    
    p
    <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">m</span> <span class="token punctuation">(</span><span class="token operator">-</span> n1 <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token function">loop</span> m <span class="token punctuation">(</span><span class="token operator">*</span> p m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">; 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="letrec"><a href="#letrec" class="headerlink" title="letrec"></a>letrec</h3><p><code>letrec</code>类似于<code>let</code>，但它允许一个名字递归地调用它自己。语法<code>letrec</code>通常用于定义复杂的递归函数。[代码片段4]展示了<code>fact</code>函数的<code>letrec</code>版本。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">fact-letrec</span> n<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">letrec</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">iter</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token function">n1</span> p<span class="token punctuation">)</span>
           <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> n1 <span class="token number">1</span><span class="token punctuation">)</span>
               p
               <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">m</span> <span class="token punctuation">(</span><span class="token operator">-</span> n1 <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token punctuation">(</span><span class="token function">iter</span> m <span class="token punctuation">(</span><span class="token operator">*</span> p m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">; *</span>
    <span class="token punctuation">(</span><span class="token function">iter</span> n n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>正如被注释为<code>;*</code>的那行代码所示，局部变量<code>iter</code>可以在它的定义里面引用它自己。语法<code>letrec</code>是定义局部变量的俗成方式。</p><h3 id="do表达式"><a href="#do表达式" class="headerlink" title="do表达式"></a>do表达式</h3><p>虽然并不常见，但语法<code>do</code>也可用于表达重复。它的格式如下：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">do</span> binds <span class="token punctuation">(</span><span class="token function">predicate</span> value<span class="token punctuation">)</span>
    body<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>变量在<code>binds</code>部分被绑定，而如果<code>predicate</code>被求值为真，则函数从循环中<strong>逃逸（escape）</strong>出来，并返回值<code>value</code>，否则循环继续进行。</p><p><code>binds</code>部分的格式如下所示：</p><pre><code>[binds] → ((p1 i1 u1) (p2 i2 u2) ... )</code></pre><p>变量<code>p1</code>，<code>p2</code>，…被分别初始化为<code>i1</code>，<code>i2</code>，…并在循环后分别被更新为<code>u1</code>，<code>u2</code>，…。</p><p>[代码片段5]演示了<code>fact</code>的<code>do</code>表达式版本。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">fact-do</span> n<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">do</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">n1</span> n <span class="token punctuation">(</span><span class="token operator">-</span> n1 <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">p</span> n <span class="token punctuation">(</span><span class="token operator">*</span> p <span class="token punctuation">(</span><span class="token operator">-</span> n1 <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">=</span> n1 <span class="token number">1</span><span class="token punctuation">)</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>变量<code>n1</code>和<code>p</code>分别被初始化为<code>n</code>和<code>n</code>，在每次循环后分别被减去1和乘以<code>(n1 - 1)</code>。当<code>n1</code>变为<code>1</code>时，函数返回<code>p</code>。</p><h2 id="高阶函数"><a href="#高阶函数" class="headerlink" title="高阶函数"></a>高阶函数</h2><h3 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h3><p><strong>高阶函数（Higher Order Function）</strong>是一种以函数为参数的函数。它们都被用于<strong>映射（mapping）</strong>、<strong>过滤（filtering）</strong>、<strong>归档（folding）</strong>和<strong>排序（sorting）</strong>表。高阶函数提高了程序的模块性。编写对各种情况都适用的高阶函数与为单一情况编写递归函数相比，可以使程序更具可读性。比如说，使用一个高阶函数来实现排序可以使得我们使用不同的条件来排序，这就将排序条件和排序过程清楚地划分开来。函数<code>sort</code>具有两个参数，其一是一个待排序的表，其二是<strong>定序（Ordering）</strong>函数。下面展示了按照大小将一个整数表正序排序。<code>&lt;</code>函数就是（本例中的）两数的定序函数。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">sort</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">7883</span> <span class="token number">9099</span> <span class="token number">6729</span> <span class="token number">2828</span> <span class="token number">7754</span> <span class="token number">4179</span> <span class="token number">5340</span> <span class="token number">2644</span> <span class="token number">2958</span> <span class="token number">2239</span><span class="token punctuation">)</span> &lt;<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;⇒  (2239 2644 2828 2958 4179 5340 6729 7754 7883 9099)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>另一方面，按照每个数末两位的大小排序可以按下面的方式实现：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">sort</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">7883</span> <span class="token number">9099</span> <span class="token number">6729</span> <span class="token number">2828</span> <span class="token number">7754</span> <span class="token number">4179</span> <span class="token number">5340</span> <span class="token number">2644</span> <span class="token number">2958</span> <span class="token number">2239</span><span class="token punctuation">)</span> 
      <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token function">x</span> y<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token function">modulo</span> x <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">modulo</span> y <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;⇒  (2828 6729 2239 5340 2644 7754 2958 4179 7883 9099)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>正如这里所演示的，像<strong>快速排序（Quick Sort）</strong>、<strong>归并排序（Merge Sort）</strong>等排序过程，将定序函数完全分离开来提高了代码的复用性。</p><p>在本节中，将讲解预定义的高阶函数，然后介绍如何定义高阶函数。由于Scheme并不区别过程和其它的数据结构，因此你可以通过将函数当作参数传递轻松的定义自己的高阶函数。</p><p>实际上，Scheme中预定义函数的本质就是高阶函数，因为Scheme并没有定义块结构的语法，因此使用<code>lambda</code>表达式作为一个块。</p><h3 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h3><p>映射是将同样的行为应用于表所有元素的过程。R5RS定义了两个映射过程：其一为返回转化后的表的<code>map</code>过程，另一为注重副作用的<code>for-each</code>过程。</p><h4 id="map"><a href="#map" class="headerlink" title="map"></a>map</h4><p><code>map</code>过程的格式如下：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">map</span> procedure list1 list2 ...<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>procedure</code>是个与某个过程或<code>lambda</code>表达式相绑定的符号。作为参数的表的个数视<code>procedure</code>需要的参数而定。</p><p>例：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token comment" spellcheck="true">; Adding each item of '(1 2 3) and '(4 5 6).</span>
<span class="token punctuation">(</span><span class="token function">map</span> + <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">4</span> <span class="token number">5</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;⇒  (5 7 9)</span>

<span class="token comment" spellcheck="true">; Squaring each item of '(1 2 3)</span>
<span class="token punctuation">(</span><span class="token function">map</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span> x x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;⇒  (1 4 9)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="for-each"><a href="#for-each" class="headerlink" title="for-each"></a>for-each</h3><p><code>for-each</code>的格式与<code>map</code>一致。但<code>for-each</code>并不返回一个具体的值，只是用于副作用。</p><p>例：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> sum <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">for-each</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">set!</span> sum <span class="token punctuation">(</span><span class="token operator">+</span> sum x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sum
<span class="token comment" spellcheck="true">;⇒  10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h3><p>尽管过滤函数并没有在R5RS中定义，但MIT-Scheme实现提供了<code>keep-matching-items</code>和<code>delete-matching-item</code>两个函数。其它实现中应该有类似的函数。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">keep-matching-items</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span> <span class="token number">-3</span> <span class="token number">-4</span> <span class="token number">5</span><span class="token punctuation">)</span> positive?<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;⇒  (1 2 5)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="归档"><a href="#归档" class="headerlink" title="归档"></a>归档</h3><p>尽管在R5RS中没有定义归档函数，但MIT-Scheme提供了<code>reduce</code>等函数。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">reduce</span> + <span class="token number">0</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                 <span class="token comment" spellcheck="true">;⇒  10</span>
<span class="token punctuation">(</span><span class="token function">reduce</span> + <span class="token number">0</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                     <span class="token comment" spellcheck="true">;⇒  3</span>
<span class="token punctuation">(</span><span class="token function">reduce</span> + <span class="token number">0</span> <span class="token string">'</span><span class="token punctuation">(</span>1<span class="token punctuation">)</span><span class="token punctuation">)</span>                       <span class="token comment" spellcheck="true">;⇒  1</span>
<span class="token punctuation">(</span><span class="token function">reduce</span> + <span class="token number">0</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token comment" spellcheck="true">;⇒  0</span>
<span class="token punctuation">(</span><span class="token function">reduce</span> + <span class="token number">0</span> <span class="token string">'</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span>                     <span class="token comment" spellcheck="true">;⇒  foo</span>
<span class="token punctuation">(</span><span class="token function">reduce</span> list <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">;⇒  (((1 2) 3) 4)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p>尽管R5RS中没有定义排序函数，但MIT-Scheme提供了<code>sort</code>（实为<code>merge-sort</code>实现）和<code>quick-sort</code>函数。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">sort</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">3</span> <span class="token number">5</span> <span class="token number">1</span> <span class="token number">4</span> <span class="token number">-1</span><span class="token punctuation">)</span> &lt;<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;⇒  (-1 1 3 4 5)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="apply函数"><a href="#apply函数" class="headerlink" title="apply函数"></a>apply函数</h3><p><code>apply</code>函数是将一个过程应用于一个表（译注：将表展开，作为过程的参数）。此函数具有任意多个参数，但首参数和末参数分别应该是一个过程和一个表。虽然乍看之下不然，但这个函数的确非常方便。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token builtin">apply</span> max <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">3</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">;⇒   3</span>
<span class="token punctuation">(</span><span class="token builtin">apply</span> + <span class="token number">1</span> <span class="token number">2</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">3</span> <span class="token number">4</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">;⇒  15</span>
<span class="token punctuation">(</span><span class="token builtin">apply</span> - <span class="token number">100</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">5</span> <span class="token number">12</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">;⇒  66</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="编写高阶函数"><a href="#编写高阶函数" class="headerlink" title="编写高阶函数"></a>编写高阶函数</h3><p>自己编写高阶函数非常容易。这里用<code>member-if</code>、<code>member</code>演示。</p><h3 id="member-if和member"><a href="#member-if和member" class="headerlink" title="member-if和member"></a>member-if和member</h3><p><code>member-if</code>函数使用一个谓词和一个表作为参数，返回一个子表，该子表的<code>car</code>部分即是原列表中首个满足该谓词的元素。<code>member-if</code>函数可以像下面这样定义：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">member-if</span> proc ls<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">cond</span>
   <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">null?</span> ls<span class="token punctuation">)</span> <span class="token boolean">#f</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">proc</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span> ls<span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token function">member-if</span> proc <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">member-if</span> positive? <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">0</span> <span class="token number">-1</span> <span class="token number">-2</span> <span class="token number">3</span> <span class="token number">5</span> <span class="token number">-7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;⇒  (3 5 -7)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来，<code>member</code>函数检查特定元素是否在表中，该函数编写如下。函数需要三个参数，其一为用于比较的函数，其二为特定项，其三为待查找表。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">member</span> proc obj ls<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">cond</span>
   <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">null?</span> ls<span class="token punctuation">)</span> <span class="token boolean">#f</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">proc</span> obj <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span> ls<span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token function">member</span> proc obj <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">member</span> string=? <span class="token string">"hello"</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token string">"hi"</span> <span class="token string">"guys"</span> <span class="token string">"bye"</span> <span class="token string">"hello"</span> <span class="token string">"see you"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;⇒  ("hello" "see you")</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="输入-输出"><a href="#输入-输出" class="headerlink" title="输入/输出"></a>输入/输出</h2><h3 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h3><p>通过前面章节的学习，你已经可以在Scheme的交互式前端中编写并执行程序了。在本章中，我讲介绍如何输入和输出。使用这个特性，你可以从文件中读取数据或向文件中写入数据。</p><h2 id="从文件输入"><a href="#从文件输入" class="headerlink" title="从文件输入"></a>从文件输入</h2><h3 id="open-input-file，read-char和eof-object"><a href="#open-input-file，read-char和eof-object" class="headerlink" title="open-input-file，read-char和eof-object?"></a>open-input-file，read-char和eof-object?</h3><p>函数<code>(open-input-file filename)</code>可以用于打开一个文件。此函数返回一个用于输入的端口。函数<code>(read-char port)</code>用于从端口中读取一个字符。当读取到<strong>文件结尾（EOF）</strong>时，此函数返回<code>eof-object</code>，你可以使用<code>eof-object?</code>来检查。函数<code>(close-input-port port)</code>用于关闭输入端口。[代码片段1]展示了一个函数，该函数以字符串形式返回了文件内容。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">read-file</span> file-name<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">p</span> <span class="token punctuation">(</span><span class="token function">open-input-file</span> file-name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">let</span> loop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ls1</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">c</span> <span class="token punctuation">(</span><span class="token function">read-char</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">eof-object?</span> c<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">begin</span>
        <span class="token punctuation">(</span><span class="token function">close-input-port</span> p<span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token builtin">list</span>->string <span class="token punctuation">(</span><span class="token function">reverse</span> ls1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> c ls1<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">read-char</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>比如，在[范例1]中展示的结果就是将[代码片段1]应用于文件hello.txt。由于换行符是由<code>&#39;\n&#39;</code>表示的，这就很容易阅读。然而，像格式化输出[范例2]，我们也可使用<code>display</code>函数。</p><pre><code>Hello world!
Scheme is an elegant programming language.</code></pre><h3 id="语法call-with-input-file和with-input-from-file"><a href="#语法call-with-input-file和with-input-from-file" class="headerlink" title="语法call-with-input-file和with-input-from-file"></a>语法call-with-input-file和with-input-from-file</h3><p>你通过使用语法<code>call-with-input-file</code>和<code>with-input-from-file</code>来打开文件以供读取输入。这些语法是非常方便的，因为它们要处理错误。</p><blockquote><pre><code>(call-with-input-file filename procedure)</code></pre><p>该函数将名为<code>filename</code>的文件打开以供读取输入。函数<code>procedure</code>接受一个输入端口作为参数。文件有可能再次使用，因此当<code>procedure</code>结束时文件不会自动关闭，文件应该显式地关闭。[代码片段1]可以按照[代码片段2]那样用<code>call-with-input-file</code>编写。</p></blockquote><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">read-file</span> file-name<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">call-with-input-file</span> file-name
    <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">let</span> loop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ls1</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">c</span> <span class="token punctuation">(</span><span class="token function">read-char</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">eof-object?</span> c<span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">begin</span>
          <span class="token punctuation">(</span><span class="token function">close-input-port</span> p<span class="token punctuation">)</span>
          <span class="token punctuation">(</span><span class="token builtin">list</span>->string <span class="token punctuation">(</span><span class="token function">reverse</span> ls1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> c ls1<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">read-char</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>(with-input-from-file filename procedure)</code> 该函数将名为<code>filename</code>的文件作为标准输入打开。函数<code>procedure</code>不接受任何参数。当<code>procedure</code>退出时，文件自动被关闭。[代码片段3]展示了如何用<code>with-input-from-file</code>来重写[代码片段1]。</p></blockquote><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">read-file</span> file-name<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">with-input-from-file</span> file-name
    <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">let</span> loop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ls1</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">c</span> <span class="token punctuation">(</span>read-char<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">eof-object?</span> c<span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token builtin">list</span>->string <span class="token punctuation">(</span><span class="token function">reverse</span> ls1<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> c ls1<span class="token punctuation">)</span> <span class="token punctuation">(</span>read-char<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><p>函数<code>(read port)</code>从端口<code>port</code>中读入一个S-表达式。用它来读诸如”paren.txt”中带括号的内容就很方便。</p><pre><code>&#39;(Hello world!
Scheme is an elegant programming language.)

&#39;(Lisp is a programming language ready to evolve.)
(define (s-read file-name)
  (with-input-from-file file-name
    (lambda ()
      (let loop ((ls1 &#39;()) (s (read)))
    (if (eof-object? s)
        (reverse ls1)
        (loop (cons s ls1) (read)))))))</code></pre><p>下面展示了用<code>s-read</code>读取”paren.txt”的结果。</p><pre><code>(s-read &quot;paren.txt&quot;)
⇒ ((quote (hello world! scheme is an elegant programming language.))
(quote (lisp is a programming language ready to evolve.)))</code></pre><h3 id="输出至文件"><a href="#输出至文件" class="headerlink" title="输出至文件"></a>输出至文件</h3><h4 id="打开一个用于输出的port"><a href="#打开一个用于输出的port" class="headerlink" title="打开一个用于输出的port"></a>打开一个用于输出的port</h4><p>输出有和输入类似的函数，比如：</p><p><strong>(open-output-file filename)</strong></p><p>该函数打开一个文件用作输出，放回该输出端口。</p><p><strong>(close-output-port port)</strong></p><p>关闭用于输出的端口。</p><p><strong>(call-with-output-file filename procedure)</strong></p><p>打开文件<code>filename</code>用于输出，并调用过程<code>procedure</code>。该函数以输出端口为参数。</p><p><strong>(with-output-to-file filename procedure)</strong></p><p>打开文件<code>filename</code>作为标准输出，并调用过程<code>procedure</code>。该过程没有参数。当控制权从过程<code>procedure</code>中返回时，文件被关闭。</p><h3 id="用于输出的函数"><a href="#用于输出的函数" class="headerlink" title="用于输出的函数"></a>用于输出的函数</h3><p>下面的函数可用于输出。如果参数<code>port</code>被省略的话，则输出至标准输出。</p><p><strong>(write obj port)</strong></p><p>该函数将<code>obj</code>输出至<code>port</code>。字符串被双引号括起而字符具有前缀<code>#\</code>。</p><p><strong>(display obj port)</strong></p><p>该函数将<code>obj</code>输出至<code>port</code>。字符串<em>不被</em>双引号括起而字符<em>不</em>具有前缀<code>#\</code>。</p><p><strong>(newline port)</strong></p><p>向 <code>port</code> 输出一个换行符。</p><p><strong>(write-char char port)</strong></p><p>该函数向<code>port</code>写入一个字符。</p><h2 id="赋值"><a href="#赋值" class="headerlink" title="赋值"></a>赋值</h2><h3 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h3><p>因为Scheme是函数式语言，通常来说，你可以编写不使用赋值的语句。然而，如果使用赋值的话，有些算法就可以轻易实现了。尤其是内部状态和<strong>继续（continuations ）</strong>需要赋值。</p><p>尽管赋值非常习见并且易于理解，但它有一些本质上的缺陷。参见《计算机程序的构造和解释》的第三章第一节“赋值和局部状态”以及《为什么函数式编程如此重要》。</p><p>R5RS中规定的用于赋值的特殊形式是<code>set!</code>、<code>set-car!</code>、<code>set-cdr!</code>、<code>string-set!</code>、<code>vector-set!</code>等。除此之外，有些实现也依赖于赋值。由于赋值改变了参数的值，因此它具有<strong>破坏性（destructive）</strong>。Scheme中，具有破坏性的方法都以<code>!</code>结尾，以警示程序员。</p><h3 id="set"><a href="#set" class="headerlink" title="set!"></a>set!</h3><p><code>set!</code>可以为一个参数赋值。与Common Lisp不同，<code>set!</code>无法给一个S-表达式赋值。</p><p>赋值前参数应被定义。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> var <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">set!</span> var <span class="token punctuation">(</span><span class="token operator">*</span> var <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
var ⇒ <span class="token number">10</span>

<span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">set!</span> i <span class="token punctuation">(</span><span class="token operator">+</span> i <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    i<span class="token punctuation">)</span>
⇒ <span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="赋值和内部状态"><a href="#赋值和内部状态" class="headerlink" title="赋值和内部状态"></a>赋值和内部状态</h3><h4 id="静态作用域（词法闭包）"><a href="#静态作用域（词法闭包）" class="headerlink" title="静态作用域（词法闭包）"></a>静态作用域（词法闭包）</h4><p>Scheme中变量的作用域被限定在了源码中定义其的那个括号里。作用域与源代码书写方式一致的作用域称为<strong>“词法闭包（Lexical closure）”</strong>或<strong>“静态作用域（Static scope）”</strong>。采用静态作用域减轻了程序员的负担，因为它已经在代码中体现了，因此你可以很容易理解。另一方面，还有一种被称为<strong>“动态作用域（Dynamic scope）”</strong>的作用域。这种作用域仅在程序运行时确定。由于会在调试时带来种种问题，这种作用域现在已经不再使用。</p><p>特殊形式<code>let</code>、<code>lambda</code>、<code>letrec</code>生成闭包。lambda表达式的参数仅在函数定义内部有效。<code>let</code>只是<code>lambda</code>的语法糖，因此二者无异。</p><h4 id="使用赋值和词法闭包来实现内部状态"><a href="#使用赋值和词法闭包来实现内部状态" class="headerlink" title="使用赋值和词法闭包来实现内部状态"></a>使用赋值和词法闭包来实现内部状态</h4><p>你可以使用词法闭包来实现带有内部状态的过程。例如，用于模拟银行账户的过程可以按如下的方式编写：初始资金是10美元。函数接收一个整形参数。正数表示存入，负数表示取出。为了简单起见，这里允许存款为负数。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> bank-account
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">balance</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">set!</span> balance <span class="token punctuation">(</span><span class="token operator">+</span> balance n<span class="token punctuation">)</span><span class="token punctuation">)</span>
      balance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>该过程将存款赋值为<code>(+ balance n)</code>。下面是调用这个过程的结果。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">bank-account</span> <span class="token number">20</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">; donating 20 dollars </span>
<span class="token comment" spellcheck="true">;Value: 30</span>

<span class="token punctuation">(</span><span class="token function">bank-account</span> <span class="token number">-25</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">; withdrawing 25 dollars</span>
<span class="token comment" spellcheck="true">;Value: 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因为在Scheme中，你可以编写返回过程的过程，因此你可以编写一个创建银行账户的函数。这个例子喻示着使用函数式程序设计语言可以很容易实现面向对象程序设计语言。实际上，只需要在这个基础上再加一点东西就可以实现一门面向对象程序设计语言了。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">make-bank-account</span> balance<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">set!</span> balance <span class="token punctuation">(</span><span class="token operator">+</span> balance n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    balance<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> gates-bank-account <span class="token punctuation">(</span><span class="token function">make-bank-account</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">; Gates makes a bank account by donating  10 dollars</span>
<span class="token comment" spellcheck="true">;Value: gates-bank-account</span>

<span class="token punctuation">(</span><span class="token function">gates-bank-account</span> <span class="token number">50</span><span class="token punctuation">)</span>                              <span class="token comment" spellcheck="true">; donating 50 dollars</span>
<span class="token comment" spellcheck="true">;Value: 60</span>

<span class="token punctuation">(</span><span class="token function">gates-bank-account</span> <span class="token number">-55</span><span class="token punctuation">)</span>                             <span class="token comment" spellcheck="true">; withdrawing 55 dollars</span>
<span class="token comment" spellcheck="true">;Value: 5</span>


<span class="token punctuation">(</span><span class="token keyword">define</span> torvalds-bank-account <span class="token punctuation">(</span><span class="token function">make-bank-account</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">; Torvalds makes a bank account by donating 100 dollars</span>
<span class="token comment" spellcheck="true">;Value: torvalds-bank-account</span>

<span class="token punctuation">(</span><span class="token function">torvalds-bank-account</span> <span class="token number">-70</span><span class="token punctuation">)</span>                             <span class="token comment" spellcheck="true">; withdrawing 70 dollars</span>
<span class="token comment" spellcheck="true">;Value: 30</span>

<span class="token punctuation">(</span><span class="token function">torvalds-bank-account</span> <span class="token number">300</span><span class="token punctuation">)</span>                             <span class="token comment" spellcheck="true">; donating 300 dollars</span>
<span class="token comment" spellcheck="true">;Value: 330</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="副作用"><a href="#副作用" class="headerlink" title="副作用"></a>副作用</h3><p>Scheme过程的主要目的是返回一个值，而另一个目的则称为<strong>副作用（Side Effect）</strong>。赋值和IO操作就是副作用。</p><h3 id="表的破坏性操作（set-car-，set-cdr-）"><a href="#表的破坏性操作（set-car-，set-cdr-）" class="headerlink" title="表的破坏性操作（set-car!，set-cdr!）"></a>表的破坏性操作（set-car!，set-cdr!）</h3><p>函数<code>set-car!</code>和<code>set-cdr!</code>分别为一个cons单元的car部分和cdr部分赋新值。和<code>set!</code>不同，这两个操作可以为S-表达式赋值。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> tree <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">3</span> <span class="token number">4</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">set-car!</span> <span class="token punctuation">(</span><span class="token builtin">car</span> tree<span class="token punctuation">)</span> <span class="token number">100</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">; changing 1 to 100 </span>

tree
 <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">100</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">3</span> <span class="token number">4</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">set-cdr!</span> <span class="token punctuation">(</span><span class="token function">third</span> tree<span class="token punctuation">)</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">a</span> b c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">; changing  '(7 8 9) to '(a b c) </span>

tree
⇒ <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">100</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">3</span> <span class="token number">4</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">6</span> a b c<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h3><p>队列可以用<code>set-car!</code>和<code>set-cdr!</code>实现。队列是一种<strong>先进先出(First in first out, FIFO)</strong>的数据结构，表则是<strong>先进后出(First in last out，FILO)</strong>。图表1展示了队列的结构。<code>cons-cell-top</code>的car部分指向表（头），而（<code>cons-cell-top</code>的）cdr部分指向表末的cons单元（表尾）。</p><p>入队操作按如下步骤进行：</p><ol><li>将当前最末的cons单元（可以通过<code>cons-cell-top</code>取得）的cdr部分重定向到新的元素。</li><li>将<code>cons-cell-top</code>的cdr部分重定向到新的元素</li></ol><p>出队操作按如下步骤进行:</p><ol><li>将队首元素存放在一个局部变量里。</li><li>将<code>cons-cell-top</code>的car部分重定向到表的第二个元素</li></ol><p>[代码片段1]展示了如何实现队列。函数<code>enqueue!</code>返回将元素<code>obj</code>添加进队列<code>queue</code>后的队列。函数<code>dequeue!</code>将队列的首元素移出队列并将该元素的值作为返回值。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>make-queue<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">enqueue!</span> queue obj<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">lobj</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> obj <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">null?</span> <span class="token punctuation">(</span><span class="token builtin">car</span> queue<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">begin</span>
      <span class="token punctuation">(</span><span class="token function">set-car!</span> queue lobj<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token function">set-cdr!</span> queue lobj<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">begin</span>
      <span class="token punctuation">(</span><span class="token function">set-cdr!</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> queue<span class="token punctuation">)</span> lobj<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token function">set-cdr!</span> queue lobj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token builtin">car</span> queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">dequeue!</span> queue<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">obj</span> <span class="token punctuation">(</span><span class="token builtin">car</span> <span class="token punctuation">(</span><span class="token builtin">car</span> queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token function">set-car!</span> queue <span class="token punctuation">(</span><span class="token builtin">cdr</span> <span class="token punctuation">(</span><span class="token builtin">car</span> queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> q <span class="token punctuation">(</span>make-queue<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: q</span>

<span class="token punctuation">(</span><span class="token function">enqueue!</span> q <span class="token string">'a)</span>
<span class="token comment" spellcheck="true">;Value 12: (a)</span>

<span class="token punctuation">(</span><span class="token function">enqueue!</span> q <span class="token string">'b)</span>
<span class="token comment" spellcheck="true">;Value 12: (a b)</span>

<span class="token punctuation">(</span><span class="token function">enqueue!</span> q <span class="token string">'c)</span>
<span class="token comment" spellcheck="true">;Value 12: (a b c)</span>

<span class="token punctuation">(</span><span class="token function">dequeue!</span> q<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: a</span>

q
<span class="token comment" spellcheck="true">;Value 13: ((b c) c)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="字符与字符串"><a href="#字符与字符串" class="headerlink" title="字符与字符串"></a>字符与字符串</h2><h3 id="简介-5"><a href="#简介-5" class="headerlink" title="简介"></a>简介</h3><p>Scheme也有像<strong>字符（Character）</strong>、<strong>字符串（String）</strong>、<strong>符号（Symbol）</strong>、<strong>向量（Vector）</strong>等的其它数据类型。</p><h3 id="字符"><a href="#字符" class="headerlink" title="字符"></a>字符</h3><p>在某个字符前添加<code>#\</code>来表明该物是一个字符。例如，<code>#\a</code>表示字符a。字符<code>#\Space</code>、<code>#\Tab</code>、<code>#\Linefeed</code>和<code>#\Return</code>分别代表空格（Space）、制表符（Tab），Linefeed和返回（Return）。R5RS中定义了下面的与字符相关的函数。</p><p><strong>(char? obj)</strong></p><p>如果<code>obj</code>是一个字符则返回<code>#t</code>。</p><p><strong>(char=? c1 c2)</strong></p><p>如果<code>c1</code>和<code>c2</code>是同一个字符的话则返回<code>#t</code>。</p><p><strong>(char-&gt;integer c)</strong></p><p>将<code>c</code>转化为对应的整数（字符代码，character code）。</p><p>示例：<code>(char-&gt;integer #\a) =&gt; 97</code></p><p><strong>(integer-&gt;char n)</strong></p><p>该函数将一个整数转化为对应的字符。</p><p><strong>(char&lt;? c1 c2)</strong>，</p><p><strong>(char&lt;= c1 c2)</strong>，</p><p><strong>(char&gt; c1 c2)</strong>，</p><p><strong>(char&gt;= c1 c2)</strong></p><p>这些函数用于比较字符。实际上，这些函数比较的是字符代码的大小。</p><p>例如，<code>(char&lt;? c1 c2)</code>等同于<code>(&lt; (char-&gt;integer c1) (char-&gt;integer c2))</code></p><p><strong>(char-ci=? c1 c2)</strong>，</p><p><strong>(char-ci&lt;? c1 c2)</strong>，</p><p><strong>(char-ci&lt;=? c1 c2)</strong>，</p><p><strong>(char-ci&gt;? c1 c2)</strong>，</p><p><strong>(char-ci&gt;=? c1 c2)</strong></p><p>这些比较函数对大小写不敏感。</p><p><strong>(char-alphabetic? c)</strong>，</p><p><strong>(char-numeric? c)</strong>，</p><p><strong>(char-whitespace? c)</strong>，</p><p><strong>(char-upper-case? c)</strong>，</p><p><strong>(char-lower-case? c)</strong></p><p>这些函数分别用于检测字符<code>c</code>是否为字母、数字、空白符、大写字母或小写字母。</p><p><strong>(char-upcase c)</strong>，</p><p><strong>(char-downcase c)</strong></p><p>这些函数分别返回字符C对应的大写或小写。</p><h3 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h3><p>字符串通过两个闭合的双引号表示。例如，<code>&quot;abc&quot;</code>表示字符串<code>abc</code>。R5RS定义了下面的函数。</p><p><strong>(string? s)</strong></p><p>如果<code>s</code>是一个字符则返回<code>#t</code>。</p><p><strong>(make-string n c)</strong></p><p>返回由<code>n</code>个字符<code>c</code>组成的字符串。参数<code>c</code>可选。</p><p><strong>(string-length s)</strong></p><p>返回字符串<code>s</code>的长度。</p><p><strong>(string=? s1 s2)</strong></p><p>如果字符串<code>s1</code>和<code>s2</code>相同的话则返回<code>#t</code>。</p><p><strong>(string-ref s idx)</strong></p><p>返回字符串<code>s</code>中索引为<code>idx</code>的字符（索引从0开始计数）。</p><p><strong>(string-set! s idx c)</strong></p><p>将字符串<code>s</code>中索引为<code>idx</code>的字符设置为<code>c</code>。</p><p><strong>(substring s start end)</strong></p><p>返回字符串<code>s</code>从<code>start</code>开始到<code>end-1</code>处的子串。例如<code>(substring &quot;abcdefg&quot; 1 4) =&gt; &quot;b c d&quot;</code></p><p><strong>(string-append s1 s2 …)</strong></p><p>连接两个字符串<code>s1</code>和<code>s2</code></p><p><strong>(string-&gt;list s)</strong></p><p>将字符串<code>s</code>转换为由字符构成的表。</p><p><strong>(list-&gt;string ls)</strong></p><p>将一个由字符构成的表转换为字符串。</p><p><strong>(string-copy s)</strong></p><p>复制字符串<code>s</code>。</p><h2 id="符号"><a href="#符号" class="headerlink" title="符号"></a>符号</h2><h3 id="简介-6"><a href="#简介-6" class="headerlink" title="简介"></a>简介</h3><p>我会在本章讲解在Lisp/Scheme程序设计语言中极具特色的数据类型——符号。符号是一种通过地址管理字符串的数据。符号可以被如<code>eq?</code>这样运行迅速地函数处理，而纯字符串需要被更慢的<code>equal?</code>处理。由于符号可以被快速比较，它们被用于做关联表和哈希表的键。</p><h3 id="有关符号的基本函数"><a href="#有关符号的基本函数" class="headerlink" title="有关符号的基本函数"></a>有关符号的基本函数</h3><p>下列都是有关符号的基本函数。</p><p><strong>(symbol? x)</strong></p><p>如果<code>x</code>是一个符号则返回#t。</p><p><strong>(string-&gt;symbol str)</strong></p><p>将<code>str</code>转换为符号。<code>str</code>应该都是小写的，否则地址系统可能无法正常工作。在MIT-Scheme中，<code>(string-&gt;symbol &quot;Hello&quot;)</code>和<code>&#39;Hello</code>是不同的。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">eq?</span> <span class="token punctuation">(</span><span class="token function">string->symbol</span> <span class="token string">"Hello"</span><span class="token punctuation">)</span> <span class="token string">'Hello)</span>
<span class="token comment" spellcheck="true">;Value: ()</span>

<span class="token punctuation">(</span><span class="token function">eq?</span> <span class="token punctuation">(</span><span class="token function">string->symbol</span> <span class="token string">"Hello"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">string->symbol</span> <span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token function">symbol->string</span>  <span class="token punctuation">(</span><span class="token function">string->symbol</span> <span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 15: "Hello"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>(symbol-&gt;string sym)</strong></p><p>将<code>sym</code>转换为字符。</p><h3 id="统计文本中的单词"><a href="#统计文本中的单词" class="headerlink" title="统计文本中的单词"></a>统计文本中的单词</h3><p>下面的代码是一段统计文本中单词个数的程序，这也是被经常用作演示如何使用符号的例子。该程序使用了<strong>哈希表（Hash table）</strong>和<strong>关联表（Association list）</strong>，这些都将在下一章中讲解。</p><pre class="line-numbers language-scheme"><code class="language-scheme">    <span class="token comment" spellcheck="true">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
     <span class="token comment" spellcheck="true">;;;   wc.scm</span>
     <span class="token comment" spellcheck="true">;;;   a scheme word-count program</span>
     <span class="token comment" spellcheck="true">;;;</span>
     <span class="token comment" spellcheck="true">;;;    by T.Shido</span>
     <span class="token comment" spellcheck="true">;;;    on August 19, 2005</span>
     <span class="token comment" spellcheck="true">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token builtin">list</span>->symbol ls0<span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token function">string->symbol</span> <span class="token punctuation">(</span><span class="token builtin">list</span>->string <span class="token punctuation">(</span><span class="token function">reverse!</span> ls0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">char-in</span> c . ls<span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token keyword">let</span> loop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ls0</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">null?</span> ls0<span class="token punctuation">)</span>
             <span class="token boolean">#f</span>
           <span class="token punctuation">(</span><span class="token function">or</span> <span class="token punctuation">(</span><span class="token function">char=?</span> c <span class="token punctuation">(</span><span class="token builtin">car</span> ls0<span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">read-words</span> fname<span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token function">with-input-from-file</span> fname
         <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token punctuation">(</span><span class="token keyword">let</span> loop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">w</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">wls</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">c</span> <span class="token punctuation">(</span>read-char<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">(</span><span class="token keyword">cond</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">eof-object?</span> c<span class="token punctuation">)</span>
                 <span class="token punctuation">(</span><span class="token function">reverse!</span> <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">pair?</span> w<span class="token punctuation">)</span>
                               <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token punctuation">(</span><span class="token builtin">list</span>->symbol w<span class="token punctuation">)</span> wls<span class="token punctuation">)</span>
                             wls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">char-in</span> c #\Space #\Linefeed #\Tab #\, #\.  #\ #\<span class="token punctuation">(</span><span class="token function"></span> #\<span class="token punctuation">)</span> #\= #\? #\! #\<span class="token comment" spellcheck="true">; #\:)</span>
                 <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">pair?</span> w<span class="token punctuation">)</span>
                               <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token punctuation">(</span><span class="token builtin">list</span>->symbol w<span class="token punctuation">)</span> wls<span class="token punctuation">)</span>
                             wls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">(</span><span class="token keyword">else</span>
             <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token punctuation">(</span><span class="token function">char-downcase</span> c<span class="token punctuation">)</span> w<span class="token punctuation">)</span> wls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">sort-by-frequency</span> al<span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token function">sort</span> al <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token function">x</span> y<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">wc</span> fname<span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">wh</span> <span class="token punctuation">(</span>make-eq-hash-table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">(</span><span class="token keyword">let</span> loop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ls</span> <span class="token punctuation">(</span><span class="token function">read-words</span> fname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">null?</span> ls<span class="token punctuation">)</span>
               <span class="token punctuation">(</span><span class="token function">sort-by-frequency</span> <span class="token punctuation">(</span><span class="token function">hash-table->alist</span> wh<span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token punctuation">(</span><span class="token keyword">begin</span>
             <span class="token punctuation">(</span><span class="token function">hash-table/put!</span> wh <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">1+</span> <span class="token punctuation">(</span><span class="token function">hash-table/get</span> wh <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">wc</span> <span class="token string">"opensource.txt"</span><span class="token punctuation">)</span>
⇒
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">the</span> . <span class="token number">208</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">to</span> . <span class="token number">142</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">a</span> . <span class="token number">104</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">of</span> . <span class="token number">103</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">and</span> . <span class="token number">83</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">that</span> . <span class="token number">75</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">is</span> . <span class="token number">73</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">in</span> . <span class="token number">65</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">i</span> . <span class="token number">64</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">you</span> . <span class="token number">55</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">it</span> . <span class="token number">54</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">they</span> . <span class="token number">48</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">for</span> . <span class="token number">46</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">what</span> . <span class="token number">38</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">work</span> . <span class="token number">37</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">but</span> . <span class="token number">35</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">have</span> . <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">on</span> . <span class="token number">32</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">people</span> . <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">are</span> . <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">be</span> . <span class="token number">29</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">do</span> . <span class="token number">29</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">from</span> . <span class="token number">27</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">so</span> . <span class="token number">26</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">like</span> . <span class="token number">25</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">as</span> . <span class="token number">25</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">by</span> . <span class="token number">24</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">source</span> . <span class="token number">24</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">not</span> . <span class="token number">23</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">open</span> . <span class="token number">23</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">can</span> . <span class="token number">23</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">we</span> . <span class="token number">22</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">was</span> . <span class="token number">22</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">one</span> . <span class="token number">22</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>it<span class="token string">'s</span> . <span class="token number">22</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">an</span> . <span class="token number">21</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">this</span> . <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">about</span> . <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">business</span> . <span class="token number">18</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">working</span> . <span class="token number">18</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">most</span> . <span class="token number">17</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">there</span> . <span class="token number">17</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">at</span> . <span class="token number">17</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">with</span> . <span class="token number">16</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>don<span class="token string">'t</span> . <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">just</span> . <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">their</span> . <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">something</span> . <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">than</span> . <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">has</span> . <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">if</span> . <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">when</span> . <span class="token number">14</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">because</span> . <span class="token number">14</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">more</span> . <span class="token number">14</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">were</span> . <span class="token number">13</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">office</span> . <span class="token number">13</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">own</span> . <span class="token number">13</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">or</span> . <span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">online</span> . <span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">now</span> . <span class="token number">12</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">blogging</span> . <span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">how</span> . <span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">employees</span> . <span class="token number">11</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">them</span> . <span class="token number">11</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">think</span> . <span class="token number">11</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">time</span> . <span class="token number">11</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">company</span> . <span class="token number">11</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">lot</span> . <span class="token number">11</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">want</span> . <span class="token number">11</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">companies</span> . <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">could</span> . <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">know</span> . <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">get</span> . <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">learn</span> . <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">better</span> . <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">some</span> . <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">who</span> . <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">even</span> . <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">thing</span> . <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">much</span> . <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">no</span> . <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">make</span> . <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">up</span> . <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">being</span> . <span class="token number">9</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">money</span> . <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">relationship</span> . <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>that<span class="token string">'s</span> . <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">us</span> . <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">anyone</span> . <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">average</span> . <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">bad</span> . <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">same</span> . <span class="token number">8</span><span class="token punctuation">)</span>
..........<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>说明：</p><p><strong>(list-&gt;symbo <code>ls0</code>)</strong></p><p>将一个由字符构成的列表（<code>ls0</code>）转换为一个符号。</p><p><strong>(char-in <code>c</code> . <code>ls</code>)</strong></p><p>检查字符（<code>c</code>）是否存在表（<code>ls</code>）。如果存在返回#t，不存在返回#f。</p><p><strong>(read-words <code>fname</code>)</strong></p><p>读取一个名为<code>fname</code>的文件，并返回一个符号列表。函数将大写转换为小写，将字符表（<code>w</code>）转换为一个字符，将<code>it</code>添加到符号表（<code>wls</code>）中。</p><p><strong>(sort-by-frequency <code>al</code>)</strong></p><p>以出现频率降序排序关联表（<code>al</code>）。</p><p><strong>(wc <code>fname</code>)</strong></p><p>读取名为<code>fname</code>的文件，并返回一个以出现频率降序排序关联表。因为函数使用了符号，<code>eq-hash-table</code>是适用的，它使用执行速度很快地<code>eq?</code>比较键（第40行）。函数统计由<code>read-words</code>创建的单词表里各单词的数量，并将其存储在一个哈希表（第44-46行）。在统计完成时（第43行），将哈希表转换为关联表。</p><h2 id="关联表和哈希表"><a href="#关联表和哈希表" class="headerlink" title="关联表和哈希表"></a>关联表和哈希表</h2><h3 id="简介-7"><a href="#简介-7" class="headerlink" title="简介"></a>简介</h3><p>本章中，我会讲解用于表示数据关联的关联表和哈希表。关联的数据是由键和值组成的序对，值由键唯一确定的。表1显示了书和作者构成的配对。书籍可以确定作者，反之由作者确定书籍则不可，这是因为一个作者可能会写很多本书。表1中，由于P. Graham和L.Carroll分别写了两本书，因此他们的书无法被作者的名字唯一确定。</p><p>表1：作者和书</p><table><thead><tr><th align="left">Author</th><th align="left">Book</th></tr></thead><tbody><tr><td align="left">P. Graham</td><td align="left">On Lisp</td></tr><tr><td align="left">P. Graham</td><td align="left">ANSI Common Lisp</td></tr><tr><td align="left">E. S. Raymond</td><td align="left">The Cathedral and the Bazaar</td></tr><tr><td align="left">K. Dybvig</td><td align="left">The Scheme Programming Language</td></tr><tr><td align="left">F. P. Brooks, Jr.</td><td align="left">The Mythical Man-Month</td></tr><tr><td align="left">L. Carroll</td><td align="left">Alice’s Adventures in Wonderland</td></tr><tr><td align="left">L. Carroll</td><td align="left">Through the Looking-Glass, and What Alice Found There</td></tr></tbody></table><p>R5RS定义了关联表，因此它在所有Scheme实现中都可用。但是使用关联表搜索速度较慢（O(n)的时间复杂度）。使用哈希表在速度方面更好一些（O(1)的时间复杂度），但是哈希表并未在R5RS中定义而是依赖于相关实现。MIT-Scheme实现了哈希表。如果你喜欢的Scheme实现没有哈希表，你可以自己实现一个（见 <a href="http://www.math.grin.edu/~stone/events/scheme-workshop/hash-tables.html）。">http://www.math.grin.edu/~stone/events/scheme-workshop/hash-tables.html）。</a></p><h3 id="关联表"><a href="#关联表" class="headerlink" title="关联表"></a>关联表</h3><p>关联表是一个由序对组成的表，它是一个用于表达关联的基本数据类型。符号，字符，和数字常被作为键使用，因为它们可以使用诸如<code>eq?</code>或者<code>eqv?</code>的快速比较函数被比较。在作为键被使用前，字符串应该被转换为符号，从而获得更好的性能。</p><p>下面是一个关联表的例子。关联表应该要么由点序对要么由普通表组成。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">hi</span> . <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">everybody</span> . <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">nice</span> . <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">to</span> . <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">meet</span> . <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">you</span> . <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">4</span> <span class="token number">5</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">7</span> <span class="token number">8</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>函数<code>assq</code>，<code>assv</code>，和<code>assoc</code>从关联表中搜寻一个项。这些函数从开始一步步搜索关联表。如果它们找到序对的<code>car</code>等于给定的<code>key</code>，就返回该序对。如果找不到函数返回<code>#f</code>。这些函数分别使用<code>eq?</code>，<code>eqv?</code>，和<code>equal?</code>比较键，这意味着<code>assq</code>最快，<code>assoc</code>最慢。这表示作为键的话，字符串，向量和表应该转化为符号或者数字（如果可能的话）以提高性能。</p><p>一般来说，<a href="http://www.shido.info/lisp/scheme_ah_e.html#hash">哈希表</a>在大量数据中搜索表现得更好一些。</p><p>下面展示在关联表中进行搜索的例子。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> wc <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">hi</span> . <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">everybody</span> . <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">nice</span> . <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">to</span> . <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">meet</span> . <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">you</span> . <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
⇒ wc

<span class="token punctuation">(</span><span class="token function">assq</span> <span class="token string">'hi</span> wc<span class="token punctuation">)</span>
⇒  <span class="token punctuation">(</span><span class="token function">hi</span> . <span class="token number">3</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">assq</span> <span class="token string">'you</span> wc<span class="token punctuation">)</span>
⇒  <span class="token punctuation">(</span><span class="token function">you</span> . <span class="token number">8</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">assq</span> <span class="token string">'i</span> wc<span class="token punctuation">)</span>
⇒  <span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token punctuation">(</span><span class="token keyword">define</span> n <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">4</span> <span class="token number">5</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">7</span> <span class="token number">8</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
⇒  n

<span class="token punctuation">(</span><span class="token function">assv</span> <span class="token number">1</span> n<span class="token punctuation">)</span>
⇒  <span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">assv</span> <span class="token number">8</span> n<span class="token punctuation">)</span>
⇒  <span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h3><p><a href="http://en.wikipedia.org/wiki/Hash-table">哈希表</a>是一种数据类型，它使用哈希函数将键转化为整数，并将值存储在由该整数所指示的位置。当表足够稀疏时，搜索，插入，更新都能以O(1)完成。下面展示了MIT-Scheme里哈希表的一些基本函数。查询<a href="http://www.swiss.ai.mit.edu/projects/scheme/documentation/scheme_12.html#SEC119">MIT-Scheme Manul</a>获取更详细的信息。</p><p><strong>(make-eq-hash-table size),</strong></p><p><strong>(make-eqv-hash-table size),</strong></p><p><strong>(make-equal-hash-table size),</strong></p><p><strong>(make-string-hash-table size)</strong></p><p>这些函数创建哈希表。这些函数分别使用<code>eq?</code>，<code>eqv?</code>，<code>equal?</code>，和<code>string=?</code>比较键的值。哈希表的初始大小（<code>size</code>）可以选择性指定（optional）。由于只比较键的地址，所以<code>eq-hash-table</code>是最快的。由于键是序列，所以<code>equal-hash-table</code>和<code>string-hash-table</code>比较慢。</p><p><strong>(hash-table/put! hash-table key datum)</strong></p><p>将<code>hash-table</code>中<code>key</code>对应的值设为<code>datum</code>。</p><p><strong>(hash-table/get hash-table key default)</strong></p><p>返回<code>hash-table</code>中的<code>key</code>对应的值。如果<code>key</code>不存在于<code>hash-table</code>中，返回<code>default</code>。</p><p><strong>(hash-table-&gt;alist hash-table)</strong></p><p>将<code>hash-table</code>转换为关联表。</p><h3 id="生成密码"><a href="#生成密码" class="headerlink" title="生成密码"></a>生成密码</h3><p>让我们写一个密码创建程序作为关联表和哈希表的例子。</p><p>从字典里得到的密码很容易被破解，但另一方面，完全随机的密码又很难记忆和输入。程序使用无规则的拼写创建10个密码。密码应该尽可能频繁更改，但是我懒于自己创建密码。使用这个程序，我可以简单地改变密码。</p><p>程序由两部分构成。一部分用于创建连续字符出现频率的数据（stat-spell.scm），另一个用于基于这个数据创建密码（make-pw.scm）。</p><h3 id="stat-spell-scm"><a href="#stat-spell-scm" class="headerlink" title="stat-spell.scm"></a>stat-spell.scm</h3><p>这个程序可以阅读英语句子，数据存在哈希表里，并转换为关联表输出到一个文件（stat-spell.data）。[代码1]显示了源代码。</p><p>[代码1]</p><pre class="line-numbers language-scheme"><code class="language-scheme">01:     <span class="token comment" spellcheck="true">;;; make an alist of probable spelling from a given English text</span>
<span class="token number">02</span>:     
<span class="token number">03</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">skip-char?</span> c<span class="token punctuation">)</span>
<span class="token number">04</span>:       <span class="token punctuation">(</span><span class="token function">or</span> <span class="token punctuation">(</span><span class="token function">not</span> <span class="token punctuation">(</span><span class="token function">char-graphic?</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">memv</span> c <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">#\:</span> #\<span class="token comment" spellcheck="true">; #\' #\" #\`))))</span>
<span class="token number">05</span>:     
<span class="token number">06</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">ss-make-alist</span> c alist<span class="token punctuation">)</span>
<span class="token number">07</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">p</span> <span class="token punctuation">(</span><span class="token function">assv</span> c alist<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">08</span>:         <span class="token punctuation">(</span><span class="token keyword">if</span> p
<span class="token number">09</span>:             <span class="token punctuation">(</span><span class="token keyword">begin</span>
<span class="token number">10</span>:              <span class="token punctuation">(</span><span class="token function">set-cdr!</span> p <span class="token punctuation">(</span><span class="token function">1+</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">11</span>:              alist<span class="token punctuation">)</span>
<span class="token number">12</span>:           <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> c <span class="token number">1</span><span class="token punctuation">)</span> alist<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">13</span>:     
<span class="token number">14</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">ss-make-dat</span> filename<span class="token punctuation">)</span>
<span class="token number">15</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">char-hash</span> <span class="token punctuation">(</span>make-eqv-hash-table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">16</span>:         <span class="token punctuation">(</span><span class="token function">with-input-from-file</span> filename
<span class="token number">17</span>:           <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">18</span>:         <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">c</span> #\Space<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">19</span>:           <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">c1</span> <span class="token punctuation">(</span>read-char<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">20</span>:                      <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">not</span> <span class="token punctuation">(</span><span class="token builtin">eof-object?</span> c1<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">21</span>:                          <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">skip-char?</span> c1<span class="token punctuation">)</span>
<span class="token number">22</span>:                              <span class="token punctuation">(</span><span class="token function">loop</span> c<span class="token punctuation">)</span>
<span class="token number">23</span>:                              <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">c1</span> <span class="token punctuation">(</span><span class="token function">char-downcase</span> c1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">24</span>:                    <span class="token punctuation">(</span><span class="token function">hash-table/put!</span> char-hash c
<span class="token number">25</span>:                             <span class="token punctuation">(</span><span class="token function">ss-make-alist</span> c1 <span class="token punctuation">(</span><span class="token function">hash-table/get</span> char-hash c <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">26</span>:                    <span class="token punctuation">(</span><span class="token function">loop</span> c1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">27</span>:         <span class="token punctuation">(</span><span class="token function">with-output-to-file</span> <span class="token string">"stat-spell.dat"</span>
<span class="token number">28</span>:           <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">29</span>:         <span class="token punctuation">(</span><span class="token function">display</span> <span class="token string">"(define *stat-spell* \'("</span><span class="token punctuation">)</span>
<span class="token number">30</span>:         <span class="token punctuation">(</span>newline<span class="token punctuation">)</span>
<span class="token number">31</span>:         <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">alst</span> <span class="token punctuation">(</span><span class="token function">sort</span> <span class="token punctuation">(</span><span class="token function">hash-table->alist</span> char-hash<span class="token punctuation">)</span> 
<span class="token number">32</span>:                        <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token function">x</span> y<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">char33:</span>           <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">pair?</span> alst<span class="token punctuation">)</span>
<span class="token number">34</span>:               <span class="token punctuation">(</span><span class="token keyword">begin</span>
<span class="token number">35</span>:             <span class="token punctuation">(</span><span class="token function">write</span> <span class="token punctuation">(</span><span class="token builtin">car</span> alst<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">36</span>:             <span class="token punctuation">(</span>newline<span class="token punctuation">)</span>
<span class="token number">37</span>:             <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> alst<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">38</span>:             <span class="token punctuation">(</span><span class="token function">display</span> <span class="token string">"))"</span><span class="token punctuation">)</span>
<span class="token number">39</span>:             <span class="token punctuation">(</span>newline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>(skip-char? c)</strong></p><p>如果<code>c</code>不是图像字符或者<code>c</code>是 #:, #;, #&#39;, or #&quot;，就返回#t。读取文本时，这些字符会被跳过。</p><p><strong>(ss-make-alist c alist)</strong></p><p>有两个参数；字符的频率的关联表（<code>alist</code>）和字符（<code>c</code>）。如果<code>c</code>在<code>alist</code>中，在序对的cdr部分增加一。如果不在，返回 (cons (cons c 1) alist)。这个函数使用了set-cdr!。</p><p><strong>(ss-make-dat filename)</strong></p><p>从名为<code>filename</code>的文件中读取字符，并使用跟随字符的频率的关联表来关联这些读出的字符。结果以关联表形式存储在文件<a href="http://www.shido.info/lisp/stat-spell.dat">stat-spell.dat</a>。在34和35行，它在哈希表中更新了频率的关联表。存储在stat-spell.dat的最终数据是一个关联表的关联表。例如：</p><p>(#\v (#\y . 1) (#\a . 3) (#\o . 7) (#\e . 51) (#\i . 15))</p><p>表示 #\y, #\a, #\o, #\e, 和 #\i 跟随 #\v 之后出现的次数分别是1, 3, 7, 51, 和15次。</p><h3 id="make-pw-scm"><a href="#make-pw-scm" class="headerlink" title="make-pw.scm"></a>make-pw.scm</h3><p>基于 stat-spell.dat 创建十个密码。过程如下：</p><ol><li>基于频率数据创建由9到13个随机字符组成字符串表。字符 #\Space 被添加在表结尾。</li><li>添加一个00到99之间的随机数在随机选取的字符串表的结尾。</li><li>随机地将 #\Space 转换为 #-, #_, #/, #\Space, #., 或者 #,。</li><li>随机地将30%的字母字符变为大写。</li></ol><pre class="line-numbers language-scheme"><code class="language-scheme">01:     <span class="token comment" spellcheck="true">;;; make password from the alist of probable spelling</span>
<span class="token number">02</span>:     
<span class="token number">03</span>:     <span class="token punctuation">(</span><span class="token function">load</span> <span class="token string">"stat-spell.dat"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">; *stat-spell* (alist for following characters) is in.</span>
<span class="token number">04</span>:     
<span class="token number">05</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">alist->hash</span> al mode<span class="token punctuation">)</span>
<span class="token number">06</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">h</span> <span class="token punctuation">(</span><span class="token function">case</span> mode
<span class="token number">07</span>:                  <span class="token punctuation">(</span><span class="token punctuation">(</span>eq<span class="token punctuation">)</span> <span class="token punctuation">(</span>make-eq-hash-table<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">08</span>:                  <span class="token punctuation">(</span><span class="token punctuation">(</span>eqv<span class="token punctuation">)</span> <span class="token punctuation">(</span>make-eqv-hash-table<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">09</span>:                  <span class="token punctuation">(</span><span class="token punctuation">(</span>equal<span class="token punctuation">)</span> <span class="token punctuation">(</span>make-equal-hash-table<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">10</span>:                  <span class="token punctuation">(</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token punctuation">(</span>make-string-hash-table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">11</span>:         <span class="token punctuation">(</span><span class="token function">for-each</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token number">12</span>:                     <span class="token punctuation">(</span><span class="token function">hash-table/put!</span> h <span class="token punctuation">(</span><span class="token builtin">car</span> p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">13</span>:                   al<span class="token punctuation">)</span>
<span class="token number">14</span>:         h<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">15</span>:     
<span class="token number">16</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> *stat-spell-hash* <span class="token punctuation">(</span><span class="token function">alist->hash</span> *stat-spell* <span class="token string">'eqv))</span>
<span class="token number">17</span>:     
<span class="token number">18</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">pw-random-select</span> vec<span class="token punctuation">)</span>
<span class="token number">19</span>:       <span class="token punctuation">(</span><span class="token function">vector-ref</span> vec <span class="token punctuation">(</span><span class="token function">random</span> <span class="token punctuation">(</span><span class="token function">vector-length</span> vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">20</span>:     
<span class="token number">21</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>random00<span class="token punctuation">)</span>
<span class="token number">22</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">acc</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">23</span>:         <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> i <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token number">24</span>:             <span class="token punctuation">(</span><span class="token builtin">list</span>->string acc<span class="token punctuation">)</span>
<span class="token number">25</span>:           <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token function">1+</span> i<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token punctuation">(</span><span class="token function">pw-random-select</span> <span class="token string">'#</span><span class="token punctuation">(</span><span class="token function">#\0</span> #\1 #\2 #\3 #\4 #\5 #\6 #\7 #\8 #\9<span class="token punctuation">)</span><span class="token punctuation">)</span> acc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">26</span>:     
<span class="token number">27</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">occasional-upcase</span> c<span class="token punctuation">)</span>
<span class="token number">28</span>:       <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token function">random</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token number">29</span>:           <span class="token punctuation">(</span><span class="token function">char-upcase</span> c<span class="token punctuation">)</span>
<span class="token number">30</span>:         c<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">31</span>:     
<span class="token number">32</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">pw-enhance</span> ls<span class="token punctuation">)</span>
<span class="token number">33</span>:       <span class="token punctuation">(</span><span class="token builtin">list</span>->string
<span class="token number">34</span>:        <span class="token punctuation">(</span><span class="token function">map</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token number">35</span>:               <span class="token punctuation">(</span><span class="token keyword">cond</span>
<span class="token number">36</span>:                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">char=?</span> c #\Space<span class="token punctuation">)</span>
<span class="token number">37</span>:                 <span class="token punctuation">(</span><span class="token function">pw-random-select</span>  <span class="token string">'#</span><span class="token punctuation">(</span><span class="token function">#\-</span> #\_ #\/  #\Space  #\. #\, #\@ #\? #\<span class="token punctuation">(</span><span class="token function"></span> #\<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">38</span>:                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">char-alphabetic?</span> c<span class="token punctuation">)</span>
<span class="token number">39</span>:                 <span class="token punctuation">(</span><span class="token function">occasional-upcase</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">40</span>:                <span class="token punctuation">(</span><span class="token keyword">else</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">41</span>:             <span class="token punctuation">(</span><span class="token builtin">cdr</span> <span class="token punctuation">(</span><span class="token function">reverse!</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">42</span>:         
<span class="token number">43</span>:     
<span class="token number">44</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">random-following</span> alist<span class="token punctuation">)</span>
<span class="token number">45</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">n</span> <span class="token punctuation">(</span><span class="token function">random</span> <span class="token punctuation">(</span><span class="token builtin">apply</span> + <span class="token punctuation">(</span><span class="token function">map</span> cdr alist<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">46</span>:         <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">j</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">alist</span> alist<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">47</span>:           <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">pair?</span> alist<span class="token punctuation">)</span>
<span class="token number">48</span>:           <span class="token punctuation">(</span><span class="token keyword">let*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">pair</span> <span class="token punctuation">(</span><span class="token builtin">car</span> alist<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">49</span>:              <span class="token punctuation">(</span><span class="token function">k</span> <span class="token punctuation">(</span><span class="token operator">+</span> j <span class="token punctuation">(</span><span class="token builtin">cdr</span> pair<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">50</span>:             <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">></span> k n<span class="token punctuation">)</span>
<span class="token number">51</span>:             <span class="token punctuation">(</span><span class="token builtin">car</span> pair<span class="token punctuation">)</span>
<span class="token number">52</span>:             <span class="token punctuation">(</span><span class="token function">loop</span> k <span class="token punctuation">(</span><span class="token builtin">cdr</span> alist<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">53</span>:     
<span class="token number">54</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">make-pw</span> h n<span class="token punctuation">)</span>
<span class="token number">55</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">c</span> #\Space<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">acc</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">56</span>:         <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> i n<span class="token punctuation">)</span>
<span class="token number">57</span>:             <span class="token punctuation">(</span><span class="token function">string-append</span>
<span class="token number">58</span>:              <span class="token punctuation">(</span><span class="token function">pw-enhance</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> #\Space <span class="token punctuation">(</span><span class="token builtin">cons</span> c acc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">59</span>:              <span class="token punctuation">(</span>random00<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">60</span>:           <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token function">1+</span> i<span class="token punctuation">)</span>
<span class="token number">61</span>:             <span class="token punctuation">(</span><span class="token function">random-following</span> <span class="token punctuation">(</span><span class="token function">hash-table/get</span> h c <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">#\Space</span> . <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">62</span>:             <span class="token punctuation">(</span><span class="token builtin">cons</span> c acc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">63</span>:         
<span class="token number">64</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>pw-candidates<span class="token punctuation">)</span>
<span class="token number">65</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">66</span>:         <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> i <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token number">67</span>:             <span class="token punctuation">(</span><span class="token keyword">begin</span>
<span class="token number">68</span>:              <span class="token punctuation">(</span><span class="token function">display</span> i<span class="token punctuation">)</span>
<span class="token number">69</span>:              <span class="token punctuation">(</span><span class="token function">display</span> <span class="token string">": "</span><span class="token punctuation">)</span>
<span class="token number">70</span>:              <span class="token punctuation">(</span><span class="token function">write</span> <span class="token punctuation">(</span><span class="token function">make-pw</span> *stat-spell-hash* <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">9</span> <span class="token punctuation">(</span><span class="token function">random</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">71</span>:              <span class="token punctuation">(</span>newline<span class="token punctuation">)</span>
<span class="token number">72</span>:              <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token function">1+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">73</span>:           <span class="token string">'done)))</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="向量和结构体"><a href="#向量和结构体" class="headerlink" title="向量和结构体"></a>向量和结构体</h2><h3 id="简介-8"><a href="#简介-8" class="headerlink" title="简介"></a>简介</h3><p>本章中，我将讲解向量和结构体。</p><p>向量是一组通过整数索引的数据。与C语言中的数组不同，一个向量可以储存不同类型的数据。与表相比，向量更加紧凑且存取时间更短。但从另外一方面来说，向量是通过副作用来操作的，这样会造成负担。</p><p>Scheme中的结构体与C语言中的结构体类似。但Scheme中的结构体比C语言中的更容易使用，因为Scheme为结构体自动创建了读取函数和写入函数，这受益于Lisp/Scheme中的宏。</p><h3 id="向量"><a href="#向量" class="headerlink" title="向量"></a>向量</h3><h4 id="字面值"><a href="#字面值" class="headerlink" title="字面值"></a>字面值</h4><p>向量通过闭合的<code>#(</code>和<code>)</code>表示，例如<code>#(1 2 3)</code>。作为字面值（literals）时，它们应该被引用（be quoted），例如：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token string">'#</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span>             <span class="token comment" spellcheck="true">; 整数向量</span>
<span class="token string">'#</span><span class="token punctuation">(</span><span class="token function">a</span> <span class="token number">0</span> #\a<span class="token punctuation">)</span>           <span class="token comment" spellcheck="true">; 由符号、整数和字符构成的向量</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="向量函数"><a href="#向量函数" class="headerlink" title="向量函数"></a>向量函数</h4><p>下面的函数都是R5RS规定的函数：</p><p><strong>(vector? obj)</strong></p><p>如果obj是一个向量则返回#t。</p><p><strong>(make-vector k)</strong></p><p><strong>(make-vector k fill)</strong></p><p>返回有<code>k</code>个元素的向量。如果指定了第二个参数(<code>fill</code>)，那么所有的元素都会被初始化为<code>fill</code>。</p><p><strong>(vector obj …)</strong></p><p>返回由参数列表构成的向量。</p><p><strong>(vector-length vector)</strong></p><p>返回向量<code>vector</code>的长度。</p><p><strong>(vector-ref vector k)</strong></p><p>返回向量<code>vector</code>的索引为<code>k</code>的元素。（译注：和C语言类似，向量从0开始索引。）</p><p><strong>(vector-set! vector k obj)</strong></p><p>将向量<code>vector</code>的索引为<code>k</code>的元素修改为<code>obj</code>。</p><p><strong>(vector-&gt;list vector)</strong></p><p>将<code>vector</code>转换为表。</p><p><strong>(list-&gt;vector list)</strong></p><p>将<code>list</code>转换为向量。</p><p><strong>(vector-fill! vector fill)</strong></p><p>将向量<code>vector</code>的所有元素设置为<code>fill</code>。</p><p>例：一个对向量中元素求和的函数。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">vector-add</span> v1 v2<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">lenv1</span> <span class="token punctuation">(</span><span class="token function">vector-length</span> v1<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">(</span><span class="token function">lenv2</span> <span class="token punctuation">(</span><span class="token function">vector-length</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> lenv1 lenv2<span class="token punctuation">)</span>
          <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">v</span> <span class="token punctuation">(</span><span class="token function">make-vector</span> lenv1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> i lenv1<span class="token punctuation">)</span>
                    v
                    <span class="token punctuation">(</span><span class="token keyword">begin</span>
                      <span class="token punctuation">(</span><span class="token function">vector-set!</span> v i <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">vector-ref</span> v1 i<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">vector-ref</span> v2 i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                      <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">1</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token function">error</span> <span class="token string">"different dimensions."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>练习1</p><p>编写一个用于计算两向量内积的函数。</p></blockquote><h2 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h2><h3 id="大体功能"><a href="#大体功能" class="headerlink" title="大体功能"></a>大体功能</h3><p>虽然R5RS中没有定义结构体，但是在很多Scheme实现中，都实现了类似于Common Lisp中的结构体。</p><p>这些结构体本质上来说都是向量。每一个槽（slot）都通过使用一个宏来命名，我将会在下一章（十五章）中讲解这个问题。结构体通过不同的属性清楚地表示数据。定义结构体的宏自动为结构体创建<strong>取值器（accessor）</strong>和<strong>赋值器（setter）</strong>。你可以通过“程序”来写程序，这被认为是Lisp/Scheme最好之处之一。通过这个功能，你可以很快写出漂亮的程序。</p><h3 id="MIT-Scheme中的结构体"><a href="#MIT-Scheme中的结构体" class="headerlink" title="MIT-Scheme中的结构体"></a>MIT-Scheme中的结构体</h3><p>在MIT-Scheme中，结构体通过函数<code>define-structure</code>来定义。为了使你更加容易理解，我会用一个实例来讲解。请考虑书籍。书籍都有下列属性：</p><ul><li>标题</li><li>作者</li><li>出版商</li><li>出版年份</li><li>ISBN号</li></ul><p>因此结构体book就可以像下面这样定义：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span>-structure book title authors publisher year isbn<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>下面演示了如何注册<a href="http://www.oreilly.com/catalog/cathbazpaper/">“大教堂与市集（The Cathedral and Bazaar）”</a>。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> bazaar 
  <span class="token punctuation">(</span><span class="token function">make-book</span> 
   <span class="token string">"The Cathedral and the Bazaar"</span>
   <span class="token string">"Eric S. Raymond"</span>
   <span class="token string">"O'Reilly"</span>
   <span class="token number">1999</span>
   <span class="token number">0596001088</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然而，这样做多少有点不便，因为属性与值的关联并不清楚。参量<code>keyword-constructor</code>可以用于解决这个问题。下面的代码就是使用这个参量的重写版，这个版本中，属性与值的关联就非常清楚了。此外，制定这个参量后，参数的顺序就不重要了。参量<code>copier</code>可用于为结构体创建一个拷贝（copier）函数。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span>-structure <span class="token punctuation">(</span><span class="token function">book</span> keyword-constructor copier<span class="token punctuation">)</span> 
  title authors publisher year isbn<span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">define</span> bazaar 
  <span class="token punctuation">(</span><span class="token function">make-book</span> 
   <span class="token string">'title</span> <span class="token string">"The Cathedral and the Bazaar"</span>
   <span class="token string">'authors</span> <span class="token string">"Eric S. Raymond"</span>
   <span class="token string">'publisher</span> <span class="token string">"O'Reilly"</span>
   <span class="token string">'year</span> <span class="token number">1999</span>    
   <span class="token string">'isbn</span> <span class="token number">0596001088</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>一个名字形如<code>[the name of structure]?</code>的函数用于检查某对象是否为特定结构体。例如，可使用函数<code>book?</code>来检查<code>bazaar</code>是否为<code>book</code>结构体的一个实例。</li></ul><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">book?</span> bazaar<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>一个名字形如<code>copy-[structure name]</code>的函数用于拷贝结构体。例如，下面的代码演示了将<code>bazaar</code>拷贝到<code>cathedral</code>。</li></ul><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> cathedral <span class="token punctuation">(</span><span class="token function">copy-book</span> bazaar<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>一个名字形如<code>[structure name]-[attribute name]</code>的函数用于读取结构体某属性的值。例如，下面的代码演示了如何读取<code>bazaar</code>的<code>title</code>属性。</li></ul><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">book-title</span> bazaar<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 18: "The Cathedral and the Bazaar"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>一个名字形如<code>set-[结构体名称]-[属性名称]!</code>用于将某属性设定为特定值。下面的代码演示了如何将<code>bazaar</code>的<code>year</code>字段更新到2001（《大教堂与市集》2001年再版）。</li></ul><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">set-book-year!</span> bazaar <span class="token number">2001</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Unspecified return value</span>

<span class="token punctuation">(</span><span class="token function">book-year</span> bazaar<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 2001</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>请参阅<a href="http://deathking.github.io/yast-cn/contents/www.gnu.org/software/mit-scheme/documentation/scheme_3.html#SEC41">MIT/GNU Scheme Reference: 2.10 Structure Definitions</a>以获得关于结构体的跟多信息。</p><h3 id="The-Mastermind-—-一个简单的密码破解游戏"><a href="#The-Mastermind-—-一个简单的密码破解游戏" class="headerlink" title="The Mastermind — 一个简单的密码破解游戏"></a>The Mastermind — 一个简单的密码破解游戏</h3><p>作为向量的示例，我会演示一个简单的密码破解游戏。这是一个猜对手密码的游戏。密码是由0到9中四个不同的数组成的四位数。对手要通过使用<code>bulls</code>和<code>cows</code>的数量告知猜谜者猜测的准确程度。</p><ol><li>bull的数量（Nbull）是指值和位置都正确的数字的数量。</li><li>cow的数量（Ncow）是指值正确但位置错误的数字的数量。</li></ol><p>例如，密码是5601，猜测是1685，那么<code>bull</code>和<code>cow</code>和数分别是1和2。</p><p>计算机和用户相互猜测对方的密码。更少尝试次数的选手为胜利者。如果用户和电脑在相同的尝试次数中破解了密码就是平局。</p><h3 id="表示四个数字"><a href="#表示四个数字" class="headerlink" title="表示四个数字"></a>表示四个数字</h3><p>四位数字可以通过向量和计算<code>bull</code>以及<code>cow</code>的数量高效地表示。这种表达方法需要构成密码的数字都不相同。</p><p>创建长度为10的向量，每个索引（<code>k</code>）的值被设为<code>k</code>在密码中的数位。四个数位从低到高被计为1，2，3和4。如果数字没有出现，索引的值为0。例如，5601和1685可以表示如下：</p><pre><code>5601 → #(2 1 0 0 0 4 3 0 0 0)
1685 → #(0 4 0 0 0 1 3 0 2 0)</code></pre><p>5601这个例子中，数字0，1，5，和6分别出现在第2，第1，第4和第3位，那么在这个密码的向量表达式里索引0，1，5，6的值分别2是2，1，4和3，其他索引位都是0。</p><p>这种表达可以快速比较两个数字。如果两个向量的相同索引位的值都是正数情况下，如果值相等，就计为<code>bull</code>，如果值不相等，就计为<code>cow</code>。5601和1685这个例子的情况下，索引位6的值都为3，索引位1和索引位5的值都是正数，<code>bull</code>和<code>cow</code>的值为1和2。</p><h3 id="程序的设计"><a href="#程序的设计" class="headerlink" title="程序的设计"></a>程序的设计</h3><p>程序的设计如下：</p><ol><li>程序生成一个表，该表包含了所有不同四位数的向量表示。</li><li>程序从表中随机选取一个数字。</li><li>重洗步骤（1）产生的表。</li><li>程序首次猜用户的密码，用户给出bull和cow的数量。然后用户猜程序的密码，程序给出Nnull和Ncow。</li><li>重复步骤（3）直到电脑或者程序的bull数量变为4为止。如果在同一次双方的数量都变为4，就是平局。</li></ol><h3 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h3><p>[代码1]展示了源代码。代码很长但并不十分复杂。游戏由一个递归函数<code>mastermind-rec</code>执行。</p><p>[代码1]</p><pre class="line-numbers language-scheme"><code class="language-scheme"> <span class="token number">01</span>:     <span class="token comment" spellcheck="true">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
 <span class="token number">02</span>:     <span class="token comment" spellcheck="true">;;;</span>
 <span class="token number">03</span>:     <span class="token comment" spellcheck="true">;;; mastermind.scm</span>
 <span class="token number">04</span>:     <span class="token comment" spellcheck="true">;;; by T.Shido</span>
 <span class="token number">05</span>:     <span class="token comment" spellcheck="true">;;;</span>
 <span class="token number">06</span>:     <span class="token comment" spellcheck="true">;;; User and computer try to locate the four-digit integer set by the opponents each other.</span>
 <span class="token number">07</span>:     <span class="token comment" spellcheck="true">;;; One who locates the integer with fewer question is the winner.</span>
 <span class="token number">08</span>:     <span class="token comment" spellcheck="true">;;; The four-digit integer contains four of numerals 0--9, like 0123, 3749 etc.</span>
 <span class="token number">09</span>:     <span class="token comment" spellcheck="true">;;; The opponents should tell the guesser</span>
 <span class="token number">10</span>:     <span class="token comment" spellcheck="true">;;; (1) number of numerals that are shared by the guessed and set numbers</span>
 <span class="token number">11</span>:     <span class="token comment" spellcheck="true">;;; at wrong position (cows)</span>
 <span class="token number">12</span>:     <span class="token comment" spellcheck="true">;;; and (2) number of numerals at collect position (bulls).</span>
 <span class="token number">13</span>:     <span class="token comment" spellcheck="true">;;; </span>
 <span class="token number">14</span>:     <span class="token comment" spellcheck="true">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
 <span class="token number">15</span>:     <span class="token comment" spellcheck="true">;;;</span>
 <span class="token number">16</span>:     <span class="token comment" spellcheck="true">;;; The four-digit integers are represented by 10-cell vectors in the program</span>
 <span class="token number">17</span>:     <span class="token comment" spellcheck="true">;;; The value of n-th cell is the number of column that n appears in the integer.</span>
 <span class="token number">18</span>:     <span class="token comment" spellcheck="true">;;; in n is not appears the value is 0.</span>
 <span class="token number">19</span>:     <span class="token comment" spellcheck="true">;;; for example, 1234 is represented as #(0 4 3 2 1 0 0 0 0 0) and</span>
 <span class="token number">20</span>:     <span class="token comment" spellcheck="true">;;; 3916 as #(0 2 0 4 0 0 1 0 0 3).</span>
 <span class="token number">21</span>:     <span class="token comment" spellcheck="true">;;; With this inner representation, the score of the guess can be calculated faster.</span>
 <span class="token number">22</span>:     <span class="token comment" spellcheck="true">;;;</span>
 <span class="token number">23</span>:     <span class="token comment" spellcheck="true">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
 <span class="token number">24</span>:     
 <span class="token number">25</span>:     
 <span class="token number">26</span>:     <span class="token comment" spellcheck="true">;;;</span>
 <span class="token number">27</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">1-</span> x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span> x <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">28</span>:     
 <span class="token number">29</span>:     <span class="token comment" spellcheck="true">;;;</span>
 <span class="token number">30</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">char2int</span> c<span class="token punctuation">)</span>
 <span class="token number">31</span>:       <span class="token punctuation">(</span><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token function">char->integer</span> c<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">char->integer</span> #\0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">32</span>:     
 <span class="token number">33</span>:     <span class="token comment" spellcheck="true">;;; converting a list of 4 numbers to the vector notation</span>
 <span class="token number">34</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">ls2nvec</span> ls<span class="token punctuation">)</span>
 <span class="token number">35</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">vec</span> <span class="token punctuation">(</span><span class="token function">make-vector</span> <span class="token number">10</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">36</span>:         <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token punctuation">(</span><span class="token function">length</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">ls</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">37</span>:           <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">></span> i <span class="token number">0</span><span class="token punctuation">)</span>
 <span class="token number">38</span>:           <span class="token punctuation">(</span><span class="token keyword">begin</span>
 <span class="token number">39</span>:                <span class="token punctuation">(</span><span class="token function">vector-set!</span> vec <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span> i<span class="token punctuation">)</span>
 <span class="token number">40</span>:                <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token function">1-</span> i<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">41</span>:             vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">42</span>:     
 <span class="token number">43</span>:     <span class="token comment" spellcheck="true">;;; converting the vector notation to string</span>
 <span class="token number">44</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">nvec2int</span> vec<span class="token punctuation">)</span>
 <span class="token number">45</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">n</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">46</span>:         <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> i <span class="token number">10</span><span class="token punctuation">)</span>
 <span class="token number">47</span>:             n
 <span class="token number">48</span>:         <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">j</span> <span class="token punctuation">(</span><span class="token function">vector-ref</span> vec i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">49</span>:           <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token function">1+</span> i<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">+</span> n <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">></span> j <span class="token number">0</span><span class="token punctuation">)</span>
 <span class="token number">50</span>:                                     <span class="token punctuation">(</span><span class="token operator">*</span> i <span class="token punctuation">(</span><span class="token function">expt</span> <span class="token number">10</span> <span class="token punctuation">(</span><span class="token function">1-</span> j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">51</span>:                                   <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">52</span>:     
 <span class="token number">53</span>:     <span class="token comment" spellcheck="true">;;;</span>
 <span class="token number">54</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">int2str</span> i<span class="token punctuation">)</span>
 <span class="token number">55</span>:       <span class="token punctuation">(</span><span class="token function">string-append</span>
 <span class="token number">56</span>:        <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> i <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token string">"0"</span> <span class="token string">""</span><span class="token punctuation">)</span>
 <span class="token number">57</span>:        <span class="token punctuation">(</span><span class="token function">number->string</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">58</span>:     
 <span class="token number">59</span>:     <span class="token comment" spellcheck="true">;;; reading integer from stdin</span>
 <span class="token number">60</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">read-integer</span> str<span class="token punctuation">)</span>
 <span class="token number">61</span>:       <span class="token punctuation">(</span><span class="token function">string->number</span> <span class="token punctuation">(</span><span class="token function">read-from-stdin</span> str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">62</span>:     
 <span class="token number">63</span>:     <span class="token comment" spellcheck="true">;;;</span>
 <span class="token number">64</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">read-from-stdin</span> str<span class="token punctuation">)</span>
 <span class="token number">65</span>:       <span class="token punctuation">(</span><span class="token function">display</span> str<span class="token punctuation">)</span>
 <span class="token number">66</span>:       <span class="token punctuation">(</span>newline<span class="token punctuation">)</span>
 <span class="token number">67</span>:       <span class="token punctuation">(</span>read-line<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">68</span>:     
 <span class="token number">69</span>:     <span class="token comment" spellcheck="true">;;;</span>
 <span class="token number">70</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">write-to-stdout</span> . ls<span class="token punctuation">)</span>
 <span class="token number">71</span>:       <span class="token punctuation">(</span><span class="token function">for-each</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">display</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span> ls<span class="token punctuation">)</span>
 <span class="token number">72</span>:       <span class="token punctuation">(</span>newline<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">73</span>:     
 <span class="token number">74</span>:     <span class="token comment" spellcheck="true">;;; convert numeral string to the vector representation.</span>
 <span class="token number">75</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">str2nvec</span> str<span class="token punctuation">)</span>
 <span class="token number">76</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">vec</span> <span class="token punctuation">(</span><span class="token function">make-vector</span> <span class="token number">10</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">77</span>:         <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token punctuation">(</span><span class="token function">string-length</span> str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">ls</span> <span class="token punctuation">(</span><span class="token function">string->list</span> str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">78</span>:           <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">pair?</span> ls<span class="token punctuation">)</span>
 <span class="token number">79</span>:           <span class="token punctuation">(</span><span class="token keyword">begin</span>
 <span class="token number">80</span>:                <span class="token punctuation">(</span><span class="token function">vector-set!</span> vec <span class="token punctuation">(</span><span class="token function">char2int</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span> i<span class="token punctuation">)</span>
 <span class="token number">81</span>:                <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token function">1-</span> i<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">82</span>:             vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">83</span>:     
 <span class="token number">84</span>:     <span class="token comment" spellcheck="true">;;; calculating the score of guess</span>
 <span class="token number">85</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">scoring</span> vec0 vec1<span class="token punctuation">)</span>
 <span class="token number">86</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">n</span> <span class="token punctuation">(</span><span class="token function">vector-length</span> vec0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">87</span>:         <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">score</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">88</span>:           <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> i n<span class="token punctuation">)</span>
 <span class="token number">89</span>:           <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">d0</span> <span class="token punctuation">(</span><span class="token function">vector-ref</span> vec0 i<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">90</span>:                    <span class="token punctuation">(</span><span class="token function">d1</span> <span class="token punctuation">(</span><span class="token function">vector-ref</span> vec1 i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">91</span>:                 <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token function">1+</span> i<span class="token punctuation">)</span>
 <span class="token number">92</span>:               <span class="token punctuation">(</span><span class="token operator">+</span> score <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">and</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> <span class="token number">0</span> d0<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> <span class="token number">0</span> d1<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">93</span>:                                    <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> d0 d1<span class="token punctuation">)</span> <span class="token number">5</span> <span class="token number">1</span><span class="token punctuation">)</span>
 <span class="token number">94</span>:                                    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">95</span>:             score<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token number">96</span>:     
 <span class="token number">97</span>:     <span class="token comment" spellcheck="true">;;; show bulls and cows calculated from the score of user's guess</span>
 <span class="token number">98</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">show-user-score</span> score<span class="token punctuation">)</span>
 <span class="token number">99</span>:       <span class="token punctuation">(</span><span class="token function">write-to-stdout</span> <span class="token string">"Number of bulls and cows in your guess:"</span> <span class="token punctuation">)</span>
<span class="token number">100</span>:       <span class="token punctuation">(</span><span class="token function">write-to-stdout</span> <span class="token string">"bulls: "</span> <span class="token punctuation">(</span><span class="token function">quotient</span> score <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">101</span>:       <span class="token punctuation">(</span><span class="token function">write-to-stdout</span> <span class="token string">"cows: "</span> <span class="token punctuation">(</span><span class="token function">modulo</span> score <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">102</span>:       <span class="token punctuation">(</span>newline<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">103</span>:     
<span class="token number">104</span>:     <span class="token comment" spellcheck="true">;;; calculating the score of computer's guess from bulls and cows</span>
<span class="token number">105</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">read-my-score</span> gu0<span class="token punctuation">)</span>
<span class="token number">106</span>:       <span class="token punctuation">(</span><span class="token function">write-to-stdout</span> <span class="token string">"My guess is: "</span> <span class="token punctuation">(</span><span class="token function">int2str</span> <span class="token punctuation">(</span><span class="token function">nvec2int</span> gu0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">107</span>:       <span class="token punctuation">(</span><span class="token function">write-to-stdout</span> <span class="token string">"Give number of bulls and cows in my guess."</span> <span class="token punctuation">)</span>
<span class="token number">108</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">na5</span> <span class="token punctuation">(</span><span class="token operator">*</span> <span class="token number">5</span> <span class="token punctuation">(</span><span class="token function">read-integer</span> <span class="token string">"bulls: "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">109</span>:         <span class="token punctuation">(</span><span class="token operator">+</span> na5 <span class="token punctuation">(</span><span class="token function">read-integer</span> <span class="token string">"cows: "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">; the score is calculated by (5 * bull + cow)</span>
<span class="token number">110</span>:     
<span class="token number">111</span>:     <span class="token comment" spellcheck="true">;;; reading the user guess</span>
<span class="token number">112</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>read-user-guess<span class="token punctuation">)</span>
<span class="token number">113</span>:       <span class="token punctuation">(</span>newline<span class="token punctuation">)</span>
<span class="token number">114</span>:       <span class="token punctuation">(</span><span class="token function">str2nvec</span> <span class="token punctuation">(</span><span class="token function">read-from-stdin</span> <span class="token string">"Give your guess."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">115</span>:     
<span class="token number">116</span>:     <span class="token comment" spellcheck="true">;;; shuffling the list of four-digit numbers</span>
<span class="token number">117</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">shuffle-numbers</span> ls0<span class="token punctuation">)</span>
<span class="token number">118</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">vec</span> <span class="token punctuation">(</span><span class="token builtin">list</span>->vector ls0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">119</span>:         <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">n</span> <span class="token punctuation">(</span><span class="token function">vector-length</span> vec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">ls1</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">120</span>:           <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> n <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">121</span>:               ls1
<span class="token number">122</span>:           <span class="token punctuation">(</span><span class="token keyword">let*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">r</span> <span class="token punctuation">(</span><span class="token function">random</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">123</span>:              <span class="token punctuation">(</span><span class="token function">v</span> <span class="token punctuation">(</span><span class="token function">vector-ref</span> vec r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">124</span>:             <span class="token punctuation">(</span><span class="token function">vector-set!</span> vec r <span class="token punctuation">(</span><span class="token function">vector-ref</span> vec <span class="token punctuation">(</span><span class="token function">1-</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">125</span>:             <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token function">1-</span> n<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> v ls1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">126</span>:     
<span class="token number">127</span>:     <span class="token comment" spellcheck="true">;;; making a list of four-digit numbers in which numeral 0--9 appear once</span>
<span class="token number">128</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>make-numbers<span class="token punctuation">)</span>
<span class="token number">129</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ls1</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">130</span>:         <span class="token punctuation">(</span><span class="token keyword">letrec</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">rec</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token function">i</span> num ls<span class="token punctuation">)</span>
<span class="token number">131</span>:                 <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> i <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token number">132</span>:                 <span class="token punctuation">(</span><span class="token keyword">set!</span> ls1 <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token punctuation">(</span><span class="token function">ls2nvec</span> ls<span class="token punctuation">)</span> ls1<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">133</span>:                 <span class="token punctuation">(</span><span class="token function">for-each</span> 
<span class="token number">134</span>:                  <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token number">135</span>:                    <span class="token punctuation">(</span><span class="token function">rec</span> <span class="token punctuation">(</span><span class="token function">1+</span> i<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">delv</span> n num<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> n ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">136</span>:                  num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">137</span>:           <span class="token punctuation">(</span><span class="token function">rec</span> <span class="token number">0</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">138</span>:         ls1<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">139</span>:     
<span class="token number">140</span>:     <span class="token comment" spellcheck="true">;;;</span>
<span class="token number">141</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">game-over</span> sc0 sc1<span class="token punctuation">)</span>
<span class="token number">142</span>:       <span class="token punctuation">(</span><span class="token function">write-to-stdout</span>
<span class="token number">143</span>:        <span class="token punctuation">(</span><span class="token keyword">cond</span>
<span class="token number">144</span>:         <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">=</span> sc0 sc1<span class="token punctuation">)</span> <span class="token string">"Draw"</span><span class="token punctuation">)</span>
<span class="token number">145</span>:         <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">></span> sc0 sc1<span class="token punctuation">)</span> <span class="token string">"I won."</span><span class="token punctuation">)</span>
<span class="token number">146</span>:         <span class="token punctuation">(</span><span class="token keyword">else</span> <span class="token string">"You won."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">147</span>:       <span class="token string">'game-over)</span>
<span class="token number">148</span>:     
<span class="token number">149</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">scoring-user-guess</span> an0 gu1<span class="token punctuation">)</span>
<span class="token number">150</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">sc1</span> <span class="token punctuation">(</span><span class="token function">scoring</span> an0 gu1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">151</span>:         <span class="token punctuation">(</span><span class="token function">show-user-score</span> sc1<span class="token punctuation">)</span>
<span class="token number">152</span>:         sc1<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">153</span>:     
<span class="token number">154</span>:     <span class="token comment" spellcheck="true">;;; Practical main function. tail recursive.</span>
<span class="token number">155</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">mastermind-rec</span> an0 candidates<span class="token punctuation">)</span>
<span class="token number">156</span>:       <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">null?</span> candidates<span class="token punctuation">)</span>
<span class="token number">157</span>:           <span class="token punctuation">(</span><span class="token function">error</span> <span class="token string">"Error. You gave wrong score for my guess, probably."</span><span class="token punctuation">)</span>
<span class="token number">158</span>:           <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">gu0</span> <span class="token punctuation">(</span><span class="token builtin">car</span> candidates<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">159</span>:         <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">sc1</span> <span class="token punctuation">(</span><span class="token function">scoring-user-guess</span> an0 <span class="token punctuation">(</span>read-user-guess<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">160</span>:               <span class="token punctuation">(</span><span class="token function">sc0</span> <span class="token punctuation">(</span><span class="token function">read-my-score</span> gu0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">161</span>:           <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">or</span> <span class="token punctuation">(</span><span class="token operator">=</span> sc0 <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">=</span> sc1 <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">162</span>:               <span class="token punctuation">(</span><span class="token function">game-over</span> sc0 sc1<span class="token punctuation">)</span>
<span class="token number">163</span>:               <span class="token punctuation">(</span><span class="token function">mastermind-rec</span> an0 
<span class="token number">164</span>:                    <span class="token punctuation">(</span><span class="token function">keep-matching-items</span> 
<span class="token number">165</span>:                     <span class="token punctuation">(</span><span class="token builtin">cdr</span> candidates<span class="token punctuation">)</span>
<span class="token number">166</span>:                     <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">scoring</span> gu0 x<span class="token punctuation">)</span> sc0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">167</span>:     
<span class="token number">168</span>:     <span class="token comment" spellcheck="true">;;; The main function called from the top-level</span>
<span class="token number">169</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>mastermind<span class="token punctuation">)</span>
<span class="token number">170</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ls0</span> <span class="token punctuation">(</span>make-numbers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">171</span>:         <span class="token punctuation">(</span><span class="token function">mastermind-rec</span> <span class="token punctuation">(</span><span class="token builtin">list</span>-ref ls0 <span class="token punctuation">(</span><span class="token function">random</span> <span class="token punctuation">(</span><span class="token function">length</span> ls0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">shuffle-numbers</span> ls0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th align="left">行数</th><th align="left">函数</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">27</td><td align="left"><code>(1- x)</code></td><td align="left"><code>x</code>减一</td></tr><tr><td align="left">30</td><td align="left"><code>(char2int c)</code></td><td align="left">将字符<code>c</code>(#\0 – #\9)转换为整数（0 – 9）。</td></tr><tr><td align="left">34</td><td align="left"><code>(ls2nvec ls)</code></td><td align="left">将四个数字的表（<code>ls</code>）转换为向量表达式。<code>&#39;(5 3 6 0)-&gt;#(1 0 0 3 0 4 2 0 0 0)</code></td></tr><tr><td align="left">44</td><td align="left"><code>(nvec2int vec)</code></td><td align="left">将向量表达式<code>vec</code>转换为普通整数。</td></tr><tr><td align="left">54</td><td align="left"><code>(int2str i)</code></td><td align="left">将一个四位数<code>i</code>转换为字符串。如果<code>i</code>小于1000，’0’被置于高位。</td></tr><tr><td align="left">64</td><td align="left"><code>(read-from-stdin str)</code></td><td align="left">将<code>str</code>显示于标准输出，并返回用户从标准输入输入的字符串。</td></tr><tr><td align="left">70</td><td align="left"><code>(write-to-stdout . ls)</code></td><td align="left">将<code>ls</code>的每个元素都输出到标准输出，并在行尾插入行结束符。</td></tr><tr><td align="left">75</td><td align="left"><code>(str2nvec str)</code></td><td align="left">将用户输入的表示四位数的字符串<code>str</code>转换为向量表达式。</td></tr><tr><td align="left">86</td><td align="left"><code>(scoring vec0 vec1)</code></td><td align="left">以（5*Nnull + Ncow）计算两个整数（向量表达式）<code>vec0</code>和<code>vec1</code>的相似程度。</td></tr><tr><td align="left">98</td><td align="left"><code>(show-user-score score)</code></td><td align="left">通过相似度<code>score</code>计算Nbull和Ncow，并将它们显示在标准输出。</td></tr><tr><td align="left">105</td><td align="left"><code>(read-my-score gu0)</code></td><td align="left">显示计算机的猜测（gu0），让用户输入Nnull和Ncow，返回相似度score。</td></tr><tr><td align="left">112</td><td align="left"><code>(read-user-guess)</code></td><td align="left">返回用户猜测的向量表达式。</td></tr><tr><td align="left">116</td><td align="left"><code>(shuffle-numbers ls0)</code></td><td align="left">随机排序<code>ls0</code>。由于有随机读取的需求，将<code>ls0</code>转换为向量，然后随机读取向量的元素，以创建一个重排过的表。</td></tr><tr><td align="left">128</td><td align="left"><code>(make-numbers)</code></td><td align="left">返回由所有不同四位数构成的表。</td></tr><tr><td align="left">141</td><td align="left"><code>(game-over sc0 sc1)</code></td><td align="left">通过比较计算机的得分（sc0）和用户的得分(sc1)确定胜利者。</td></tr><tr><td align="left">149</td><td align="left"><code>(scoring-user-guess an0 gu1)</code></td><td align="left">计算计算机的密码（an0）和用户的猜测（gu1）的相似度，使用show-uuser-score输出Nbull和Ncow。</td></tr><tr><td align="left">155</td><td align="left"><code>(mastermind-rec an0 candidates)</code></td><td align="left">实际的主程序，它有两个参数；计算机密码（an0）和 猜测的表（candidate）。它计算计算机的得分（sc0）和用户的得分（sc1），如果<code>sc0</code>或者<code>sc1</code>为20，调用 (game-over sc0 sc1)。如果没有值为20，它根据<code>sc0</code>过滤猜测的表（candidate），并继续游戏。</td></tr><tr><td align="left">169</td><td align="left"><code>(mastermind)</code></td><td align="left">在控制台调用该函数以开始游戏。</td></tr></tbody></table><h3 id="如何玩"><a href="#如何玩" class="headerlink" title="如何玩"></a>如何玩</h3><p>输入如下代码启动游戏。最好在玩之前编译（你需要编译一次）。即使程序很简单，也很难取胜。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">compile-file</span> <span class="token string">"mastermind.scm"</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">load</span> <span class="token string">"mastermind"</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>mastermind<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>这一章，我通过玩<code>mastermind</code>游戏讲解了向量和结构体。附上<a href="http://www.shido.info/lisp/scheme_vec.zip"><code>mastermind</code>的源代码</a>。</p><p>我将在下一章讲自定义语法。自定义语法是Lisp/Scheme的一个优点。</p><h2 id="定义语法"><a href="#定义语法" class="headerlink" title="定义语法"></a>定义语法</h2><h3 id="简介-9"><a href="#简介-9" class="headerlink" title="简介"></a>简介</h3><p>本章中，我会讲解如何自定义语法。用户定义语法称作<strong>宏（Macro）</strong>。Lisp/Scheme中的宏比C语言中的宏更加强大。宏可以使你的程序优美而紧凑。</p><p><strong>宏是代码的变换</strong>。代码在被求值或编译前进行变换，程序会继续执行就像变换后的代码一开始就写好了一样。</p><p>你可以在Scheme中通过用符合R5RS规范的<code>syntax-rules</code>轻易地定义简单宏，相比之下，在Common Lisp中自定义语法就复杂多了。使用<code>syntax-rules</code>可以直接定义宏而不用担心<strong>变量捕获（Variable Capture）</strong>。另一方面，Scheme中定义那些无法用<code>syntax-rules</code>定义的复杂的宏就比Common Lisp要困难。</p><h3 id="简单宏的实例"><a href="#简单宏的实例" class="headerlink" title="简单宏的实例"></a>简单宏的实例</h3><p>我将以一个简单的宏作为例子。</p><p>[代码1]一个将变量赋值为<code>&#39;()</code>的宏。</p><p>[代码1]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> nil!
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> x<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">set!</span> x <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>syntax-reuls</code>的第二个参数是变换前和变化后的表达式的序对所构成的表。<code>_</code>代表宏的名字。简言之，[代码1]表示表达式<code>(nil! x)</code>会变换为<code>(set! x &#39;())</code>.</p><p>这类程序不能通过函数来实现，这是因为由于闭包性，函数不能影响外部变量。让我们来用函数版本来实现[代码1]，并观察效果。</p><p>[代码’1]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">f-nil!</span> x<span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token keyword">set!</span> x <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> a <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: a</span>

<span class="token punctuation">(</span><span class="token function">f-nil!</span> a<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 1</span>

a
<span class="token comment" spellcheck="true">;Value: 1           ; the value of a dose not change</span>

<span class="token punctuation">(</span><span class="token function">nil!</span> a<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 1</span>

a
<span class="token comment" spellcheck="true">;Value: ()          ; a becomes '()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我会演示另外一个例子。我们编写宏<code>when</code>，其语义为：当谓词求值为真时，求值相应语句。</p><p>[代码2]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> when
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> pred b1 ...<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">if</span> pred <span class="token punctuation">(</span><span class="token keyword">begin</span> b1 ...<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>[代码2]中的<code>...</code>代表了任意多个数的表达式（包括0个表达式）。[代码2]揭示了表达式<code>(when pred b1 ...)</code>变换为<code>(if pred (begin b1 ...))</code>。</p><p>由于这个宏是将表达式变换为<code>if</code>特殊形式，因此它不能使用函数来实现。下面的例子演示了如何使用<code>when</code>。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">when</span> <span class="token punctuation">(</span><span class="token operator">=</span> i <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token function">display</span> <span class="token string">"i == 0"</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>newline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
i == <span class="token number">0</span>
<span class="token comment" spellcheck="true">;Unspecified return value</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我会演示两个实际的宏：<code>while</code>和<code>for</code>（已在Scheme中实现）。只要谓词部分求值为真，<code>while</code>就会对语句体求值。而数字在指定的范围中，<code>for</code>就会对语句体求值。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> while
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> pred b1 ...<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">when</span> pred b1 ... <span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token punctuation">(</span><span class="token keyword">define-syntax</span> for
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> <span class="token punctuation">(</span><span class="token function">i</span> from to<span class="token punctuation">)</span> b1 ...<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">let</span> loop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token function">when</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> i to<span class="token punctuation">)</span>
      b1 ...
      <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token function">1+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面演示了如何使用它们：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">while</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> i <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token function">display</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token function">display</span> #\Space<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">set!</span> i <span class="token punctuation">(</span><span class="token operator">+</span> i <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span> 
<span class="token comment" spellcheck="true">;Unspecified return value</span>

<span class="token punctuation">(</span><span class="token function">for</span> <span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">0</span> <span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">display</span> i<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">display</span> #\Space<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span> 
<span class="token comment" spellcheck="true">;Unspecified return value</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="syntax-rule的更多细节"><a href="#syntax-rule的更多细节" class="headerlink" title="syntax-rule的更多细节"></a>syntax-rule的更多细节</h3><h4 id="多个定义模式"><a href="#多个定义模式" class="headerlink" title="多个定义模式"></a>多个定义模式</h4><p><code>syntax-rule</code>可以定义一系列模式。比如，一个让变量增加的宏，如果给定了变量名，那么宏<code>incf</code>使该变量增加1。可以通过编写如[代码4]这样的模式转换来实现宏<code>incf</code>。</p><p>[代码4]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> incf
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">begin</span> <span class="token punctuation">(</span><span class="token keyword">set!</span> x <span class="token punctuation">(</span><span class="token operator">+</span> x <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> x i<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">begin</span> <span class="token punctuation">(</span><span class="token keyword">set!</span> x <span class="token punctuation">(</span><span class="token operator">+</span> x i<span class="token punctuation">)</span><span class="token punctuation">)</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">j</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">incf</span> i<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">incf</span> j <span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">display</span> <span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token string">'i</span> <span class="token string">'=</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>newline<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">display</span> <span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token string">'j</span> <span class="token string">'=</span> j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">i</span> = <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">j</span> = <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Unspecified return value</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="宏的递归定义"><a href="#宏的递归定义" class="headerlink" title="宏的递归定义"></a>宏的递归定义</h4><p>代码形式<code>or</code>和<code>and</code>是通过像下面这样递归定义的宏：</p><p>[代码5]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> my-and
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token boolean">#t</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> e<span class="token punctuation">)</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> e1 e2 ...<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">if</span> e1
     <span class="token punctuation">(</span><span class="token function">my-and</span> e2 ...<span class="token punctuation">)</span>
     <span class="token boolean">#f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">define-syntax</span> my-or
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token boolean">#f</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> e<span class="token punctuation">)</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> e1 e2 ...<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">t</span> e1<span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token keyword">if</span> t t <span class="token punctuation">(</span><span class="token function">my-or</span> e2 ...<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以使用递归定义来编写复杂的宏。</p><h4 id="使用保留字"><a href="#使用保留字" class="headerlink" title="使用保留字"></a>使用保留字</h4><p><code>syntax-rule</code>的第一个参数是保留字的表。比如，<code>cond</code>的定义如[代码6]所示，其中，<code>else</code>是保留字。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> my-cond
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token keyword">else</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> <span class="token punctuation">(</span><span class="token keyword">else</span> e1 ...<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">begin</span> e1 ...<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> <span class="token punctuation">(</span><span class="token function">e1</span> e2 ...<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token function">when</span> e1 e2 ...<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> <span class="token punctuation">(</span><span class="token function">e1</span> e2 ...<span class="token punctuation">)</span> c1 ...<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">if</span> e1 
     <span class="token punctuation">(</span><span class="token keyword">begin</span> e2 ...<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">cond</span> c1 ...<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="局部语法"><a href="#局部语法" class="headerlink" title="局部语法"></a>局部语法</h3><p>在Scheme中，可以使用<code>let-syntax</code>和<code>letrec-syntax</code>来定义<strong>局部语法（Local Syntax）</strong>。这种形式的用法和<code>define-syntax</code>是相似的。</p><h3 id="取决于宏定义的实现"><a href="#取决于宏定义的实现" class="headerlink" title="取决于宏定义的实现"></a>取决于宏定义的实现</h3><p>有些宏无法使用<code>syntax-rules</code>来定义。定义这些宏的实现方法已经在Scheme实现中准备好了。由于这种行为严重依赖于实现，因此你可以跳过此节。</p><p>在MIT-Scheme中，<code>sc-macro-transformer</code>就可用于这种情况，它允许用户用与Common Lisp中相似的方式来编写宏。关于<code>,</code>、<code>,@</code>的介绍，请参见<a href="http://deathking.github.io/yast-cn/contents/www.lispworks.com/documentation/HyperSpec/Body/02_df.htm">The Common Lisp HyperSpec</a>。关于<code>sc-macro-transformer</code>和<code>make-syntactic-closuer</code>请参见MIT-Scheme手册。[代码7]演示了一个简单的例子。</p><p>[代码 7]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> show-vars
  <span class="token punctuation">(</span><span class="token function">sc-macro-transformer</span>
    <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token function">exp</span> env<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">vars</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> exp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           `<span class="token punctuation">(</span><span class="token keyword">begin</span>
              <span class="token punctuation">(</span><span class="token function">display</span>
                <span class="token punctuation">(</span><span class="token builtin">list</span>
                  ,@<span class="token punctuation">(</span><span class="token function">map</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>v<span class="token punctuation">)</span>
                            <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">w</span> <span class="token punctuation">(</span><span class="token function">make-syntactic-closure</span> env <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                 `<span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token string">',w</span> ,w<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                          vars<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span>newline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">define-syntax</span> random-choice
  <span class="token punctuation">(</span><span class="token function">sc-macro-transformer</span>
   <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token function">exp</span> env<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       `<span class="token punctuation">(</span><span class="token function">case</span> <span class="token punctuation">(</span><span class="token function">random</span> ,<span class="token punctuation">(</span><span class="token function">length</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> exp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      ,@<span class="token punctuation">(</span><span class="token function">map</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
           `<span class="token punctuation">(</span><span class="token punctuation">(</span>,<span class="token punctuation">(</span><span class="token function">incf</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> ,<span class="token punctuation">(</span><span class="token function">make-syntactic-closure</span> env <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">(</span><span class="token builtin">cdr</span> exp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">define-syntax</span> aif
  <span class="token punctuation">(</span><span class="token function">sc-macro-transformer</span>
   <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token function">exp</span> env<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">test</span> <span class="token punctuation">(</span><span class="token function">make-syntactic-closure</span> env <span class="token string">'</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">second</span> exp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token function">cthen</span> <span class="token punctuation">(</span><span class="token function">make-syntactic-closure</span> env <span class="token string">'</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">third</span> exp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token function">celse</span> <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">pair?</span> <span class="token punctuation">(</span><span class="token function">cdddr</span> exp<span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">(</span><span class="token function">make-syntactic-closure</span> env <span class="token string">'</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">fourth</span> exp<span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token boolean">#f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       `<span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">it</span> ,test<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">if</span> it ,cthen ,celse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>第一个宏<code>show-vars</code>用于显示变量的值。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">j</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">show-vars</span> i j k<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">j</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Unspecified return value</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>代码形式<code>(show-vars i j k)</code>被展开成下面这样。因为宏只能返回一个表达式，所以需要用<code>begin</code>返回表达式的集合。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">begin</span>
  <span class="token punctuation">(</span><span class="token function">display</span>
   <span class="token punctuation">(</span><span class="token builtin">list</span>
    <span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token string">'i</span> i<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token string">'j</span> j<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">list</span> <span class="token string">'k</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>newline<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>第二个宏<code>random-choice</code>被用于从参数中随机选择一个值或者过程。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>turn-right<span class="token punctuation">)</span> <span class="token string">'right)</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>turn-left<span class="token punctuation">)</span> <span class="token string">'left)</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>go-ahead<span class="token punctuation">)</span> <span class="token string">'straight)</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>stop<span class="token punctuation">)</span> <span class="token string">'stop)</span>

<span class="token punctuation">(</span><span class="token function">random-choice</span> <span class="token punctuation">(</span>turn-right<span class="token punctuation">)</span> <span class="token punctuation">(</span>turn-left<span class="token punctuation">)</span> <span class="token punctuation">(</span>go-ahead<span class="token punctuation">)</span> <span class="token punctuation">(</span>stop<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: right</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码形式被展开如下：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">case</span> <span class="token punctuation">(</span><span class="token function">random</span> <span class="token number">4</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token punctuation">(</span>0<span class="token punctuation">)</span> <span class="token punctuation">(</span>turn-right<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token punctuation">(</span>1<span class="token punctuation">)</span> <span class="token punctuation">(</span>turn-left<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token punctuation">(</span>2<span class="token punctuation">)</span> <span class="token punctuation">(</span>go-ahead<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token punctuation">(</span>3<span class="token punctuation">)</span> <span class="token punctuation">(</span>stop<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>第三个宏<code>aif</code>是一个回指宏（ anaphoric macro）。谓词的结果可以被指为<code>it</code>。变量<code>it</code>被捕获，以使得第二个参数<code>make-syntactic-closure</code>变为<code>&#39;(it)</code>。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">aif</span> <span class="token punctuation">(</span><span class="token function">memv</span> i <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">2</span> <span class="token number">4</span> <span class="token number">6</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token builtin">car</span> it<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>下面显示了扩展结果。</p><p>````scheme<br>(let ((it (memv i ‘(2 4 6 8))))<br>(if it<br>(car it)<br>#f))</p><pre><code>
### 结构体的原始实现

结构体（structure）可以通过[代码8]中的简单宏实现。这里定义的结构体的本质是一个向量（vector）和由宏自动创建的取值以及赋值函数。如果你喜欢的Scheme版本没有结构体的实现，你可以自己实现它们。

[代码8]

```scheme
01:     ;;; simple structure definition
02:     
03:     ;;; lists of symbols -&gt; string
04:     (define (append-symbol . ls)
05:       (let loop ((ls (cdr ls)) (str (symbol-&gt;string (car ls))))
06:         (if (null? ls)
07:         str
08:         (loop (cdr ls) (string-append str &quot;-&quot; (symbol-&gt;string (car ls)))))))
09:     
10:     ;;; obj -&gt; ls -&gt; integer
11:     ;;; returns position of obj in ls
12:     (define (position obj ls)
13:       (letrec ((iter (lambda (i ls)
14:                (cond
15:                 ((null? ls) #f)
16:                 ((eq? obj (car ls)) i)
17:                 (else (iter (1+ i) (cdr ls)))))))
18:         (iter 0 ls)))
19:                          
20:     
21:     ;;; list -&gt; integer -&gt; list
22:     ;;; enumerate list items
23:     (define (slot-enumerate ls i)
24:       (if (null? ls)
25:           &#39;()
26:         (cons `((,(car ls)) ,i) (slot-enumerate (cdr ls) (1+ i)))))
27:     
28:     ;;; define simple structure 
29:     (define-syntax defstruct
30:       (sc-macro-transformer
31:        (lambda (exp env)
32:          (let ((struct (second exp))
33:                (slots  (map (lambda (x) (if (pair? x) (car x) x)) (cddr exp)))
34:            (veclen (- (length exp) 1)))
35:            
36:            `(begin   
37:           (define ,(string-&gt;symbol (append-symbol &#39;make struct))   ; making instance
38:             (lambda ls
39:                   (let ((vec (vector &#39;,struct ,@(map (lambda (x) (if (pair? x) (second x) #f)) (cddr exp)))))
40:             (let loop ((ls ls))
41:               (if (null? ls)
42:                   vec
43:                   (begin
44:                            (vector-set! vec (case (first ls) ,@(slot-enumerate slots 1)) (second ls))
45:                 (loop (cddr ls))))))))
46:     
47:           (define ,(string-&gt;symbol (string-append (symbol-&gt;string struct) &quot;?&quot;))  ; predicate
48:             (lambda (obj)
49:               (and
50:                (vector? obj)
51:                (eq? (vector-ref obj 0) &#39;,struct))))
52:     
53:           ,@(map
54:              (lambda (slot)
55:                (let ((p (1+ (position slot slots))))
56:              `(begin
57:                 (define ,(string-&gt;symbol (append-symbol struct slot))    ; accessors
58:                   (lambda (vec)
59:                 (vector-ref vec ,p)))
60:     
61:                 (define-syntax ,(string-&gt;symbol                           ; modifier
62:                          (string-append
63:                           (append-symbol &#39;set struct slot) &quot;!&quot;))
64:                   (syntax-rules ()
65:                 ((_ s v) (vector-set! s ,p v)))))))
66:              slots)
67:     
68:           (define ,(string-&gt;symbol (append-symbol &#39;copy struct))      ; copier
69:             (lambda (vec)
70:               (let ((vec1 (make-vector ,veclen)))
71:             (let loop ((i 0))
72:               (if (= i ,veclen)
73:                   vec1
74:                   (begin
75:                 (vector-set! vec1 i (vector-ref vec i))
76:                 (loop (1+ i)))))))))))))</code></pre><p>下面演示了如何使用：</p><p>你可以定义一个结构体，要么只给出槽（slot）的名字，要么给出槽（slot）的名字和缺省值。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token comment" spellcheck="true">;;; Defining a structure point having 3 slots whose defaults are 0.0.</span>
<span class="token punctuation">(</span><span class="token function">defstruct</span> point <span class="token punctuation">(</span><span class="token function">x</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">y</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">z</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Unspecified return value</span>

<span class="token punctuation">(</span><span class="token keyword">define</span> p1 <span class="token punctuation">(</span><span class="token function">make-point</span> <span class="token string">'x</span> <span class="token number">10</span> <span class="token string">'y</span> <span class="token number">20</span> <span class="token string">'z</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: p1</span>

<span class="token punctuation">(</span><span class="token function">point?</span> p1<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token function">point-x</span> p1<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 10</span>

<span class="token comment" spellcheck="true">;;; Default values are used for unspecified values when an instance is made.</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> p2 <span class="token punctuation">(</span><span class="token function">make-point</span> <span class="token string">'z</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: p2</span>

<span class="token punctuation">(</span><span class="token function">point-x</span> p2<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 0.</span>

<span class="token punctuation">(</span><span class="token function">point-z</span> p2<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 20</span>

<span class="token comment" spellcheck="true">;;; Changing a slot value</span>
<span class="token punctuation">(</span><span class="token function">set-point-y!</span> p2 <span class="token number">12</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Unspecified return value</span>

<span class="token comment" spellcheck="true">;;; The reality of the structure definde by [code 8] is a vector</span>
p2
<span class="token comment" spellcheck="true">;Value 14: #(point 0. 12 20)</span>

<span class="token comment" spellcheck="true">;;; Defining a structure 'book' with no default values.</span>
<span class="token punctuation">(</span><span class="token function">defstruct</span> book title authors publisher year isbn<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Unspecified return value</span>

<span class="token punctuation">(</span><span class="token keyword">define</span> mon-month 
  <span class="token punctuation">(</span><span class="token function">make-book</span> <span class="token string">'title</span>  
         <span class="token string">"The Mythical Man-Month: Essays on Software Engineering"</span>
         <span class="token string">'authors</span>
         <span class="token string">"F.Brooks"</span>
         <span class="token string">'publisher</span>
         <span class="token string">"Addison-Wesley"</span>
         <span class="token string">'year</span>
         <span class="token number">1995</span>
         <span class="token string">'isbn</span>
         <span class="token number">0201835959</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: mon-month</span>

mon-month
<span class="token comment" spellcheck="true">;Value 15: #(book </span>
<span class="token string">"The Mythical Man-Month: Essays on Software Engineering"</span> 
<span class="token string">"F.Brooks"</span> 
<span class="token string">"Addison-Wesley"</span> 
<span class="token number">1995</span> 
<span class="token number">201835959</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">book-title</span> mon-month<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 13: "The Mythical Man-Month: Essays on Software Engineering"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>我简要介绍了Scheme里的宏。宏可以使你的代码更优雅。</p><p><code>syntax-rules</code>使得编写宏很容易。另一方面，编写Common Lisp的宏，则要求特点的技巧。</p><h2 id="继续"><a href="#继续" class="headerlink" title="继续"></a>继续</h2><h3 id="简介-10"><a href="#简介-10" class="headerlink" title="简介"></a>简介</h3><p>本章介绍的是Scheme中特有的数据类型——<strong>继续（Continuation）</strong>。由于其他程序设计语言并没有这种数据类型，因此它难于理解。当下，你并不需要彻底理解清楚，只需要大致了解。</p><p>我会讲解广义的继续和简短地介绍<strong>Continuation-Passing-Style(CPS)</strong>，然后再讲解Scheme中的继续。我认为通过这种方式理解继续会比较容易。</p><h3 id="广义继续"><a href="#广义继续" class="headerlink" title="广义继续"></a>广义继续</h3><p>继续是在返回到<strong>顶层（Top level）</strong>之前所需要执行的计算。实际上，继续存在于计算的每时每刻。以<code>(* 3 (+ 1 2))</code>为例，在求值完<code>(+ 1 2)</code>后，应该计算<code>{ (* 3 []) }</code>乘以3。然而，大多数语言都不显式地这么做，程序员对此并不熟悉。</p><h3 id="Continuation-Passing-Style-CPS"><a href="#Continuation-Passing-Style-CPS" class="headerlink" title="Continuation-Passing-Style(CPS)"></a>Continuation-Passing-Style(CPS)</h3><h4 id="简单的CPS"><a href="#简单的CPS" class="headerlink" title="简单的CPS"></a>简单的CPS</h4><p>CPS是一种编程风格，在这种风格中，把依赖于当前函数结果的后续函数作为参数传递给当前函数。[代码1]展示了以CPS编写的加法和乘法。在<code>k+</code>和<code>k*</code>中，<code>k</code>是后续函数。</p><p>[代码1]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">return</span> x<span class="token punctuation">)</span>
  x<span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">k+</span> a b k<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">k</span> <span class="token punctuation">(</span><span class="token operator">+</span> a b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">k*</span> a b k<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">k</span> <span class="token punctuation">(</span><span class="token operator">*</span> a b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[例1]演示了如何使用CPS计算<code>(* 3 (+ 1 2))</code>。</p><p>[例1]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">k+</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k*</span> x <span class="token number">3</span> return<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Scheme的普通形式中，值在括号内被计算并向括号外传递。与此相反，CPS中，值向括号内传递。如[例1]中，<code>k+</code>把<code>(+ 1 2)</code>的值传递给<code>(lambda (x) (k* x 3 return))</code>，而<code>k*</code>把<code>(* (+ 1 2) 3)</code>的结果传给<code>return</code>。</p><h4 id="以CPS编写递归函数"><a href="#以CPS编写递归函数" class="headerlink" title="以CPS编写递归函数"></a>以CPS编写递归函数</h4><p>递归函数同样可以以CPS编写。[代码2]展示了计算阶乘的函数如何用普通方式编写（<code>fact</code>）和以CPS编写(<code>kfact</code>)。</p><p>[代码2]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token comment" spellcheck="true">;;; normal factorial</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">fact</span> n<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> n <span class="token number">1</span><span class="token punctuation">)</span> 
      <span class="token number">1</span>
      <span class="token punctuation">(</span><span class="token operator">*</span> n <span class="token punctuation">(</span><span class="token function">fact</span> <span class="token punctuation">(</span><span class="token operator">-</span> n <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">;;; CPS factorial</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">kfact</span> n k<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> n <span class="token number">1</span><span class="token punctuation">)</span> 
      <span class="token punctuation">(</span><span class="token function">k</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token function">kfact</span> <span class="token punctuation">(</span><span class="token operator">-</span> n <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k</span> <span class="token punctuation">(</span><span class="token operator">*</span> n x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[例2]将3与4的阶乘相加。</p><p>[例2]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token comment" spellcheck="true">;;; normal</span>
<span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">3</span> <span class="token punctuation">(</span><span class="token function">fact</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">;;; CPS</span>
<span class="token punctuation">(</span><span class="token function">kfact</span> <span class="token number">4</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k+</span> x <span class="token number">3</span> return<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[代码3]演示了如何分别用普通方式和CPS编写计算表中元素之积的函数。在CPS函数中，后继函数存储在局部变量<code>break</code>中，因此当元素乘以0时，可以立即退出。</p><p>[代码3]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token comment" spellcheck="true">;;; normal</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">product</span> ls<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ls</span> ls<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">acc</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">cond</span>
     <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">null?</span> ls<span class="token punctuation">)</span> acc<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">zero?</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span> acc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">;;; CPS</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">kproduct</span> ls k<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">break</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ls</span> ls<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">cond</span>
       <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">null?</span> ls<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">zero?</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">break</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k</span> <span class="token punctuation">(</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[例3]将100与<code>&#39;(2 4 7)</code>的积相加。</p><p>[例3]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token comment" spellcheck="true">;;; normal</span>
<span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">100</span> <span class="token punctuation">(</span><span class="token function">product</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">2</span> <span class="token number">4</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">;;; CPS</span>
<span class="token punctuation">(</span><span class="token function">kproduct</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">2</span> <span class="token number">4</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k+</span> x <span class="token number">100</span> return<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>尽管CPS在这样简单的情况中并不实用，但在一些像是自然语言解析和逻辑编程等复杂程序中非常有用，因为与通常的编程风格相比，CPS可以更灵活地改变后续过程。</p><p><strong>异常处理（Exception handling）</strong>就是这种情况的简单例子。[代码4]演示了<code>kproduct</code>的错误处理版本，程序中当非数字值出现在输入表中，在其被打印时，计算就会终止。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">non-number-value-error</span> x<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">display</span> <span class="token string">"Value error: "</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">display</span>  x<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">display</span> <span class="token string">" is not number."</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>newline<span class="token punctuation">)</span>
  <span class="token string">'error)</span>

<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">kproduct</span> ls k k-value-error<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">break</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ls</span> ls<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">cond</span>
       <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">null?</span> ls<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">not</span> <span class="token punctuation">(</span><span class="token builtin">number?</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k-value-error</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">zero?</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">break</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k</span> <span class="token punctuation">(</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;;; valid</span>
<span class="token punctuation">(</span><span class="token function">kproduct</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">2</span> <span class="token number">4</span> <span class="token number">7</span><span class="token punctuation">)</span> 
      <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k+</span> x <span class="token number">100</span> return<span class="token punctuation">)</span><span class="token punctuation">)</span> 
      non-number-value-error<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 156</span>

<span class="token comment" spellcheck="true">;;; invalid</span>
<span class="token punctuation">(</span><span class="token function">kproduct</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">2</span> <span class="token number">4</span> <span class="token number">7</span> hoge<span class="token punctuation">)</span> 
      <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k+</span> x <span class="token number">100</span> return<span class="token punctuation">)</span><span class="token punctuation">)</span> 
      non-number-value-error<span class="token punctuation">)</span>
Value error: hoge is not number.
<span class="token comment" spellcheck="true">;Value: error</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Scheme中的继续"><a href="#Scheme中的继续" class="headerlink" title="Scheme中的继续"></a>Scheme中的继续</h3><p>通过上面的讲解，你应该掌握了继续（continuation）。继续有下面的性质：</p><ol><li>存在于整个计算过程中；</li><li>函数式程序设计语言和CPS可以显式地处理它。</li></ol><p>另外，上面例子展示的是<strong>闭包链（Chain of closure）</strong>。</p><p>然而，阅读和编写CPS程序是痛苦的，以常规方式来处理继续会更方便一点。</p><p>因此，Scheme中将继续实现为<strong>一级对象（first class object）</strong>（这意味这Scheme中的继续是个普通数据类型），任何时候都可以通过名为<code>call-with-current-continuation</code>来调用。由于继续是普通数据类型，你可以随心所欲地重用。考虑到<code>call-with-current-continuation</code>名字过长，通常使用其缩略名<code>call/cc</code>。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> call/cc call-with-current-continuation<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>函数<code>call-with-current-continuation (call/cc)</code>接受一个参数。该参数是一个函数，函数的参数接收当前继续。</p><p>下面是例子：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token operator">*</span> <span class="token number">3</span> <span class="token punctuation">(</span><span class="token builtin">call/cc</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">;⇒ 9      ; [1]</span>
<span class="token punctuation">(</span><span class="token operator">*</span> <span class="token number">3</span> <span class="token punctuation">(</span><span class="token builtin">call/cc</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">(</span><span class="token function">k</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">;⇒ 6      ; [2]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在<strong>情况[1]</strong>中，继续并没有被调用，语句的行为与普通S-表达式相同。另一方面，在<strong>情况[2]</strong>中，继续以2作为参数被调用。在这种情况中，继续的参数跳过了<code>call/cc</code>的处理，并逃逸至<code>call/cc</code>的外部。这种情况中，<code>k</code>是一个一元函数，等价于<code>(lambda (x) (* 3 x))</code>。</p><p>大体来说，当前继续存储了从<code>call/cc</code>调用点到顶层的处理过程。当前继续可以像其它数据类型那样被存储起来，并随心所欲地重用。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> cc<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token operator">*</span> <span class="token number">3</span> <span class="token punctuation">(</span><span class="token builtin">call/cc</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>k<span class="token punctuation">)</span>
                  <span class="token punctuation">(</span><span class="token keyword">set!</span> cc k<span class="token punctuation">)</span>
                  <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>由于当前继续是回到顶层的处理过程，它的返回会忽略周围的S-表达式。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">100</span> <span class="token punctuation">(</span><span class="token function">cc</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">;⇒ 9 </span>
<span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">100</span> <span class="token punctuation">(</span><span class="token function">cc</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">;⇒ 30</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="使用call-cc抛出值"><a href="#使用call-cc抛出值" class="headerlink" title="使用call/cc抛出值"></a>使用<code>call/cc</code>抛出值</h4><p>从一个计算过程中逃逸出来，是使用当前继续的最容易的方法。[代码5]演示了搜索树（嵌套表）的函数。如果函数在树中找到<code>obj</code>，那么它返回该对象，否则返回<code>#f</code>。一旦找到<code>obj</code>，函数直接将其抛出至最外部。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">find-leaf</span> obj tree<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token builtin">call/cc</span>
    <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>cc<span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token keyword">letrec</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">iter</span>
                   <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>tree<span class="token punctuation">)</span>
                      <span class="token punctuation">(</span><span class="token keyword">cond</span>
                        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">null?</span>  tree<span class="token punctuation">)</span> <span class="token boolean">#f</span><span class="token punctuation">)</span>
                        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">pair?</span> tree<span class="token punctuation">)</span>
                           <span class="token punctuation">(</span><span class="token function">iter</span> <span class="token punctuation">(</span><span class="token builtin">car</span> tree<span class="token punctuation">)</span><span class="token punctuation">)</span>
                           <span class="token punctuation">(</span><span class="token function">iter</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> tree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">(</span><span class="token keyword">else</span>
                          <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">eqv?</span> obj tree<span class="token punctuation">)</span>
                            <span class="token punctuation">(</span><span class="token function">cc</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">(</span><span class="token function">iter</span> tree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">find-leaf</span> <span class="token number">7</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token punctuation">(</span><span class="token function">2</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token number">4</span> <span class="token punctuation">(</span><span class="token function">5</span> <span class="token punctuation">(</span><span class="token function">6</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;⇒ 7</span>

<span class="token punctuation">(</span><span class="token function">find-leaf</span> <span class="token number">8</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token punctuation">(</span><span class="token function">2</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token number">4</span> <span class="token punctuation">(</span><span class="token function">5</span> <span class="token punctuation">(</span><span class="token function">6</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;⇒ ()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[例6]演示了一个支持抛出的语法<code>block</code>。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> block
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> tag e1 ...<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token builtin">call-with-current-continuation</span>
       <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
          e1 ...<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[例7]演示了如何使用它。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">block</span> break
   <span class="token punctuation">(</span><span class="token function">map</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
           <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">positive?</span> x<span class="token punctuation">)</span>
           <span class="token punctuation">(</span><span class="token function">sqrt</span> x<span class="token punctuation">)</span>
           <span class="token punctuation">(</span><span class="token function">break</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;⇒ (1 1.4142135623730951 1.7320508075688772)</span>

<span class="token punctuation">(</span><span class="token function">block</span> break
   <span class="token punctuation">(</span><span class="token function">map</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
           <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">positive?</span> x<span class="token punctuation">)</span>
           <span class="token punctuation">(</span><span class="token function">sqrt</span> x<span class="token punctuation">)</span>
           <span class="token punctuation">(</span><span class="token function">break</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">-2</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;⇒ -2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h4><p>我会讲解如何用<code>call/cc</code>实现一个树匹配的生成器。生成器以一个树为参数返回一个函数，每次调用这个返回的函数时，它会返回后续的叶子。你可以在<a href="http://ds26gte.github.io/tyscheme/index-Z-H-15.html#node_sec_13.3">Teach Yourself Scheme in Fixnum Days的第13.3节</a>中找到这个函数的原始版本。生成器的使用方法如下：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> tr <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">1</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">3</span> <span class="token punctuation">(</span><span class="token function">4</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> p <span class="token punctuation">(</span><span class="token function">leaf-generator</span> tr<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">;=> 1</span>
<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">;=> 2</span>
<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">;=> 3</span>
<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">;=> 4</span>
<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">;=> 5</span>
<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">;=> ()  ; finally it returns '()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[代码6]给出了生成器的定义。这个和原始版本基本上相同，但有略微的修改。</p><p>[代码6]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">leaf-generator</span> tree<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">return</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                               <span class="token comment" spellcheck="true">; 1</span>
    <span class="token punctuation">(</span><span class="token keyword">letrec</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">continue</span>                                              <span class="token comment" spellcheck="true">; 2</span>
      <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">let</span> rec <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">tree</span> tree<span class="token punctuation">)</span><span class="token punctuation">)</span>                                      <span class="token comment" spellcheck="true">; 3</span>
          <span class="token punctuation">(</span><span class="token keyword">cond</span>                                                     <span class="token comment" spellcheck="true">; 4</span>
           <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">null?</span> tree<span class="token punctuation">)</span> <span class="token string">'skip)</span>                                     <span class="token comment" spellcheck="true">; 5</span>
           <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">pair?</span> tree<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">rec</span> <span class="token punctuation">(</span><span class="token builtin">car</span> tree<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">rec</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> tree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true">; 6</span>
           <span class="token punctuation">(</span><span class="token keyword">else</span>                                                    <span class="token comment" spellcheck="true">; 7</span>
            <span class="token punctuation">(</span><span class="token builtin">call/cc</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>lap-to-go<span class="token punctuation">)</span>                            <span class="token comment" spellcheck="true">; 8</span>
                   <span class="token punctuation">(</span><span class="token keyword">set!</span> continue <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">lap-to-go</span> <span class="token string">'restart)))</span> <span class="token comment" spellcheck="true">; 9</span>
                   <span class="token punctuation">(</span><span class="token function">return</span> tree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                               <span class="token comment" spellcheck="true">;10</span>
        <span class="token punctuation">(</span><span class="token function">return</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                             <span class="token comment" spellcheck="true">;11</span>
    <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>                                                  <span class="token comment" spellcheck="true">;12</span>
      <span class="token punctuation">(</span><span class="token builtin">call/cc</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>where-to-go<span class="token punctuation">)</span>                            <span class="token comment" spellcheck="true">;13</span>
                 <span class="token punctuation">(</span><span class="token keyword">set!</span> return where-to-go<span class="token punctuation">)</span>                      <span class="token comment" spellcheck="true">;14</span>
                 <span class="token punctuation">(</span>continue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>(译者注：原文中05，08行中命名let中的<code>rec</code>被写为<code>loop</code>，结合上下文，改为<code>rec</code>)</p><p>注释解释</p><p>编号 解释</p><ul><li>1.定义本地变量<code>return</code>。</li><li>2.使用<code>letrec</code>定义<code>continue</code>。<code>continue</code>将当前叶子返回到前面，将当前继续赋给<code>continue</code>，并停止。</li><li>3.用<code>rec</code>定义命名let。</li><li>4.使用<code>cond</code>实现分支</li><li>5.如果是空表，什么也不做</li><li>6.如果是序对，递归地将序对的car和cdr应用于rec。</li><li>7.如果是叶子，</li><li>8.调用<code>call/cc</code>以获取当前状态(lap-to-go)</li><li>9.接着将当前状态赋给<code>continue</code>。所以除了原有的<code>continue</code>，<code>lap-to-go</code>也包含了当前状态。简而言之，它可以被如下的S-表达式中的<strong>[ ]</strong>表示。</li></ul><pre class="line-numbers language-Scheme"><code class="language-Scheme">(lambda ()
   (let rec ((tree tree0))  
      (cond                  
        ((null? tree) '())     
        ((pair? tree) (rec (car tree)) (rec (cdr tree)))  
        (else                                            
           [ ]
    (return '()))))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调用<code>lap-to-go</code>意味着<code>(car tree)</code>是叶子，且过程结束了，<code>(rec (cdr tree))</code>在下一次函数调用时开始运行。如果过程在<strong>[ ]</strong>之后结束，继续的参数将不起作用。</p><ul><li>10.接着函数将找到的叶子返回到函数的调用处。<code>(return tree)</code>应该在<code>call/cc</code>中以重启过程。</li><li>11.在搜索了全部叶子之后返回空表。</li><li>12.这是一个返回叶子生成器的生成器。</li><li>13.首次调用<code>call/cc</code></li><li>14.将表示返回值的当前状态赋给<code>return</code>。</li><li>15.然后调用<code>continue</code>。</li></ul><p>由<code>leaf-generator</code>生成的函数的行为可以通过函数<code>tree-traverse</code>的行为来估计。过程停止在轨迹的’*’的注释处，并使得过程存储在<code>continue</code>。</p><p>一个常规的遍历函数：</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> tree-traverse
  <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>tree<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">cond</span>
     <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">null?</span> tree<span class="token punctuation">)</span> <span class="token string">'_)</span>
     <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">pair?</span> tree<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">tree-traverse</span> <span class="token punctuation">(</span><span class="token builtin">car</span> tree<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">tree-traverse</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> tree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">else</span>
      <span class="token punctuation">(</span><span class="token function">write</span> tree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当树为<code>&#39;((1 2) 3)</code>时，<code>tree-traverse</code>的轨迹。</p><pre><code>&gt; (tree-traverse &#39;((1 2) 3))
|(tree-traverse ((1 2) 3))
| (tree-traverse (1 2))
| |(tree-traverse 1)           
1| |#&lt; void&gt;               ; *
| (tree-traverse (2))
| |(tree-traverse 2)           
2| |&lt; void&gt;                ; *
| (tree-traverse &#39;())
| _
|(tree-traverse (3))
| (tree-traverse 3)            
3| #&lt; void&gt;                ; *
|(tree-traverse &#39;())
|_
_</code></pre><h3 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h3><p>因为继续记录了后续计算过程，因此，用于多任务同时执行的<strong>协程（Coroutine）</strong>可以使用继续来实现。</p><p><strong>代码片段7</strong>展示了一段交替打印数字和字母的程序。5 - 22行是队列的实现。<code>(enqueue! queue obj)</code>将一个<code>obj</code>添加在队列的末尾。<code>(dequeue! queue)</code>返回队列第一个元素并将它删除。</p><p>26 - 38行是协程的实现。</p><p><strong>process-queue</strong></p><p>过程的队列。</p><p><strong>(coroutine thunk)</strong></p><p>在<code>process-queue</code>末尾添加<code>thunk</code>。</p><p><strong>(start)</strong></p><p>取得<code>process-queue</code>的第一个过程并执行它。</p><p><strong>(pause)</strong></p><p>将当前继续添加到<code>process-queue</code>的末尾并执行队列里的第一个过程。这个函数将控制权交给另外一个协程。</p><p>42 - 61行显示如何使用它。一个显示数字例程和一个显示字母例程相互调用对方，结果显示在<strong>例7</strong></p><pre class="line-numbers language-scheme"><code class="language-scheme">01:     <span class="token comment" spellcheck="true">;;; abbreviation</span>
<span class="token number">02</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> call/cc call-with-current-continuation<span class="token punctuation">)</span>
<span class="token number">03</span>:     
<span class="token number">04</span>:     <span class="token comment" spellcheck="true">;;; queue</span>
<span class="token number">05</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>make-queue<span class="token punctuation">)</span>
<span class="token number">06</span>:       <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">07</span>:     
<span class="token number">08</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">enqueue!</span> queue obj<span class="token punctuation">)</span>
<span class="token number">09</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">lobj</span> <span class="token punctuation">(</span><span class="token builtin">list</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">10</span>:         <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">null?</span> <span class="token punctuation">(</span><span class="token builtin">car</span> queue<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">11</span>:         <span class="token punctuation">(</span><span class="token keyword">begin</span>
<span class="token number">12</span>:           <span class="token punctuation">(</span><span class="token function">set-car!</span> queue lobj<span class="token punctuation">)</span>
<span class="token number">13</span>:           <span class="token punctuation">(</span><span class="token function">set-cdr!</span> queue lobj<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">14</span>:         <span class="token punctuation">(</span><span class="token keyword">begin</span>
<span class="token number">15</span>:           <span class="token punctuation">(</span><span class="token function">set-cdr!</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> queue<span class="token punctuation">)</span> lobj<span class="token punctuation">)</span>
<span class="token number">16</span>:           <span class="token punctuation">(</span><span class="token function">set-cdr!</span> queue lobj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">17</span>:         <span class="token punctuation">(</span><span class="token builtin">car</span> queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">18</span>:     
<span class="token number">19</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">dequeue!</span> queue<span class="token punctuation">)</span>
<span class="token number">20</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">obj</span> <span class="token punctuation">(</span><span class="token builtin">car</span> <span class="token punctuation">(</span><span class="token builtin">car</span> queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">21</span>:         <span class="token punctuation">(</span><span class="token function">set-car!</span> queue <span class="token punctuation">(</span><span class="token builtin">cdr</span> <span class="token punctuation">(</span><span class="token builtin">car</span> queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">22</span>:         obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">23</span>:     
<span class="token number">24</span>:     
<span class="token number">25</span>:     <span class="token comment" spellcheck="true">;;; coroutine   </span>
<span class="token number">26</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> process-queue <span class="token punctuation">(</span>make-queue<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">27</span>:     
<span class="token number">28</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">coroutine</span> thunk<span class="token punctuation">)</span>
<span class="token number">29</span>:       <span class="token punctuation">(</span><span class="token function">enqueue!</span> process-queue thunk<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">30</span>:     
<span class="token number">31</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>start<span class="token punctuation">)</span>
<span class="token number">32</span>:        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">dequeue!</span> process-queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">33</span>:        
<span class="token number">34</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>pause<span class="token punctuation">)</span>
<span class="token number">35</span>:       <span class="token punctuation">(</span><span class="token builtin">call/cc</span>
<span class="token number">36</span>:        <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>k<span class="token punctuation">)</span>
<span class="token number">37</span>:          <span class="token punctuation">(</span><span class="token function">coroutine</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">k</span> <span class="token boolean">#f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">38</span>:          <span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">39</span>:     
<span class="token number">40</span>:     
<span class="token number">41</span>:     <span class="token comment" spellcheck="true">;;; example</span>
<span class="token number">42</span>:     <span class="token punctuation">(</span><span class="token function">coroutine</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">43</span>:              <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token number">44</span>:                <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> i <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token number">45</span>:                <span class="token punctuation">(</span><span class="token keyword">begin</span>
<span class="token number">46</span>:                  <span class="token punctuation">(</span><span class="token function">display</span> <span class="token punctuation">(</span><span class="token function">1+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token number">47</span>:                  <span class="token punctuation">(</span><span class="token function">display</span> <span class="token string">" "</span><span class="token punctuation">)</span> 
<span class="token number">48</span>:                  <span class="token punctuation">(</span>pause<span class="token punctuation">)</span> 
<span class="token number">49</span>:                  <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token function">1+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">50</span>:                
<span class="token number">51</span>:     <span class="token punctuation">(</span><span class="token function">coroutine</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">52</span>:              <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token number">53</span>:                <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> i <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token number">54</span>:                <span class="token punctuation">(</span><span class="token keyword">begin</span>
<span class="token number">55</span>:                  <span class="token punctuation">(</span><span class="token function">display</span> <span class="token punctuation">(</span><span class="token function">integer->char</span> <span class="token punctuation">(</span><span class="token operator">+</span> i <span class="token number">97</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">56</span>:                  <span class="token punctuation">(</span><span class="token function">display</span> <span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token number">57</span>:                  <span class="token punctuation">(</span>pause<span class="token punctuation">)</span> 
<span class="token number">58</span>:                  <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token function">1+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">59</span>:     
<span class="token number">60</span>:     <span class="token punctuation">(</span>newline<span class="token punctuation">)</span>
<span class="token number">61</span>:     <span class="token punctuation">(</span>start<span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">load</span> <span class="token string">"cor2.scm"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Loading "cor2.scm"</span>
<span class="token number">1</span> a <span class="token number">2</span> b <span class="token number">3</span> c <span class="token number">4</span> d <span class="token number">5</span> e <span class="token number">6</span> f <span class="token number">7</span> g <span class="token number">8</span> h <span class="token number">9</span> i <span class="token number">10</span> j  -- done
<span class="token comment" spellcheck="true">;Unspecified return value</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>本章中，我讲解了继续。</p><p>理解这些概念可能比较困难。但不要担心，有朝一日你终会明白。</p><p>下一章中，我将介绍惰性求值。</p><h2 id="惰性求值"><a href="#惰性求值" class="headerlink" title="惰性求值"></a>惰性求值</h2><h3 id="简介-11"><a href="#简介-11" class="headerlink" title="简介"></a>简介</h3><p>惰性求值（Lazy evaluation）是在需要时才进行求值的计算方式。惰性求值自然地在数据结构中包含递归，可以以简单的方式表示无限的概念，这种方式有利于程序的模块化。</p><p>你可以从<a href="http://deathking.github.io/yast-cn/contents/www.md.chalmers.se/~rjmh/Papers/whyfp.html">《Why Functional Programming Matters》</a>中知晓惰性计算可以带来哪些好处。</p><p><a href="http://deathking.github.io/yast-cn/contents/www.haskell.org">Haskell</a>语言以采用惰性求值而广为人熟知。Scheme也部分采用了惰性求值。</p><h3 id="用于惰性求值的函数"><a href="#用于惰性求值的函数" class="headerlink" title="用于惰性求值的函数"></a>用于惰性求值的函数</h3><p>下面这些用于处理惰性求值的函数是在R5RS中定义的。中间状态被称为延时对象（<code>promise</code>），它表示求值方法已经定义好了，但求值还未执行。最终的值通过对延时对象（<code>promise</code>）调用force被计算出来。</p><p><strong>(delay <code>proc</code>)</strong></p><p>以<code>proc</code>创建一个延时对象（<code>promise</code>）。</p><p><strong>(promise? <code>obj</code>)</strong></p><p>如果<code>obj</code>是一个延时对象就返回 #t。</p><p><strong>(force <code>promise</code>)</strong></p><p>对延时对象求值，执行求值操作。</p><h3 id="惰性求值的简单例子"><a href="#惰性求值的简单例子" class="headerlink" title="惰性求值的简单例子"></a>惰性求值的简单例子</h3><p>[例1]展示一个惰性求值的简单例子。在这个例子中，延时对象（<code>promise</code>）通过对(1 + 2)调用<code>delay</code>产生，然后通过函数<code>force</code>对延时对象求值。</p><p>[例1]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> laz <span class="token punctuation">(</span><span class="token keyword">delay</span> <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: laz</span>

laz
<span class="token comment" spellcheck="true">;Value 11: #[promise 11]</span>

<span class="token punctuation">(</span><span class="token function">promise?</span> laz<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: #t</span>

<span class="token punctuation">(</span><span class="token function">force</span> laz<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 3</span>

<span class="token punctuation">(</span><span class="token operator">*</span> <span class="token number">10</span> <span class="token punctuation">(</span><span class="token function">force</span> laz<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 30</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意延时对象并没有被<code>force</code>消费掉，这意味着函数<code>force</code>没有副作用。因此，你可以重复使用延时对象。</p><h3 id="使用惰性求值表示无限序列"><a href="#使用惰性求值表示无限序列" class="headerlink" title="使用惰性求值表示无限序列"></a>使用惰性求值表示无限序列</h3><p>现在，让我们使用惰性求值创建无限序列。首先，我将定义一些用于处理无限序列的基本函数。然后，我会使用这些函数创建无限序列，并将无限序列用于数值计算。</p><p>无限序列可以用如表达式（1）的cons单元（cons cell）的嵌套结构表示。cons单元的<code>car</code>和<code>cdr</code>分别是最终值和延时对象（promise）。另一个表达式（1）结构的cons单元通过强制求值<code>cdr</code>部分产生，你可以无限重复这个过程，就像图 1。这个和cons单元的嵌套结构和普通表类似，只是使用延时对象作为<code>cdr</code>部分使其可以表示无限序列。</p><pre><code>    (&lt;val&gt; . &lt;promise&gt;)    (1)</code></pre><p><img src="http://deathking.github.io/yast-cn/contents/figures/lazy_fig_1.png" alt="infiity sequence"></p><p>图 1. 无限序列的实现，使用了<code>car</code>和<code>cdr</code>分别为最终值和延时对象的cons单元。</p><h3 id="无限序列的基本函数和宏"><a href="#无限序列的基本函数和宏" class="headerlink" title="无限序列的基本函数和宏"></a>无限序列的基本函数和宏</h3><p>[代码 1]展示了无限序列的基本函数和宏。其中最重要的是<code>lazy-map</code>，被用于操作无限序列。</p><p>由于<code>lazy-map</code>包含一个特殊delay构造用于延迟求值，所以它需要被定义为宏。</p><p>[代码 1]</p><pre class="line-numbers language-scheme"><code class="language-scheme">01:     <span class="token comment" spellcheck="true">;;;;; basic functions and a macro</span>
<span class="token number">02</span>:     
<span class="token number">03</span>:     <span class="token comment" spellcheck="true">;;; car for lazy evaluation</span>
<span class="token number">04</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> lazy-car car<span class="token punctuation">)</span>
<span class="token number">05</span>:     
<span class="token number">06</span>:     <span class="token comment" spellcheck="true">;;; cdr for lazy evaluation</span>
<span class="token number">07</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">lazy-cdr</span> ls<span class="token punctuation">)</span>
<span class="token number">08</span>:       <span class="token punctuation">(</span><span class="token function">force</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">09</span>:     
<span class="token number">10</span>:     <span class="token comment" spellcheck="true">;;; lazy cons</span>
<span class="token number">11</span>:     <span class="token punctuation">(</span><span class="token keyword">define-syntax</span> lazy-cons
<span class="token number">12</span>:        <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">13</span>:           <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> a b<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">cons</span> a <span class="token punctuation">(</span><span class="token keyword">delay</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">14</span>:     
<span class="token number">15</span>:     <span class="token comment" spellcheck="true">;;; lazy map</span>
<span class="token number">16</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">lazy-map</span> fn . lss<span class="token punctuation">)</span>
<span class="token number">17</span>:       <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">memq</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span> lss<span class="token punctuation">)</span>
<span class="token number">18</span>:           <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">19</span>:         <span class="token punctuation">(</span><span class="token function">lazy-cons</span> <span class="token punctuation">(</span><span class="token builtin">apply</span> fn <span class="token punctuation">(</span><span class="token function">map</span> lazy-car lss<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">20</span>:                    <span class="token punctuation">(</span><span class="token builtin">apply</span> lazy-map fn <span class="token punctuation">(</span><span class="token function">map</span> lazy-cdr lss<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">21</span>:     
<span class="token number">22</span>:     <span class="token comment" spellcheck="true">;;; lazy filter</span>
<span class="token number">23</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">lazy-filter</span> pred ls<span class="token punctuation">)</span>
<span class="token number">24</span>:       <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">null?</span> ls<span class="token punctuation">)</span>
<span class="token number">25</span>:           <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">26</span>:         <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">obj</span> <span class="token punctuation">(</span><span class="token function">lazy-car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">27</span>:           <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pred</span> obj<span class="token punctuation">)</span>
<span class="token number">28</span>:               <span class="token punctuation">(</span><span class="token function">lazy-cons</span> obj  <span class="token punctuation">(</span><span class="token function">lazy-filter</span> pred <span class="token punctuation">(</span><span class="token function">lazy-cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">29</span>:             <span class="token punctuation">(</span><span class="token function">lazy-filter</span> pred <span class="token punctuation">(</span><span class="token function">lazy-cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">30</span>:     
<span class="token number">31</span>:     <span class="token comment" spellcheck="true">;;; returns n-th item of the lazy list</span>
<span class="token number">32</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">lazy-ref</span> ls n<span class="token punctuation">)</span>
<span class="token number">33</span>:       <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> n <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">34</span>:           <span class="token punctuation">(</span><span class="token function">lazy-car</span> ls<span class="token punctuation">)</span>
<span class="token number">35</span>:         <span class="token punctuation">(</span><span class="token function">lazy-ref</span> <span class="token punctuation">(</span><span class="token function">lazy-cdr</span> ls<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span> n <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">36</span>:     
<span class="token number">37</span>:     <span class="token comment" spellcheck="true">;;; returns first n items of the ls</span>
<span class="token number">38</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">head</span> ls n<span class="token punctuation">)</span>
<span class="token number">39</span>:       <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> n <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">40</span>:           <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">41</span>:          <span class="token punctuation">(</span><span class="token builtin">cons</span> <span class="token punctuation">(</span><span class="token function">lazy-car</span> ls<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">head</span> <span class="token punctuation">(</span><span class="token function">lazy-cdr</span> ls<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span> n <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>(lazy-car ls)</strong></p><p>和<code>(car ls)</code>一样，因为<code>car</code>部分是最终值。</p><p><strong>(lazy-cdr ls)</strong></p><p>计算<code>ls</code>的<code>cdr</code>部分（延时对象）的‘最终’值。</p><p><strong>(lazy-cons a b)</strong></p><p>这是一个扩展了<code>(cons a (delay b))</code>的宏。如果这个操作被定义为一个函数，<code>b</code>将立刻求值，这样delay就没有任何意义了。</p><p><strong>(lazy-map fn . lss)</strong></p><p>这是一个惰性求值的<code>map</code>函数，是在[代码 1]中最重要的函数。注意它返回一个包含最终值（<code>car</code>部分）和延时对象（<code>cdr</code>部分）的cons单元。</p><p><strong>(lazy-filter pred ls)</strong></p><p>这是一个惰性求值的<code>filter</code>函数。它过滤<code>ls</code>并返回一个由包含满足<code>pred</code>条件的元素组成的‘无限序列’。</p><p><strong>(lazy-ref ls n)</strong></p><p>返回‘无限序列’<code>ls</code>的第n个元素。</p><p><strong>(head ls n)</strong></p><p>返回<code>ls</code>（惰性求值表）的前n个元素。</p><h3 id="无限序列"><a href="#无限序列" class="headerlink" title="无限序列"></a>无限序列</h3><p>无限序列可以简洁地用<code>lazy-cons</code>和<code>lazy-map</code>表示。我会展示两个例子：</p><ul><li>下一项由前一项定义的序列，如等差数列和等比数列。</li><li>菲波那契数列。</li></ul><h4 id="下一个项由前一项定义的序列"><a href="#下一个项由前一项定义的序列" class="headerlink" title="下一个项由前一项定义的序列"></a>下一个项由前一项定义的序列</h4><p>下一个项由前一项定义的序列可以有如下形式的函数（f）定义：</p><p>[{a}_{i+1} = f({a}_i) ]</p><p>可以表示为[代码2]里的<code>(inf-seq a0 f)</code>，<code>a0</code>和<code>f</code>分别是初始项和用于计算随后项的函数。</p><p><code>(inf-seq a0 f)</code>是递归定义的，它的定义清晰表明初始项是a0，第二项是<code>(f a0)</code>，<code>(n+1)</code>项由<code>(f an)</code>表示。</p><p>等差和等比数列分别被定义为<code>(ari a0 d)</code>和<code>(geo a0 r)</code>，其中<code>a0</code>，<code>d</code>和<code>r</code>分别是初始值，公差，公比。这些函数使用函数<code>inf-seq</code>定义。</p><p>[代码2]</p><pre class="line-numbers language-scheme"><code class="language-scheme">01:     <span class="token comment" spellcheck="true">;;;;  sequences</span>
<span class="token number">02</span>:     
<span class="token number">03</span>:     <span class="token comment" spellcheck="true">;;; infinite sequences represented by a_(n+1) = f(a_n)</span>
<span class="token number">04</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">inf-seq</span> a0 f<span class="token punctuation">)</span>
<span class="token number">05</span>:       <span class="token punctuation">(</span><span class="token function">lazy-cons</span> a0 <span class="token punctuation">(</span><span class="token function">inf-seq</span> <span class="token punctuation">(</span><span class="token function">f</span> a0<span class="token punctuation">)</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">06</span>:     
<span class="token number">07</span>:     <span class="token comment" spellcheck="true">;;; arithmetic sequence</span>
<span class="token number">08</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">ari</span> a0 d<span class="token punctuation">)</span>
<span class="token number">09</span>:       <span class="token punctuation">(</span><span class="token function">inf-seq</span> a0 <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">+</span> x d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">10</span>:     
<span class="token number">11</span>:     <span class="token comment" spellcheck="true">;;; geometric sequence</span>
<span class="token number">12</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">geo</span> a0 r<span class="token punctuation">)</span>
<span class="token number">13</span>:       <span class="token punctuation">(</span><span class="token function">inf-seq</span> a0 <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span> x r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>让我们检查一下<code>inf-seq</code>所产生的无限序列（例2）。创建两个等比数列：</p><ol><li><code>g1</code>，初始值1，公比为2。</li><li><code>g2</code>，初始值1，公比为1/2。</li></ol><p>然后使用<code>head</code>求值前10项。你将看到正确产生了两个等比数列。</p><p>接下来，使用<code>lazy-map</code>计算<code>g1</code>和<code>g2</code>的乘积，并使用<code>head</code>求值前10项。你将看到一个全是1的序列，这表明计算被正确地执行了。</p><p>现在，让我们用等差数列和<code>lazy-filter</code>娱乐一番。首先，用<code>(ari 1 1)</code>创建一个等比数列<code>ar1</code>。<code>(head ar1 10)</code>的结果显示等比数列 <code>(1 2 3 ....)</code> 是由 <code>(ari 1 1)</code> 产生的。然后使用<code>lazy-filter</code>取出<code>ar1</code>里的偶数，并使用<code>head</code>求值前10项。你将看到<code>(2 4 6 8 10 12 14 16 18 20)</code>，这表明<code>lazy-filter</code>正常工作。</p><p>[例2]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> g1 <span class="token punctuation">(</span><span class="token function">geo</span> <span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: g1</span>

<span class="token punctuation">(</span><span class="token keyword">define</span> g2 <span class="token punctuation">(</span><span class="token function">geo</span> <span class="token number">1</span> <span class="token punctuation">(</span><span class="token operator">/</span> <span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: g2</span>

<span class="token punctuation">(</span><span class="token function">head</span> g1 <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 12: (1 2 4 8 16 32 64 128 256 512)</span>

<span class="token punctuation">(</span><span class="token function">head</span> g2 <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 13: (1 1/2 1/4 1/8 1/16 1/32 1/64 1/128 1/256 1/512)</span>

<span class="token punctuation">(</span><span class="token function">head</span> <span class="token punctuation">(</span><span class="token function">lazy-map</span> * g1 g2<span class="token punctuation">)</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 14: (1 1 1 1 1 1 1 1 1 1)</span>

<span class="token punctuation">(</span><span class="token keyword">define</span> ar1 <span class="token punctuation">(</span><span class="token function">ari</span> <span class="token number">1</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;;Value: ar1</span>

<span class="token punctuation">(</span><span class="token function">head</span> ar1 <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;;Value 15: (1 2 3 4 5 6 7 8 9 10)</span>

<span class="token punctuation">(</span><span class="token function">head</span> <span class="token punctuation">(</span><span class="token function">lazy-filter</span> even? ar1<span class="token punctuation">)</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;;Value 16: (2 4 6 8 10 12 14 16 18 20)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="菲波那切数列"><a href="#菲波那切数列" class="headerlink" title="菲波那切数列"></a>菲波那切数列</h4><p>菲波那切数列定义如下：</p><pre><code>fib(1) = 1
fib(2) = 1
fib(n+1) = fib(n) + fib(n-1)</code></pre><p>代码3展示了Scheme实现的菲波那切数列，用到了<code>lazy-cons</code>和<code>lazy-map</code>。如代码所示，Scheme里的定义和数学上的定义很相似。此外，各个项的计算的复杂度为<em>O(n)</em>。</p><p>[例3]中，值被立刻计算出来了。</p><p>[代码 3]</p><pre class="line-numbers language-scheme"><code class="language-scheme">01:     <span class="token punctuation">(</span><span class="token keyword">define</span> fib
<span class="token number">02</span>:       <span class="token punctuation">(</span><span class="token function">lazy-cons</span> <span class="token number">1</span>
<span class="token number">03</span>:                  <span class="token punctuation">(</span><span class="token function">lazy-cons</span> <span class="token number">1</span>
<span class="token number">04</span>:                             <span class="token punctuation">(</span><span class="token function">lazy-map</span> + fib <span class="token punctuation">(</span><span class="token function">lazy-cdr</span> fib<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>[例 3]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token function">head</span> fib <span class="token number">20</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 12: (1 1 2 3 5 8 13 21 34 55 89 144 233 377 610 987 1597 2584 4181 6765)</span>

<span class="token punctuation">(</span><span class="token function">lazy-ref</span> fib <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 573147844013817084101</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="将惰性求值用于数值计算"><a href="#将惰性求值用于数值计算" class="headerlink" title="将惰性求值用于数值计算"></a>将惰性求值用于数值计算</h3><p>下面是<a href="http://deathking.github.io/yast-cn/contents/www.md.chalmers.se/~rjmh/Papers/whyfp.html">《Why Functional Programming Matters》</a>里相关代码的Schme版本。也可以查看<a href="http://mitpress.mit.edu/sicp/full-text/book/book-Z-H-24.html#%_sec_3.5">SICP 3.5. Stream</a>惰性计算在数值计算中的应用。</p><h4 id="牛顿-拉夫逊法求平方根"><a href="#牛顿-拉夫逊法求平方根" class="headerlink" title="牛顿-拉夫逊法求平方根"></a>牛顿-拉夫逊法求平方根</h4><p>牛顿-拉夫逊法可以使用初始值a0和等式（2）计算N的平方根。</p><pre><code>     a(n+1) =  (a(n) + N/a(n)) / 2                   (2)</code></pre><p>如果等式（2）收敛到最终值 a，</p><pre><code>      a =  (a +  N/a) / 2
⇒
      2a = a +  N/a
      a =  N/a
      a*a = N
      a =  √N</code></pre><p>，这表明最终值a是N的平方根。序列的下一项是前一项的函数（如等式（2）所示），这些序列可用<code>inf-seq</code>表示。</p><p>代码4展示了一个计算平方根的程序。在代码4中，初始值被定为1，由于序列收敛很快，所以这没问题。</p><p>[代码4]</p><pre class="line-numbers language-scheme"><code class="language-scheme">01:     <span class="token comment" spellcheck="true">;;; Newton-Raphson method</span>
<span class="token number">02</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">newton-raphson</span> n<span class="token punctuation">)</span>
<span class="token number">03</span>:       <span class="token punctuation">(</span><span class="token function">inf-seq</span> <span class="token number">1</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">/</span> <span class="token punctuation">(</span><span class="token operator">+</span> x <span class="token punctuation">(</span><span class="token operator">/</span> n x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">04</span>:     
<span class="token number">05</span>:     <span class="token comment" spellcheck="true">;;; returning a reasonable answer.</span>
<span class="token number">06</span>:     <span class="token comment" spellcheck="true">;;; If the ratio of successive terms is in (1 - eps) and (1 + eps),</span>
<span class="token number">07</span>:     <span class="token comment" spellcheck="true">;;; or the following term is zero,</span>
<span class="token number">08</span>:     <span class="token comment" spellcheck="true">;;; the function returns it.</span>
<span class="token number">09</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">lazylist->answer</span> ls eps<span class="token punctuation">)</span>
<span class="token number">10</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">e1</span> <span class="token punctuation">(</span><span class="token operator">-</span> <span class="token number">1.0</span> eps<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">11</span>:             <span class="token punctuation">(</span><span class="token function">e2</span> <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token number">1.0</span> eps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">12</span>:         <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">val</span> <span class="token punctuation">(</span><span class="token function">lazy-car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">13</span>:                    <span class="token punctuation">(</span><span class="token function">ls1</span> <span class="token punctuation">(</span><span class="token function">lazy-cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">14</span>:           <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">val2</span> <span class="token punctuation">(</span><span class="token function">lazy-car</span> ls1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">15</span>:             <span class="token punctuation">(</span><span class="token keyword">if</span>  <span class="token punctuation">(</span><span class="token function">or</span> <span class="token punctuation">(</span><span class="token function">zero?</span> val2<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> e1 <span class="token punctuation">(</span><span class="token operator">/</span> val val2<span class="token punctuation">)</span> e2<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">16</span>:                 <span class="token punctuation">(</span><span class="token function">exact->inexact</span> val2<span class="token punctuation">)</span>
<span class="token number">17</span>:               <span class="token punctuation">(</span><span class="token function">loop</span> val2 <span class="token punctuation">(</span><span class="token function">lazy-cdr</span> ls1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">18</span>:     
<span class="token number">19</span>:     <span class="token comment" spellcheck="true">;;;</span>
<span class="token number">20</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">my-sqrt</span> n eps<span class="token punctuation">)</span>
<span class="token number">21</span>:       <span class="token punctuation">(</span><span class="token function">lazylist->answer</span> <span class="token punctuation">(</span><span class="token function">newton-raphson</span> n<span class="token punctuation">)</span> eps<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>(newton-raphson n)</strong></p><p>一个函数，创建平方根近似值的表。</p><p><strong>(lazylist-&gt;answer ls eps)</strong></p><p>检查收敛是否满足条件了。如果是的，返回数值计算的结果。</p><p>如果<code>(1 - eps) &lt; t2/t1 &lt; (1 + eps)</code> 或者 <code>t2 = 0</code>，函数返回 <code>ls</code> 的后续项（即 <code>t1</code> 和 <code>t2</code>）的第二项。</p><p><strong>(my-sqrt n eps)</strong></p><p>在相对误差eps下，计算n的平方根。</p><pre><code>(my-sqrt 9 0.0000001)
;Value: 3.</code></pre><h4 id="数值微分"><a href="#数值微分" class="headerlink" title="数值微分"></a>数值微分</h4><p>[代码5]中的<code>easydiff</code>是一种计算数字积分的简单方式，其中<code>f</code>，<code>x</code>，和<code>h</code>分别是被积分的函数，x值，和Δx。理论上，如果<code>h</code>越趋于0，获得的近似值越好。但在实践中，由于数值在计算机里的精度是有限的，微小的<code>h</code>值会导致错误。</p><p>为了解决这个问题，我们用<code>lazylist-diff</code>创建<code>h</code>的惰性表。这个惰性表是初始值为<code>h0</code>，公比为0.5的等比数列。然后我们创建一个对应于<code>h</code>的惰性表的近似值的惰性表。</p><p>可以通过如下代码加快收敛速度，更快得到答案：</p><pre><code>(lazylist-&gt;answer (lazylist-diff h0 f x) eps)</code></pre><p>函数<code>super</code>是收敛加速函数。可以查看<a href="http://deathking.github.io/yast-cn/contents/www.md.chalmers.se/~rjmh/Papers/whyfp.html">《Why Functional Programming Matters》</a>的关于加速技术部分。如果你使用了传统编程语言，加速计算会相当复杂。相反，使用惰性求值可以以简单的方式实现。此外，因为高度的模块化，你可以在其他问题中复用代码，例如数值积分（4.3.3节）。代码6复用了代码5中的加速函数。</p><p>[代码5]</p><pre class="line-numbers language-scheme"><code class="language-scheme">01:     <span class="token comment" spellcheck="true">;;; differentiation</span>
<span class="token number">02</span>:     
<span class="token number">03</span>:     <span class="token comment" spellcheck="true">;;; primitive function for differentiation</span>
<span class="token number">04</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">easydiff</span> f x h<span class="token punctuation">)</span>
<span class="token number">05</span>:       <span class="token punctuation">(</span><span class="token operator">/</span> <span class="token punctuation">(</span><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token function">f</span> <span class="token punctuation">(</span><span class="token operator">+</span> x h<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">f</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">06</span>:     
<span class="token number">07</span>:     <span class="token comment" spellcheck="true">;;; create a lazy list of approximation for differentiation</span>
<span class="token number">08</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">lazylist-diff</span> h0 f x<span class="token punctuation">)</span>
<span class="token number">09</span>:       <span class="token punctuation">(</span><span class="token function">lazy-map</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>h<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">easydiff</span> f x h<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">geo</span> h0 <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">10</span>:     
<span class="token number">11</span>:     <span class="token comment" spellcheck="true">;;; eliminate error from the approximation</span>
<span class="token number">12</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">elimerror</span> n ls<span class="token punctuation">)</span>
<span class="token number">13</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">a</span> <span class="token punctuation">(</span><span class="token function">lazy-car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">14</span>:             <span class="token punctuation">(</span><span class="token function">b</span> <span class="token punctuation">(</span><span class="token function">lazy-second</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">15</span>:             <span class="token punctuation">(</span><span class="token function">c</span> <span class="token punctuation">(</span><span class="token function">fix:lsh</span> <span class="token number">1</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">; (expt 2 n)</span>
<span class="token number">16</span>:         <span class="token punctuation">(</span><span class="token function">lazy-cons</span>
<span class="token number">17</span>:          <span class="token punctuation">(</span><span class="token operator">/</span> <span class="token punctuation">(</span><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token operator">*</span> b c<span class="token punctuation">)</span> a<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span> c <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">18</span>:          <span class="token punctuation">(</span><span class="token function">elimerror</span> n <span class="token punctuation">(</span><span class="token function">lazy-cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">19</span>:     
<span class="token number">20</span>:     <span class="token comment" spellcheck="true">;;; estimate `n' in elimerror</span>
<span class="token number">21</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">order</span> ls<span class="token punctuation">)</span>
<span class="token number">22</span>:       <span class="token punctuation">(</span><span class="token keyword">let*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">a</span> <span class="token punctuation">(</span><span class="token function">lazy-car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">23</span>:              <span class="token punctuation">(</span><span class="token function">b</span> <span class="token punctuation">(</span><span class="token function">lazy-second</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">24</span>:              <span class="token punctuation">(</span><span class="token function">c</span> <span class="token punctuation">(</span><span class="token function">lazy-ref</span> ls <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">25</span>:              <span class="token punctuation">(</span><span class="token function">d</span> <span class="token punctuation">(</span><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token operator">/</span> <span class="token punctuation">(</span><span class="token operator">-</span> a c<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span> b c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">26</span>:         <span class="token punctuation">(</span><span class="token keyword">cond</span>
<span class="token number">27</span>:          <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span> d <span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">28</span>:          <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;=</span> <span class="token number">2</span> d <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">inexact->exact</span> <span class="token punctuation">(</span><span class="token function">round</span> <span class="token punctuation">(</span><span class="token function">log2</span> d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">29</span>:          <span class="token punctuation">(</span><span class="token keyword">else</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">30</span>:     
<span class="token number">31</span>:     <span class="token comment" spellcheck="true">;;;</span>
<span class="token number">32</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">log2</span> x<span class="token punctuation">)</span>
<span class="token number">33</span>:       <span class="token punctuation">(</span><span class="token operator">/</span> <span class="token punctuation">(</span><span class="token function">log</span> x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">log</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">34</span>:     
<span class="token number">35</span>:     <span class="token comment" spellcheck="true">;;; improve convergence of the lazy list of the approximation</span>
<span class="token number">36</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">improve</span> ls<span class="token punctuation">)</span>
<span class="token number">37</span>:       <span class="token punctuation">(</span><span class="token function">elimerror</span> <span class="token punctuation">(</span><span class="token function">order</span> ls<span class="token punctuation">)</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">38</span>:     
<span class="token number">39</span>:     <span class="token comment" spellcheck="true">;;; return the second value of the lazy list</span>
<span class="token number">40</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">lazy-second</span> ls<span class="token punctuation">)</span>
<span class="token number">41</span>:       <span class="token punctuation">(</span><span class="token function">lazy-car</span> <span class="token punctuation">(</span><span class="token function">lazy-cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">42</span>:     
<span class="token number">43</span>:     <span class="token comment" spellcheck="true">;;; further improve the convergence of the list</span>
<span class="token number">44</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">super</span> ls<span class="token punctuation">)</span>
<span class="token number">45</span>:       <span class="token punctuation">(</span><span class="token function">lazy-map</span> lazy-second <span class="token punctuation">(</span><span class="token function">inf-seq</span> ls improve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">46</span>:                 
<span class="token number">47</span>:     
<span class="token number">48</span>:     <span class="token comment" spellcheck="true">;;; calculate the differentiation of function `f' at x within error eps</span>
<span class="token number">49</span>:     <span class="token comment" spellcheck="true">;;; h0 is initial window width</span>
<span class="token number">50</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">diff</span> f x h0 eps<span class="token punctuation">)</span>
<span class="token number">51</span>:       <span class="token punctuation">(</span><span class="token function">lazylist->answer</span> <span class="token punctuation">(</span><span class="token function">super</span> <span class="token punctuation">(</span><span class="token function">lazylist-diff</span> h0 f x<span class="token punctuation">)</span><span class="token punctuation">)</span> eps<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token function">diff</span> sin <span class="token number">0.0</span> <span class="token number">0.1</span> <span class="token number">0.0000001</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: .9999999999999516</span>

<span class="token punctuation">(</span><span class="token function">diff</span> exp <span class="token number">0.0</span> <span class="token number">0.1</span> <span class="token number">0.000001</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: .9999999991733471</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="数值积分"><a href="#数值积分" class="headerlink" title="数值积分"></a>数值积分</h4><p>收敛加速函数无需任何修改即可被用于数值积分。最开始，我们使用<code>easyintegrate</code>创建一个粗略的近似。函数<code>lazylist-integrate</code>使用惰性表，通过递归地调用<code>easyintegrate</code>在中间点切分区间，来改进近似值。函数可以用lazy-map以简单的方式定义。最终，收敛被加速，收敛值由函数<code>integrate</code>返回。</p><p>[代码6]</p><pre class="line-numbers language-scheme"><code class="language-scheme">01:     <span class="token comment" spellcheck="true">;;; integration</span>
<span class="token number">02</span>:     
<span class="token number">03</span>:     <span class="token comment" spellcheck="true">;;; primitive integration</span>
<span class="token number">04</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">easyintegrate</span> f a b<span class="token punctuation">)</span>
<span class="token number">05</span>:       <span class="token punctuation">(</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">/</span> <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">f</span> a<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">f</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span> b a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">06</span>:     
<span class="token number">07</span>:     <span class="token comment" spellcheck="true">;;; create the lazy list of approximation for integration</span>
<span class="token number">08</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">lazylist-integrate</span> f a b<span class="token punctuation">)</span>
<span class="token number">09</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">mid</span> <span class="token punctuation">(</span><span class="token operator">/</span> <span class="token punctuation">(</span><span class="token operator">+</span> a b<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">10</span>:         <span class="token punctuation">(</span><span class="token function">lazy-cons</span> <span class="token punctuation">(</span><span class="token function">easyintegrate</span> f a b<span class="token punctuation">)</span>
<span class="token number">11</span>:                    <span class="token punctuation">(</span><span class="token function">lazy-map</span> + <span class="token punctuation">(</span><span class="token function">lazylist-integrate</span> f a mid<span class="token punctuation">)</span>
<span class="token number">12</span>:                                <span class="token punctuation">(</span><span class="token function">lazylist-integrate</span> f mid b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">13</span>:     
<span class="token number">14</span>:     <span class="token comment" spellcheck="true">;;; integrate function `f' in a range of `a' and `b' within error `eps'</span>
<span class="token number">15</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">integrate</span> f a b eps<span class="token punctuation">)</span>
<span class="token number">16</span>:       <span class="token punctuation">(</span><span class="token function">lazylist->answer</span> <span class="token punctuation">(</span><span class="token function">super</span> <span class="token punctuation">(</span><span class="token function">lazylist-integrate</span> f a b<span class="token punctuation">)</span><span class="token punctuation">)</span> eps<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> pi <span class="token punctuation">(</span><span class="token operator">*</span> <span class="token number">4</span> <span class="token punctuation">(</span><span class="token function">atan</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: pi</span>

<span class="token punctuation">(</span><span class="token function">integrate</span> sin <span class="token number">0</span> pi <span class="token number">0.0000001</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 2.000000002272428</span>

<span class="token punctuation">(</span><span class="token function">integrate</span> exp <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0.0000001</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 1.7182818277724858</span>

<span class="token punctuation">(</span><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token function">exp</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 1.718281828459045</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h3><p>惰性求值允许我们以简洁的方式将重复包含在数据结构中。这个功能有利于程序的模块化，可使代码更为紧凑。</p><p>查看网页<a href="http://www.haskell.org/haskellwiki/Haskell">Haskell</a>可以了解更多关于惰性求值的内容。</p><p>你可以在<a href="http://www.shido.info/lisp/scheme_lazy.zip">这儿</a>下载本页中出现代码。</p><h2 id="非确定性"><a href="#非确定性" class="headerlink" title="非确定性"></a>非确定性</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>非确定性是一种通过仅定义问题来解决问题的算法。非确定性程序自动选择符合条件的选项。这项技术很适合逻辑编程。</p><p>例如，以下代码返回一对数，其和是一个质数。其中一个数从<code>&#39;(4 6 7)</code>选取，另一个从<code>&#39;(5 8 11)</code>选取。</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token punctuation">(</span><span class="token function">amb</span> <span class="token number">4</span> <span class="token number">6</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token function">j</span> <span class="token punctuation">(</span><span class="token function">amb</span> <span class="token number">5</span> <span class="token number">8</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">prime?</span> <span class="token punctuation">(</span><span class="token operator">+</span> i j<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token builtin">list</span> i j<span class="token punctuation">)</span>
      <span class="token punctuation">(</span>amb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 23: (6 5)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>(amb 4 6 7)</code> 从4，6和7中返回一个合适的数，<code>(amb 5 8 11)</code>从5，8和11中返回一个合适的数。如果没有选出合适的值，(amb)返回假。</p><p>实际上，amb做了深度优先搜索。<code>(amb c1 c2 c3 ...)</code>创建了搜索路径依次检查<code>c1</code>，<code>c2</code>，<code>c3</code>，…并回溯。因此，非确定性是一种帮程序隐藏搜索的抽象。一旦我们有了amb，我们可以很容易地编写程序而无需思考计算机做了什么。</p><h3 id="非确定性的实现"><a href="#非确定性的实现" class="headerlink" title="非确定性的实现"></a>非确定性的实现</h3><p>使用在非确定性中的回溯被实现为连接到继续（continuation）的闭包链。这个链被一个全局参数<code>fail</code>表示，该参数是一个复写自己的函数。</p><h4 id="函数实现"><a href="#函数实现" class="headerlink" title="函数实现"></a>函数实现</h4><p>第一步，我使用函数（名为<code>choose</code>）实现非确定性，演示于[代码1]。我首先定义一个全局参数<code>fail</code>，它的初始值是一个将返回<code>no-choice</code>到顶层的函数（22-26行）。然后通过在函数choose中重新定义<code>fail</code>实现闭包链。回溯通过调用之前的<code>fail</code>实现。</p><p>函数<code>choose</code>有如下行为：</p><ol><li>如果没有选项，调用(fail)。</li><li>如果有任何选项，<ol><li>将fail储存为fail0，并调用当前继续（continuation）。</li><li>在继续（continuation）中重新定义fail。fail重新被赋值回存在fail0里的原值，并对余下的选项应用（apply）choose。</li><li>返回第一个选项到继续（continuation）外面。</li></ol></li></ol><p>[代码1]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token comment" spellcheck="true">;;; abbreviation for call-with-current-continuation</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> call/cc call-with-current-continuation<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">;;; This function is re-assigned in `choose` and `fail` itself.</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> fail <span class="token boolean">#f</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">;;; function for nondeterminism</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">choose</span> . ls<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">null?</span> ls<span class="token punctuation">)</span> 
    <span class="token punctuation">(</span>fail<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">fail0</span> fail<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token builtin">call/cc</span>
        <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>cc<span class="token punctuation">)</span>
          <span class="token punctuation">(</span><span class="token keyword">set!</span> fail <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
                       <span class="token punctuation">(</span><span class="token keyword">set!</span> fail fail0<span class="token punctuation">)</span>
                       <span class="token punctuation">(</span><span class="token function">cc</span> <span class="token punctuation">(</span><span class="token builtin">apply</span> choose <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">(</span><span class="token function">cc</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">;;; write following at the end of file</span>
<span class="token comment" spellcheck="true">;;; initial value for fail</span>
<span class="token punctuation">(</span><span class="token builtin">call/cc</span> 
  <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>cc<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">set!</span> fail <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
                 <span class="token punctuation">(</span><span class="token function">cc</span> <span class="token string">'no-choice)))))</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>让我们看看<code>choose</code>是否可以找到毕达哥拉斯三元组。函数<code>pythag</code>用于寻找三元组。如果找到了，它返回一个表。如果没有找到，调用无参数的<code>choose</code>，以回溯。</p><p>[例1]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">sq</span> x<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token operator">*</span> x x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: sq</span>

<span class="token comment" spellcheck="true">;;; Pythagorean triples</span>
<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">pythag</span> a b c<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">sq</span> a<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">sq</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">sq</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token builtin">list</span> a b c<span class="token punctuation">)</span>
      <span class="token punctuation">(</span>choose<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: pythag</span>

<span class="token punctuation">(</span><span class="token function">pythag</span> <span class="token punctuation">(</span><span class="token function">choose</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">choose</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">choose</span>  <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 16: (3 4 5)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="宏实现"><a href="#宏实现" class="headerlink" title="宏实现"></a>宏实现</h4><p>为了对S-表达式使用非确定性操作，必须把操作定义为宏。例如，[例2]中所示函数<code>an-integer-starting-from</code>应该返回一个大于或等于<code>n</code>的整数，但是如果<code>choose</code>被以函数形式定义，它将不能正常工作，因为参数会立即求值。</p><p>[例2]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">an-integer-starting-from</span> n<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">choose</span> n <span class="token punctuation">(</span><span class="token function">an-integer-starting-from</span> <span class="token punctuation">(</span><span class="token function">1+</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: an-integer-starting-from</span>

<span class="token punctuation">(</span><span class="token function">an-integer-starting-from</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Aborting!: maximum recursion depth exceeded</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了解决这一点，我们定义了一个和[代码1]中定义一致但使用非确定性宏<code>amb</code>实现的<code>choose</code>。这个宏<code>amb</code>有和<code>choose</code>一样的递归调用自己的结构。</p><p>[代码1]中的1-5行和20-26行在下面的代码中得以重用。</p><p>[代码2]使用MIT-Scheme编译时，编译器给出如下警告：</p><pre><code>;Warning: Possible inapplicable operator ()</code></pre><p>但是代码可以正常工作。这些代码在<a href="http://www.scheme.com/petitechezscheme.html">Petite Chez Scheme</a>下也可以运行。即使我没有试过其他Scheme实现，我认为<code>amb</code>的定义可以工作，只要它们遵守R5RS。你可以在<a href="http://www.shido.info/lisp/scheme_amb.zip">这里</a>下载一个为MIT-Scheme做的专门实现。MIT-Scheme编译器不会对这个专门实现提出警告。</p><p>[代码2]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token comment" spellcheck="true">;;; nondeterminism macro operator</span>
<span class="token punctuation">(</span><span class="token keyword">define-syntax</span> amb
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token punctuation">(</span>fail<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> a<span class="token punctuation">)</span> a<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> a b ...<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">fail0</span> fail<span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token builtin">call/cc</span>
    <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span>cc<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">set!</span> fail
        <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">(</span><span class="token keyword">set!</span> fail fail0<span class="token punctuation">)</span>
          <span class="token punctuation">(</span><span class="token function">cc</span> <span class="token punctuation">(</span><span class="token function">amb</span> b ...<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token function">cc</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>宏定义，<code>amb</code>，在参数为S-表达式时也和其他值一样正常工作。</p><p>[例3]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">an-integer-starting-from</span> n<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">amb</span> n <span class="token punctuation">(</span><span class="token function">an-integer-starting-from</span> <span class="token punctuation">(</span><span class="token function">1+</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: an-integer-starting-from</span>

<span class="token punctuation">(</span><span class="token function">an-integer-starting-from</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 1</span>

<span class="token punctuation">(</span>amb<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 2</span>

<span class="token punctuation">(</span>amb<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在<a href="http://www.ccs.neu.edu/home/dorai/t-y-scheme/t-y-scheme-Z-H-16.html#node_sec_14.2">Teach Yourself Scheme in Fixnum Days</a> 和<a href="http://www.ccs.neu.edu/home/dherman/code/amb.ss">Dave Hername Code</a>中的amb实现使用<code>&#39;,@(map ...)&#39;</code>展开参数。即使它们是直截了当的定义，但由于使用了两次<code>call/cc</code>，它们某种程度上仍很复杂。[代码2]所示的递归定义更简单，即使展开的S-表达式会很复杂。</p><h4 id="应用于逻辑编程，使程序更简洁"><a href="#应用于逻辑编程，使程序更简洁" class="headerlink" title="应用于逻辑编程，使程序更简洁"></a>应用于逻辑编程，使程序更简洁</h4><p>[代码3]演示了非确定性应用逻辑编程，使得程序更简洁</p><p>[代码3]</p><pre class="line-numbers language-scheme"><code class="language-scheme">01:     <span class="token comment" spellcheck="true">;;; returning all possibilities</span>
<span class="token number">02</span>:     <span class="token punctuation">(</span><span class="token keyword">define-syntax</span> set-of
<span class="token number">03</span>:       <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token number">04</span>:         <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> s<span class="token punctuation">)</span> 
<span class="token number">05</span>:           <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">acc</span> <span class="token string">'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token number">06</span>:             <span class="token punctuation">(</span><span class="token function">amb</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">v</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token number">07</span>:                    <span class="token punctuation">(</span><span class="token keyword">set!</span> acc <span class="token punctuation">(</span><span class="token builtin">cons</span> v acc<span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token number">08</span>:                    <span class="token punctuation">(</span>fail<span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token number">09</span>:                  <span class="token punctuation">(</span><span class="token function">reverse!</span> acc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">10</span>:     
<span class="token number">11</span>:     <span class="token comment" spellcheck="true">;;; if not pred backtrack</span>
<span class="token number">12</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">assert</span> pred<span class="token punctuation">)</span>
<span class="token number">13</span>:       <span class="token punctuation">(</span><span class="token function">or</span> pred <span class="token punctuation">(</span>amb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">14</span>:     
<span class="token number">15</span>:     <span class="token comment" spellcheck="true">;;; returns arbitrary number larger or equal to n</span>
<span class="token number">16</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">an-integer-starting-from</span> n<span class="token punctuation">)</span>
<span class="token number">17</span>:       <span class="token punctuation">(</span><span class="token function">amb</span> n <span class="token punctuation">(</span><span class="token function">an-integer-starting-from</span> <span class="token punctuation">(</span><span class="token function">1+</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">18</span>:     
<span class="token number">19</span>:     <span class="token comment" spellcheck="true">;;; returns arbitrary number between a and b</span>
<span class="token number">20</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">number-between</span> a b<span class="token punctuation">)</span>
<span class="token number">21</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">22</span>:         <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">></span> i b<span class="token punctuation">)</span>
<span class="token number">23</span>:             <span class="token punctuation">(</span>amb<span class="token punctuation">)</span>
<span class="token number">24</span>:           <span class="token punctuation">(</span><span class="token function">amb</span> i <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token function">1+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>(set-of <code>s</code>)</strong></p><p>返回满足<code>s</code>的所有可能性。宏的行为如下：</p><ol><li>（第5行）一个表（acc）被定义，它有所欲哦满足<code>s</code>的结果。</li><li>（第6行）<code>s</code>的结果被赋给<code>v</code>，并加入到<code>acc</code>。如果结果没有带上<code>v</code>而直接被加入（如 (set! acc (cons s acc))），则会因为<code>s</code>使用了继续（continuation）而只在acc中存储了最后一个值。<code>s</code>改了了fail的值。</li><li>（第7，8行）在这之后，调用fail回溯。因为使用了继续（continuation），函数fail行为就像在第6行被调用。</li><li>（第9行）当所有可能的选项被找到时，调用<code>(reverse! acc)</code>并返回所有的可能选项。</li></ol><p>定义假设amb从最左边参数开始搜索。</p><p><strong>(assert <code>pred</code>)</strong></p><p>如果谓词为假,就回溯。</p><p><strong>(an-integer-starting-from <code>n</code>)</strong></p><p>非确定性地返回从<code>n</code>开始的整数。</p><p><strong>(number-between <code>a</code> <code>b</code>)</strong></p><p>非确定性地返回<code>a</code>和<code>b</code>之间的整数</p><p>[例4]演示了如何使用<code>set-of</code>。得到了所有小于20的质数。</p><p>[例4]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">prime?</span> n<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">m</span> <span class="token punctuation">(</span><span class="token function">sqrt</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token function">or</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span> m i<span class="token punctuation">)</span>
          <span class="token punctuation">(</span><span class="token function">and</span> <span class="token punctuation">(</span><span class="token function">not</span> <span class="token punctuation">(</span><span class="token function">zero?</span> <span class="token punctuation">(</span><span class="token function">modulo</span> n i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token operator">+</span> i <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">=</span> i <span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">gen-prime</span> n<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">i</span> <span class="token punctuation">(</span><span class="token function">number-between</span>  <span class="token number">2</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">prime?</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    i<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token function">set-of</span> <span class="token punctuation">(</span><span class="token function">gen-prime</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value 12: (2 3 5 7 11 13 17 19)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="逻辑编程的例子"><a href="#逻辑编程的例子" class="headerlink" title="逻辑编程的例子"></a>逻辑编程的例子</h3><p>让我们来解决<a href="https://mitpress.mit.edu/sicp/full-text/book/book-Z-H-28.html#%_sec_4.3.2">SICP中的习题4.42</a>作为例子。问题如下：</p><p>五位女同学参加一场考试。她们的家长对考试结果过分关心。为此她们约定，在给家里写信谈到考试时，每个姑娘都要写一句真话和一句假话。下面是从她们的信中摘出的句子：</p><p>贝蒂：“凯迪考第二，我只考了第三。” 艾赛尔：“你们应该高兴地听到我考了第一，琼第二。” 琼：“我考第三，可怜的艾赛尔考得最差。” 凯蒂：“我第二，玛丽只考了第四。” 玛丽：“我是第四，贝蒂的成绩最高。”</p><p>这五位姑娘的实际排名是什么？</p><p>[代码4]给出了这个问题的解法。</p><p>[代码4]</p><pre class="line-numbers language-scheme"><code class="language-scheme">01:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">xor</span> a b<span class="token punctuation">)</span>
<span class="token number">02</span>:       <span class="token punctuation">(</span><span class="token keyword">if</span> a <span class="token punctuation">(</span><span class="token function">not</span> b<span class="token punctuation">)</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">03</span>:     
<span class="token number">04</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span><span class="token function">all-different?</span> . ls<span class="token punctuation">)</span>
<span class="token number">05</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> loop <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">obj</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">ls</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">06</span>:         <span class="token punctuation">(</span><span class="token function">or</span> <span class="token punctuation">(</span><span class="token builtin">null?</span> ls<span class="token punctuation">)</span>
<span class="token number">07</span>:             <span class="token punctuation">(</span><span class="token function">and</span> <span class="token punctuation">(</span><span class="token function">not</span> <span class="token punctuation">(</span><span class="token function">memv</span> obj ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">08</span>:                  <span class="token punctuation">(</span><span class="token function">loop</span> <span class="token punctuation">(</span><span class="token builtin">car</span> ls<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">cdr</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">09</span>:     
<span class="token number">10</span>:     <span class="token comment" spellcheck="true">;;; SICP Exercise 4.42</span>
<span class="token number">11</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>girls-exam<span class="token punctuation">)</span>
<span class="token number">12</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">kitty</span> <span class="token punctuation">(</span><span class="token function">number-between</span> <span class="token number">1</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">13</span>:             <span class="token punctuation">(</span><span class="token function">betty</span> <span class="token punctuation">(</span><span class="token function">number-between</span> <span class="token number">1</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">14</span>:         <span class="token punctuation">(</span><span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">xor</span> <span class="token punctuation">(</span><span class="token operator">=</span> kitty <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">=</span> betty <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">15</span>:         <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">mary</span> <span class="token punctuation">(</span><span class="token function">number-between</span> <span class="token number">1</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">16</span>:           <span class="token punctuation">(</span><span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">xor</span> <span class="token punctuation">(</span><span class="token operator">=</span> kitty <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">=</span> mary <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">17</span>:           <span class="token punctuation">(</span><span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">xor</span> <span class="token punctuation">(</span><span class="token operator">=</span> mary <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">=</span> betty <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">18</span>:           <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ethel</span> <span class="token punctuation">(</span><span class="token function">number-between</span> <span class="token number">1</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">19</span>:                 <span class="token punctuation">(</span><span class="token function">joan</span> <span class="token punctuation">(</span><span class="token function">number-between</span> <span class="token number">1</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">20</span>:             <span class="token punctuation">(</span><span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">xor</span> <span class="token punctuation">(</span><span class="token operator">=</span> ethel <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">=</span> joan <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">21</span>:             <span class="token punctuation">(</span><span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">xor</span> <span class="token punctuation">(</span><span class="token operator">=</span> joan <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">=</span> ethel <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">22</span>:             <span class="token punctuation">(</span><span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">all-different?</span> kitty betty ethel joan mary<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">23</span>:             <span class="token punctuation">(</span><span class="token function">map</span> list <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">kitty</span> betty ethel joan mary<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">list</span> kitty betty ethel joan mary<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">24</span>:     
<span class="token number">25</span>:     <span class="token comment" spellcheck="true">;;; Bad answer for ex 4.42</span>
<span class="token number">26</span>:     <span class="token punctuation">(</span><span class="token keyword">define</span> <span class="token punctuation">(</span>girls-exam-x<span class="token punctuation">)</span>
<span class="token number">27</span>:       <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">kitty</span> <span class="token punctuation">(</span><span class="token function">number-between</span> <span class="token number">1</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">28</span>:             <span class="token punctuation">(</span><span class="token function">betty</span> <span class="token punctuation">(</span><span class="token function">number-between</span> <span class="token number">1</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">29</span>:             <span class="token punctuation">(</span><span class="token function">mary</span> <span class="token punctuation">(</span><span class="token function">number-between</span> <span class="token number">1</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">30</span>:             <span class="token punctuation">(</span><span class="token function">ethel</span> <span class="token punctuation">(</span><span class="token function">number-between</span> <span class="token number">1</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">31</span>:             <span class="token punctuation">(</span><span class="token function">joan</span> <span class="token punctuation">(</span><span class="token function">number-between</span> <span class="token number">1</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">32</span>:         <span class="token punctuation">(</span><span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">xor</span> <span class="token punctuation">(</span><span class="token operator">=</span> kitty <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">=</span> betty <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">33</span>:         <span class="token punctuation">(</span><span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">xor</span> <span class="token punctuation">(</span><span class="token operator">=</span> kitty <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">=</span> mary <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">34</span>:         <span class="token punctuation">(</span><span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">xor</span> <span class="token punctuation">(</span><span class="token operator">=</span> mary <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">=</span> betty <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">35</span>:         <span class="token punctuation">(</span><span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">xor</span> <span class="token punctuation">(</span><span class="token operator">=</span> ethel <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">=</span> joan <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">36</span>:         <span class="token punctuation">(</span><span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">xor</span> <span class="token punctuation">(</span><span class="token operator">=</span> joan <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">=</span> ethel <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">37</span>:         <span class="token punctuation">(</span><span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">all-different?</span> kitty betty ethel joan mary<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">38</span>:         <span class="token punctuation">(</span><span class="token function">map</span> list <span class="token string">'</span><span class="token punctuation">(</span><span class="token function">kitty</span> betty ethel joan mary<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">list</span> kitty betty ethel joan mary<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>(xor a b)</strong>以下条件满足，返回#t:</p><ul><li>a是#t，b是#f，或者</li><li>a是#f，b是#t。</li></ul><p><strong>(all-different? , ls)</strong></p><p>当<code>ls</code>的所有元素都不相同时，返回#t。</p><p><strong>(girls-exam)</strong></p><p>是解决谜题的主要函数。它返回名字和排名的表。每次参数赋值后都调用了<code>assert</code>是为了有效地减少死分支的运行时间。<code>(girls-exam-x)</code>则是一个坏例子。它在为所有参数赋值之后调用<code>assert</code>。这种情况下，无谓地搜索了大量的死分支。[例5]显示<code>(girl-exam-x)</code>的运行时间是<code>(girl-exam)</code>的10倍。</p><p>[例5]</p><pre class="line-numbers language-scheme"><code class="language-scheme"><span class="token punctuation">(</span><span class="token keyword">define-syntax</span> cpu-time/sec
  <span class="token punctuation">(</span><span class="token keyword">syntax-rules</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">_</span> s<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token function">with-timings</span>
     <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> s<span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token function">run-time</span> gc-time real-time<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token function">write</span> <span class="token punctuation">(</span><span class="token function">internal-time/ticks->seconds</span> run-time<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token function">write-char</span> #\space<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token function">write</span> <span class="token punctuation">(</span><span class="token function">internal-time/ticks->seconds</span> gc-time<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token function">write-char</span> #\space<span class="token punctuation">)</span>
     <span class="token punctuation">(</span><span class="token function">write</span> <span class="token punctuation">(</span><span class="token function">internal-time/ticks->seconds</span> real-time<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">(</span>newline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">;Value: cpu-time/sec</span>

<span class="token punctuation">(</span><span class="token function">cpu-time/sec</span> <span class="token punctuation">(</span>girls-exam<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">.03</span> <span class="token number">0</span>. <span class="token number">.03</span>
<span class="token comment" spellcheck="true">;Value 14: ((kitty 1) (betty 3) (ethel 5) (joan 2) (mary 4))</span>

<span class="token punctuation">(</span><span class="token function">cpu-time/sec</span> <span class="token punctuation">(</span>girls-exam-x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">.341</span> <span class="token number">.29</span> <span class="token number">.631</span>
<span class="token comment" spellcheck="true">;Value 15: ((kitty 1) (betty 3) (ethel 5) (joan 2) (mary 4))</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="小结-4"><a href="#小结-4" class="headerlink" title="小结"></a>小结</h3><p>当你使用了非确定性和用于逻辑编程分析技术时，你就可以写出看起来具有先见之明的程序。注意如果搜索路径里有循环我们就不能使用本章的代码。关于这一点，查看<a href="http://mitpress.mit.edu/sicp/full-text/book/book-Z-H-28.html#%_sec_4.3">SICP 4.3</a>以获取更多信息。</p><p>写这一章时，我参考了<a href="http://www.ccs.neu.edu/home/dorai/t-y-scheme/t-y-scheme-Z-H-16.html">Teach Yourself Scheme in Fixnum Days</a>。</p><p>你可以在<a href="http://www.shido.info/lisp/scheme_amb.zip">这儿</a>下载本章代码。</p></div><hr><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/%E6%95%99%E7%A8%8B/"><span class="chip bg-color">教程</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="wechat,qq" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script></div></div></div></div></div><style>.valine-card{margin:1.5rem auto}.valine-card .card-content{padding:20px 20px 5px 20px}#vcomments textarea{box-sizing:border-box;background:url(/medias/comment_bg.png) 100% 100% no-repeat}#vcomments p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem}#vcomments blockquote p{text-indent:.2rem}#vcomments a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#vcomments img{max-width:100%;height:auto;cursor:pointer}#vcomments ol li{list-style-type:decimal}#vcomments ol,ul{display:block;padding-left:2em;word-spacing:.05rem}#vcomments ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#vcomments ul li{list-style-type:disc}#vcomments ul ul li{list-style-type:circle}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#vcomments table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#vcomments h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#vcomments h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#vcomments h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#vcomments h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#vcomments h6{font-size:1rem;line-height:1.3rem}#vcomments p{font-size:1rem;line-height:1.5rem}#vcomments hr{margin:12px 0;border:0;border-top:1px solid #ccc}#vcomments blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#vcomments pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#vcomments code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#vcomments pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#vcomments pre[class*=language-]{padding:1.2em;margin:.5em 0}#vcomments code[class*=language-],pre[class*=language-]{color:#e8eaf6}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#vcomments b,strong{font-weight:700}#vcomments dfn{font-style:italic}#vcomments small{font-size:85%}#vcomments cite{font-style:normal}#vcomments mark{background-color:#fcf8e3;padding:.2em}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}.v .vlist .vcard{padding-top:2.5em!important}</style><div class="card valine-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;left:20px;top:15px;padding-bottom:5px"><i class="fa fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="vcomments" class="card-content" style="display:grid"></div></div><script src="/libs/valine/av-min.js"></script><script src="/libs/valine/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"98JpzSGcrl9jFqHO13vqxHvX-gzGzoHsz",appKey:"mDmr2h9PB20xvPMNqgyRnNIC",notify:!0,verify:!0,visitor:!0,avatar:"mm",pageSize:"10",lang:"zh-cn",placeholder:"just go go"})</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fa fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/posts/62537/"><div class="card-image"><img src="/medias/featureimages/28.jpg" class="responsive-img" alt="好久不见"> <span class="card-title">好久不见</span></div></a><div class="card-content article-content"><div class="summary block-with-text">首先，日安好久不见，距离上次更新竟然已经过了两年之久，很惭愧一直都没有更新，这两年发生了很多东西，一件一件来说吧。 关于未来怎么说呢，我从小一直对研究生有个渴望，但我上本科四年期间我一直没有想过能够通过这么曲折的方式拿到一个保研名额，相信愿</div><div class="publish-info"><span class="publish-date"><i class="fa fa-clock-o fa-fw icon-date"></i>2023-09-25 </span><span class="publish-author"><i class="fa fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E6%9D%82%E8%AE%B0/" class="post-category">杂记</a></span></div></div><div class="card-action article-tags"><a href="/tags/%E6%9D%82%E8%AE%B0/"><span class="chip bg-color">杂记</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fa fa-chevron-right"></i></div><div class="card"><a href="/posts/41006/"><div class="card-image"><img src="/medias/featureimages/25.jpg" class="responsive-img" alt="计算机病毒原理与防范"> <span class="card-title">计算机病毒原理与防范</span></div></a><div class="card-content article-content"><div class="summary block-with-text">期末复习与总结</div><div class="publish-info"><span class="publish-date"><i class="fa fa-clock-o fa-fw icon-date"></i>2021-03-03 </span><span class="publish-author"><i class="fa fa-bookmark fa-fw icon-category"></i> <a href="/categories/UESTC/" class="post-category">UESTC</a></span></div></div><div class="card-action article-tags"><a href="/tags/UESTC/"><span class="chip bg-color">UESTC</span></a></div></div></div></div></article></div><script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script><style type="text/css">code[class*=language-],pre[class*=language-]{white-space:pre!important}</style></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fa fa-list"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>$(function(){tocbot.init({tocSelector:"#toc-content",contentSelector:"#articleContent",headingsOffset:-(.4*$(window).height()-45),headingSelector:"h2, h3, h4, h5"});let t=0;var e="toc-heading-";$("#toc-content a").each(function(){$(this).attr("href","#"+e+ ++t)}),t=0,$("#articleContent").children("h2, h3, h4, h5").each(function(){$(this).attr("id",e+ ++t)});var n=parseInt(.4*$(window).height()-64);let o=$(".toc-widget");$(window).scroll(function(){var t=$(window).scrollTop();n<t?o.addClass("toc-fixed"):o.removeClass("toc-fixed")});var i="expanded";let a=$("#toc-aside"),c=$("#main-content");$("#floating-toc-btn .btn-floating").click(function(){a.hasClass(i)?(a.removeClass(i).hide(),c.removeClass("l9")):(a.addClass(i).show(),c.addClass("l9")),function(){let e=$("#artDetail");if(0!==e.length){let t=e.width();450<=t?t+=21:350<=t&&t<450?t+=18:300<=t&&t<350?t+=16:t+=14,$("#prenext-posts").width(t)}}()})})</script></main><footer class="page-footer bg-color"><div class="container row center-align"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2019</span> <a href="/about" rel="external nofollow noreferrer">JoyTsing</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br><span id="sitetime">载入运行时间...</span> <span id="busuanzi_container_site_pv">|&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次 </span><span id="busuanzi_container_site_uv">|&nbsp;<i class="fa fa-user"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?"https://":"http://";document.write(unescape("%3Cspan id='cnzz_stat_icon_1278523400'%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s4.cnzz.com/z_stat.php%3Fid%3D1278523400%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"))</script><br>&nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">441.2k</span>&nbsp;字<script>function siteTime(){var e=864e5,t="2019",n=(m=new Date).getFullYear(),o=m.getMonth()+1,r=m.getDate(),a=m.getHours(),i=m.getMinutes(),l=m.getSeconds(),m=Date.UTC(t,"7","24","0","0","0"),r=Date.UTC(n,o,r,a,i,l)-m,a=Math.floor(r/31536e6),i=Math.floor(r/e-365*a),l=Math.floor((r-(365*a+i)*e)/36e5),m=Math.floor((r-(365*a+i)*e-36e5*l)/6e4),M=Math.floor((r-(365*a+i)*e-36e5*l-6e4*m)/1e3);t==n?(document.getElementById("year").innerHTML=n,document.getElementById("sitetime").innerHTML="本站已安全运行 "+i+" 天 "+l+" 小时 "+m+" 分钟 "+M+" 秒"):(document.getElementById("year").innerHTML=t+" - "+n,document.getElementById("sitetime").innerHTML="本站已安全运行 "+a+" 年 "+i+" 天 "+l+" 小时 "+m+" 分钟 "+M+" 秒")}setInterval(siteTime,1e3)</script></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/JoyTsing" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fa fa-github"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script src="/js/search.js"></script><script type="text/javascript">$(function(){searchFunc("/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fa fa-angle-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?3a39d92b69933ae56c7eb41ffb9aa2e0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",(e=document.getElementsByTagName("script")[0]).parentNode.insertBefore(t,e)}()</script><script async src="/libs/others/busuanzi.pure.mini.js"></script><script type="text/javascript">var st,OriginTitile=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="(oﾟvﾟ)ノ Hi",clearTimeout(st)):(document.title="(*´∇｀*) 欢迎回来！",st=setTimeout(function(){document.title=OriginTitile},3e3))})</script><script type="text/javascript" color="0,0,255" pointcolor="0,0,255" opacity="0.8" zindex="-1" count="150" src="/libs/background/canvas-nest.js"></script><script src="/libs/instantpage/instantpage.js" type="module"></script><script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script><script>const hasAttr = (e,a) => a.some(_=> e.attr(_)!==undefined);
        $('a').each(function() {
          const $this = $(this);
          if(hasAttr($this,["data-fancybox","ignore-external-link"])) return;
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== '' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"left",width:150,height:200},mobile:{show:!1},react:{opacity:.7}})</script></body></html>