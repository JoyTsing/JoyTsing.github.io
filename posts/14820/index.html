<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="Cpp的异常处理额外开销是个啥, joytsing blog"><meta name="description" content="唉，异常"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="theme-color" content="white"><title>Cpp的异常处理额外开销是个啥 | JoyTsing</title><link rel="apple-touch-icon" href="/"><link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="/css/matery.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><style type="text/css">code[class*=language-],pre[class*=language-]{white-space:pre!important}</style><script src="/libs/jquery/jquery.min.js"></script><script src="https://cdn-go.cn/aegis/aegis-sdk/latest/aegis.min.js"></script><script>const aegis=new Aegis({id:"6ojk8FlnQlqWeL6vQo",uin:"joyblog",reportApiSpeed:!0,reportAssetSpeed:!0,spa:!0,hostUrl:"https://rumt-sg.com"});console.log("aegis load")</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="JoyTsing" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="/apple-touch-icon.png" class="logo-img" alt="LOGO"> <span class="logo-span">JoyTsing</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fa fa-home"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa fa-tags"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa fa-bookmark"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa fa-archive"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa fa-user-circle-o"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa fa-envelope"></i> <span>留言</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa fa-address-book"></i> <span>友链</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fa fa-search" title="搜索"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="/medias/avatars/touxiang2.jpg" class="logo-img circle responsive-img"><div class="logo-name">JoyTsing</div><div class="logo-desc">joytsing的个人网站</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa fa-fw fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa fa-fw fa-user-circle-o"></i> 关于</a></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa fa-fw fa-envelope"></i> 留言</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa fa-fw fa-address-book"></i> 友链</a></li><li><div class="divider"></div></li><li><a href="https://github.com/JoyTsing" class="waves-effect waves-light" target="_blank"><i class="fa fa-github-square fa-fw"></i>Follow Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#000;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/JoyTsing" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Follow Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(/medias/featureimages/24.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">Cpp的异常处理额外开销是个啥</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{height:calc(100vh - 250px);overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/Cpp/"><span class="chip bg-color">Cpp</span> </a><a href="/tags/%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90/"><span class="chip bg-color">原理剖析</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fa fa-bookmark fa-fw icon-category"></i> <a href="/categories/Cpp/" class="post-category">Cpp</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp; 2024-04-01</div><div class="post-date info-break-policy"><i class="fa fa-calendar-check-o fa-fw"></i>更新日期:&nbsp;&nbsp; 2024-04-01</div><div class="info-break-policy"><i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp; 3.5k</div><div class="info-break-policy"><i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp; 15 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp; <span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在哪本书（忘了哪本还是哪个讲座）里面看到，打开异常的话会让最终编译出的程序体积扩大三分之一，还会拖慢运行速度，所以C++的异常到底有多慢，以及它为什么这么慢。</p><h2 id="抛出异常"><a href="#抛出异常" class="headerlink" title="抛出异常"></a>抛出异常</h2><p>要了解异常处理到底做了什么，我们需要深入到汇编语言来看看编译器到底如何生成代码。我们以下面这一段简单的代码为例：</p><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noinline<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">auto</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同时，我们使用<a href="https://link.zhihu.com/?target=https%3A//godbolt.org/">Compiler Explorer</a>分析一下它生成的汇编：</p><pre class="line-numbers language-assembly"><code class="language-assembly">foo(int):                                # @foo(int)
        push    rbx
        mov     ebx, edi
        test    edi, edi
        js      .LBB0_2
        inc     ebx
        mov     eax, ebx
        pop     rbx
        ret
.LBB0_2:
        mov     edi, 4
        call    __cxa_allocate_exception@PLT
        mov     dword ptr [rax], ebx
        mov     rsi, qword ptr [rip + typeinfo for int@GOTPCREL]
        mov     rdi, rax
        xor     edx, edx
        call    __cxa_throw@PLT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这段代码是使用x86-64 clang 17.0.1生成的，编译选项为<code>-O2 -std=c++20</code>。这段代码非常简单，所以我们很容易可以分析出汇编代码与源代码的对应关系。对于不抛出异常的部分，代码的执行是这样的：</p><pre class="line-numbers language-assembly"><code class="language-assembly">        inc     ebx
        mov     eax, ebx
        pop     rbx
        ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这段汇编代码所作的事情就是<code>value += 1</code>，然后返回<code>value</code>。可以看到，在不抛出异常的路径下并没有引入任何影响执行速度的因素。</p><p><code>.LBB0_2</code>段对应了<code>throw value</code>的代码。</p><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token operator">*</span>thrown_object <span class="token operator">=</span> <span class="token function">__cxa_allocate_exception</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token comment" spellcheck="true">/* sizeof(int) */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">*</span>thrown_object <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token function">__cxa_throw</span><span class="token punctuation">(</span>thrown_object<span class="token punctuation">,</span> typeinfo_for_int<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>所以，抛出异常的额外开销也就是这两次函数调用了。我们来看一下<code>__cxa_allocate_exception</code>与<code>__cxa_throw</code>这两个函数具体做了什么。</p><h3 id="cxa-allocate-exception"><a href="#cxa-allocate-exception" class="headerlink" title="__cxa_allocate_exception"></a><code>__cxa_allocate_exception</code></h3><p>以LLVM libcxxabi为例：</p><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//  Allocate a __cxa_exception object, and zero-fill it.</span>
<span class="token comment" spellcheck="true">//  Reserve "thrown_size" bytes on the end for the user's exception</span>
<span class="token comment" spellcheck="true">//  object. Zero-fill the object. If memory can't be allocated, call</span>
<span class="token comment" spellcheck="true">//  std::terminate. Return a pointer to the memory to be used for the</span>
<span class="token comment" spellcheck="true">//  user's exception object.</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">__cxa_allocate_exception</span><span class="token punctuation">(</span>size_t thrown_size<span class="token punctuation">)</span> <span class="token keyword">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    size_t actual_size <span class="token operator">=</span> <span class="token function">cxa_exception_size_from_exception_thrown_size</span><span class="token punctuation">(</span>thrown_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Allocate extra space before the __cxa_exception header to ensure the</span>
    <span class="token comment" spellcheck="true">// start of the thrown object is sufficiently aligned.</span>
    size_t header_offset <span class="token operator">=</span> <span class="token function">get_cxa_exception_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>raw_buffer <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">__aligned_malloc_with_fallback</span><span class="token punctuation">(</span>header_offset <span class="token operator">+</span> actual_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> raw_buffer<span class="token punctuation">)</span>
        std<span class="token operator">::</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __cxa_exception <span class="token operator">*</span>exception_header <span class="token operator">=</span>
        <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>__cxa_exception <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>raw_buffer <span class="token operator">+</span> header_offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">::</span><span class="token function">memset</span><span class="token punctuation">(</span>exception_header<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> actual_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">thrown_object_from_cxa_exception</span><span class="token punctuation">(</span>exception_header<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个函数的注释已经把它所作的事情解释得很清楚了，不过我还是解释一下这段代码所作的事情：</p><ol><li>计算真正需要申请内存的大小（<code>header_offset + actual_size</code>）</li><li>尝试进行<code>aligned_malloc</code></li><li>如果<code>aligned_malloc</code>失败，则<code>std::terminate()</code></li><li>将申请的内存清零（只清零用于存放被抛出对象的部分，header部分不清零）</li></ol><p>所以这段代码约等于进行了一次<code>calloc</code>，其引入的主要开销也就是内存分配了。</p><h3 id="cxa-throw"><a href="#cxa-throw" class="headerlink" title="__cxa_throw"></a><code>__cxa_throw</code></h3><p>还是以LLVM libcxxabi为例：</p><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/*
After constructing the exception object with the throw argument value,
the generated code calls the __cxa_throw runtime library routine. This
routine never returns.

The __cxa_throw routine will do the following:

* Obtain the __cxa_exception header from the thrown exception object address,
which can be computed as follows:
 __cxa_exception *header = ((__cxa_exception *) thrown_exception - 1);
* Save the current unexpected_handler and terminate_handler in the __cxa_exception header.
* Save the tinfo and dest arguments in the __cxa_exception header.
* Set the exception_class field in the unwind header. This is a 64-bit value
representing the ASCII string "XXXXC++\0", where "XXXX" is a
vendor-dependent string. That is, for implementations conforming to this
ABI, the low-order 4 bytes of this 64-bit value will be "C++\0".
* Increment the uncaught_exception flag.
* Call _Unwind_RaiseException in the system unwind library, Its argument is the
pointer to the thrown exception, which __cxa_throw itself received as an argument.
__Unwind_RaiseException begins the process of stack unwinding, described
in Section 2.5. In special cases, such as an inability to find a
handler, _Unwind_RaiseException may return. In that case, __cxa_throw
will call terminate, assuming that there was no handler for the
exception.
*/</span>
<span class="token keyword">void</span>
<span class="token function">__cxa_throw</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>thrown_object<span class="token punctuation">,</span> std<span class="token operator">::</span>type_info <span class="token operator">*</span>tinfo<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dest<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    __cxa_eh_globals <span class="token operator">*</span>globals <span class="token operator">=</span> <span class="token function">__cxa_get_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __cxa_exception<span class="token operator">*</span> exception_header <span class="token operator">=</span> <span class="token function">cxa_exception_from_thrown_object</span><span class="token punctuation">(</span>thrown_object<span class="token punctuation">)</span><span class="token punctuation">;</span>

    exception_header<span class="token operator">-</span><span class="token operator">></span>unexpectedHandler <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">get_unexpected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exception_header<span class="token operator">-</span><span class="token operator">></span>terminateHandler  <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">get_terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exception_header<span class="token operator">-</span><span class="token operator">></span>exceptionType <span class="token operator">=</span> tinfo<span class="token punctuation">;</span>
    exception_header<span class="token operator">-</span><span class="token operator">></span>exceptionDestructor <span class="token operator">=</span> dest<span class="token punctuation">;</span>
    <span class="token function">setOurExceptionClass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>exception_header<span class="token operator">-</span><span class="token operator">></span>unwindHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    exception_header<span class="token operator">-</span><span class="token operator">></span>referenceCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// This is a newly allocated exception, no need for thread safety.</span>
    globals<span class="token operator">-</span><span class="token operator">></span>uncaughtExceptions <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// Not atomically, since globals are thread-local</span>

    exception_header<span class="token operator">-</span><span class="token operator">></span>unwindHeader<span class="token punctuation">.</span>exception_cleanup <span class="token operator">=</span> exception_cleanup_func<span class="token punctuation">;</span>

    <span class="token function">_Unwind_RaiseException</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>exception_header<span class="token operator">-</span><span class="token operator">></span>unwindHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//  This only happens when there is no handler, or some unexpected unwinding</span>
    <span class="token comment" spellcheck="true">//     error happens.</span>
    <span class="token function">failed_throw</span><span class="token punctuation">(</span>exception_header<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>与<code>__cxa_allocate_exception</code>相同，<code>__cxa_throw</code>函数的注释也写得很清楚了（PS：LLVM的注释写得真不错）。让我们来看看它干了什么：</p><ol><li>从<code>thrown_object</code>中拿到<code>__cxa_exception</code>。还记得吗，<code>__cxa_allocate_exception</code>申请内存时包含了<code>__cxa_exception</code>的header与被抛出的对象。<code>thrown_object</code>指向被抛出的对象，向前偏移header的大小即可拿到<code>__cxa_exception</code>对象的地址。</li><li>填充<code>__cxa_exception</code>的header；</li><li>调用<code>_Unwind_RaiseException</code>；</li><li>如果<code>_Unwind_RaiseException</code>调用成功，则不返回。否则，异常处理失败，调用<code>std::terminate()</code>。</li></ol><p><code>__cxa_exception</code>的header主要包含了各种处理函数的函数指针，以及异常对象的RTTI信息。填充header的过程基本就是几次赋值，以及一次<code>memcpy</code>（<code>setOurExceptionClass</code>的主要流程）。栈回溯等主要流程由<code>_Unwind_RaiseException</code>开始。</p><h2 id="栈回溯"><a href="#栈回溯" class="headerlink" title="栈回溯"></a>栈回溯</h2><p><code>_Unwind_RaiseException</code>函数是Itanium ABI定义的异常处理函数，它函数是语言无关的，其他语言也可以使用这个函数实现异常处理等功能。Itanium ABI在Base ABI中定义了一系列函数，在抛出异常这里我们只关心<code>_Unwind_RaiseException</code>。</p><p>我们继续展开<code>_Unwind_RaiseException</code>看看它做了什么，它是在<code>libunwind</code>中实现的：</p><pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/// Called by __cxa_throw.  Only returns if there is a fatal error.</span>
_LIBUNWIND_EXPORT _Unwind_Reason_Code
<span class="token function">_Unwind_RaiseException</span><span class="token punctuation">(</span>_Unwind_Exception <span class="token operator">*</span>exception_object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_LIBUNWIND_TRACE_API</span><span class="token punctuation">(</span><span class="token string">"_Unwind_RaiseException(ex_obj=%p)"</span><span class="token punctuation">,</span>
                         <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>exception_object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    unw_context_t uc<span class="token punctuation">;</span>
    unw_cursor_t cursor<span class="token punctuation">;</span>
    <span class="token function">__unw_getcontext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Mark that this is a non-forced unwind, so _Unwind_Resume()</span>
    <span class="token comment" spellcheck="true">// can do the right thing.</span>
    exception_object<span class="token operator">-></span>private_1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    exception_object<span class="token operator">-></span>private_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// phase 1: the search phase</span>
    _Unwind_Reason_Code phase1 <span class="token operator">=</span> <span class="token function">unwind_phase1</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cursor<span class="token punctuation">,</span> exception_object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>phase1 <span class="token operator">!=</span> _URC_NO_REASON<span class="token punctuation">)</span>
        <span class="token keyword">return</span> phase1<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// phase 2: the clean up phase</span>
    <span class="token keyword">return</span> <span class="token function">unwind_phase2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cursor<span class="token punctuation">,</span> exception_object<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>正如上面的代码所示，栈回溯包含两个阶段：<code>unwind_phase1</code>与<code>unwind_phase2</code>。第一阶段会遍历整个栈以查找Exception Handler，除此之外什么也不会做。如果没有找到Exception Handler，则应当终止程序。不过<code>libunwind</code>本身不会直接调用<code>std::terminate()</code>，而是返回<code>_URC_END_OF_STACK</code>并由调用者决定如何终止程序。在第二阶段才会回溯并清理栈。</p><p>这意味着，如果有异常被抛出，但没有被捕获，那么显然不会进入到第二阶段，也就是不会进行栈回溯，栈上对象的析构函数不会被执行。需要注意的是，对于未捕获异常时的栈回溯行为，C++标准规定这是由具体实现决定的。对于Itanium ABI而言，栈回溯不会被执行，但对于其他ABI而言则未必。</p><p><code>unwind_phase1</code>与<code>unwind_phase2</code>的代码都比较长，这里就不贴代码了，我会简要叙述一下它们的实现过程，感兴趣的话可以在<a href="https://link.zhihu.com/?target=https%3A//github.com/llvm/llvm-project/blob/28c29fbec3057692a7985819d799a9e5d47eb2d1/libunwind/src/UnwindLevel1.c%23L420">GitHub</a>找到它们的实现。</p><h3 id="unwind-phase1"><a href="#unwind-phase1" class="headerlink" title="unwind_phase1"></a><code>unwind_phase1</code></h3><p>在<code>unwind_phase1</code>中，代码会不断循环执行一段代码，来查找Exception Handler，直到找到Exception Handler或者到达栈的底部。这段循环的代码步骤如下：</p><ol><li>使用<code>__unw_step</code>函数，使cursor指向下一个栈帧；</li><li>使用<code>__unw_get_proc_info</code>函数，检查当前栈帧是否有需要执行的代码；</li></ol><ul><li>如果找到了要执行的代码，则检查是否要停在当前栈帧（可能找到了Exception Handler）；<ul><li>如果这段要执行的代码要求停在当前栈帧，则说明找到了Exception Handler，标记当前栈帧并返回；</li><li>否则继续循环。</li></ul></li><li>如果没有找到要执行的代码，则继续循环。</li></ul><p>不难想到，“可能的Exception Handler”就是C++代码中的<code>catch</code>了。在检查<code>catch</code>块是否与当前异常对象所匹配时，会对比RTTI信息等，所以如果回滚过程中找到了很多<code>catch</code>，会对<code>unwind_phase1</code>的性能有较大的影响。</p><h3 id="unwind-phase2"><a href="#unwind-phase2" class="headerlink" title="unwind_phase2"></a><code>unwind_phase2</code></h3><p><code>unwind_phase2</code>与<code>unwind_phase1</code>的代码非常类似，也是在循环中不断执行代码来回溯栈，只不过它所做的事情要稍微多一点：</p><ol><li>使用<code>__unw_step_stage2</code>函数，使cursor指向下一个栈帧；</li><li>使用<code>__unw_get_reg</code>获取当前栈帧的<code>sp</code>寄存器（stack pointer）；</li><li>使用<code>__unw_get_proc_info</code>函数，获取当前栈帧的信息；</li></ol><ul><li>如果当前栈帧有要执行的代码，则告诉它目前正在进行栈回溯；</li><li>如果当前栈帧是第一阶段标记的栈帧，则告诉它这是被标记的栈帧；</li><li>尝试执行这段代码：<ul><li>如果这段代码执行后，通知调用者应当继续回溯（返回<code>_URC_CONTINUE_UNWIND</code>），则继续循环；</li><li>如果这段代码执行后，通知调用者回溯到此为止，则尝试resume控制权（调用<code>__unw_phase2_resume</code>）。</li></ul></li></ul><p>很有趣的一点是，<code>libunwind</code>中的函数在调用具体的异常处理函数时全部是通过函数指针实现的，这一点保证了它能够做到语言无关。具体的栈清理等代码由C++的前端编译器生成，并以函数指针的形式传递给<code>libunwind</code>，这给了编译器前端很大的自由度。</p><h2 id="捕获和处理异常"><a href="#捕获和处理异常" class="headerlink" title="捕获和处理异常"></a>捕获和处理异常</h2><p>我们还是以一段简单的代码为例：</p><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">__attribute</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noinline<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">auto</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">foo</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">int</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Get error %d\n"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们使用<a href="https://link.zhihu.com/?target=https%3A//godbolt.org/">Compiler Explorer</a>分析一下它生成的汇编：</p><pre class="line-numbers language-assembly"><code class="language-assembly">bar(int):                                # @bar(int)
        push    rax
        call    foo(int)
        pop     rcx
        ret
        mov     rdi, rax
        call    __cxa_begin_catch@PLT
        mov     esi, dword ptr [rax]
        lea     rdi, [rip + .L.str]
        xor     eax, eax
        call    printf@PLT
        call    __cxa_end_catch@PLT
        mov     eax, -1
        pop     rcx
        ret
.Ltmp19:                                # TypeInfo 1
        .long   .L_ZTIi.DW.stub-.Ltmp19
.L.str:
        .asciz  "Get error %d\n"

DW.ref.__gxx_personality_v0:
        .quad   __gxx_personality_v0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以发现，在不需要执行<code>catch</code>的情况下，<code>bar</code>函数只有4行汇编：</p><pre class="line-numbers language-assembly"><code class="language-assembly">bar(int):                                # @bar(int)
        push    rax
        call    foo(int)
        pop     rcx
        ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而<code>catch</code>生成的代码显然被直接塞到了<code>ret</code>指令的后面。<code>catch</code>部分首先调用了<code>__cxa_begin_catch</code>，然后开始执行<code>printf</code>，最后调用<code>__cxa_end_catch</code>函数后回到了正常的代码路径上。除此之外，编译器还生成了一些其他的信息：<code>Ltmp19</code>段存储了RTTI信息，<code>DW.ref.__gxx_personality_v0</code>段存储了一个函数指针<code>__gxx_personality_v0</code>。这些东西又是什么？</p><h3 id="Personality-Routine"><a href="#Personality-Routine" class="headerlink" title="Personality Routine"></a>Personality Routine</h3><p>因为不知道怎么翻译比较好所以就保持原名了。</p><p>正如上文所述，<code>libunwind</code>使用函数指针的回调函数来具体实现栈清理等功能。<code>__gxx_personality_v0</code>即为<code>libc++abi</code>与<code>libsupc++</code>的Personality Routine（是个函数）。<code>libunwind</code>中Personality Routine的声明如下：</p><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">_Unwind_Reason_Code</span> <span class="token punctuation">(</span><span class="token operator">*</span>__personality_routine<span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">int</span> version<span class="token punctuation">,</span>
         _Unwind_Action actions<span class="token punctuation">,</span>
         uint64 exceptionClass<span class="token punctuation">,</span>
         <span class="token keyword">struct</span> _Unwind_Exception <span class="token operator">*</span>exceptionObject<span class="token punctuation">,</span>
         <span class="token keyword">struct</span> _Unwind_Context <span class="token operator">*</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>actions</code>参数用于表示要执行的操作，<code>exceptionObject</code>与<code>context</code>则分别表示异常对象与目前的上下文。<code>__gxx_personality_v0</code>的具体实现可以在<a href="https://link.zhihu.com/?target=https%3A//github.com/llvm/llvm-project/blob/28c29fbec3057692a7985819d799a9e5d47eb2d1/libcxxabi/src/cxa_personality.cpp%23L861-L1000">libcxxabi</a>找到。这部分代码所作的事情基本就是根据<code>action</code>选择执行相应的操作，<del>具体的实现我懒得看了</del>。</p><p>有了Personality Routine之后，还需要将其传递给<code>libunwind</code>，在DWARF中这是通过<code>.eh_frame</code>段实现的。栈帧和Personality Routine都存储在<code>.eh_frame</code>段中，<code>libunwind</code>自己会从<code>.eh_frame</code>段中查找。</p><h3 id="捕获异常"><a href="#捕获异常" class="headerlink" title="捕获异常"></a>捕获异常</h3><p>最后我们来讨论一下<code>__cxa_begin_catch</code>与<code>__cxa_end_catch</code>。<code>__cxa_begin_catch</code>的代码如下：</p><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">/*
This routine can catch foreign or native exceptions.  If native, the exception
can be a primary or dependent variety.  This routine may remain blissfully
ignorant of whether the native exception is primary or dependent.

If the exception is native:
* Increment's the exception's handler count.
* Push the exception on the stack of currently-caught exceptions if it is not
  already there (from a rethrow).
* Decrements the uncaught_exception count.
* Returns the adjusted pointer to the exception object, which is stored in
  the __cxa_exception by the personality routine.

If the exception is foreign, this means it did not originate from one of throw
routines.  The foreign exception does not necessarily have a __cxa_exception
header.  However we can catch it here with a catch (...), or with a call
to terminate or unexpected during unwinding.
* Do not try to increment the exception's handler count, we don't know where
  it is.
* Push the exception on the stack of currently-caught exceptions only if the
  stack is empty.  The foreign exception has no way to link to the current
  top of stack.  If the stack is not empty, call terminate.  Even with an
  empty stack, this is hacked in by pushing a pointer to an imaginary
  __cxa_exception block in front of the foreign exception.  It would be better
  if the __cxa_eh_globals structure had a stack of _Unwind_Exception, but it
  doesn't.  It has a stack of __cxa_exception (which has a next* in it).
* Do not decrement the uncaught_exception count because we didn't increment it
  in __cxa_throw (or one of our rethrow functions).
* If we haven't terminated, assume the exception object is just past the
  _Unwind_Exception and return a pointer to that.
*/</span>
<span class="token keyword">void</span><span class="token operator">*</span>
<span class="token function">__cxa_begin_catch</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> unwind_arg<span class="token punctuation">)</span> <span class="token keyword">throw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _Unwind_Exception<span class="token operator">*</span> unwind_exception <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>_Unwind_Exception<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>unwind_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> native_exception <span class="token operator">=</span> <span class="token function">__isOurExceptionClass</span><span class="token punctuation">(</span>unwind_exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __cxa_eh_globals<span class="token operator">*</span> globals <span class="token operator">=</span> <span class="token function">__cxa_get_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// exception_header is a hackish offset from a foreign exception, but it</span>
    <span class="token comment" spellcheck="true">//   works as long as we're careful not to try to access any __cxa_exception</span>
    <span class="token comment" spellcheck="true">//   parts.</span>
    __cxa_exception<span class="token operator">*</span> exception_header <span class="token operator">=</span>
            <span class="token function">cxa_exception_from_exception_unwind_exception</span>
            <span class="token punctuation">(</span>
                <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>_Unwind_Exception<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>unwind_exception<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>native_exception<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Increment the handler count, removing the flag about being rethrown</span>
        exception_header<span class="token operator">-</span><span class="token operator">></span>handlerCount <span class="token operator">=</span> exception_header<span class="token operator">-</span><span class="token operator">></span>handlerCount <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span>
            <span class="token operator">-</span>exception_header<span class="token operator">-</span><span class="token operator">></span>handlerCount <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> exception_header<span class="token operator">-</span><span class="token operator">></span>handlerCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//  place the exception on the top of the stack if it's not already</span>
        <span class="token comment" spellcheck="true">//    there by a previous rethrow</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exception_header <span class="token operator">!=</span> globals<span class="token operator">-</span><span class="token operator">></span>caughtExceptions<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            exception_header<span class="token operator">-</span><span class="token operator">></span>nextException <span class="token operator">=</span> globals<span class="token operator">-</span><span class="token operator">></span>caughtExceptions<span class="token punctuation">;</span>
            globals<span class="token operator">-</span><span class="token operator">></span>caughtExceptions <span class="token operator">=</span> exception_header<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        globals<span class="token operator">-</span><span class="token operator">></span>uncaughtExceptions <span class="token operator">-</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// Not atomically, since globals are thread-local</span>
        <span class="token keyword">return</span> exception_header<span class="token operator">-</span><span class="token operator">></span>adjustedPtr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// Else this is a foreign exception</span>
    <span class="token comment" spellcheck="true">// If the caughtExceptions stack is not empty, terminate</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>globals<span class="token operator">-</span><span class="token operator">></span>caughtExceptions <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        std<span class="token operator">::</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Push the foreign exception on to the stack</span>
    globals<span class="token operator">-</span><span class="token operator">></span>caughtExceptions <span class="token operator">=</span> exception_header<span class="token punctuation">;</span>
    <span class="token keyword">return</span> unwind_exception <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>虽然这段代码看起来很长，但其并不复杂。这段代码首先对native和foreign异常进行了判断。<code>libcxxabi</code>不处理foreign异常，所以当其捕获到foreigh异常时，直接调用<code>std::terminate()</code>。如果捕获到了native异常，则维护异常对象的引用计数，以及全局异常对象的状态。其中大部分的操作都是对各种计数进行加减操作。</p><p><code>__cxa_end_catch</code>所作的事情与<code>__cxa_begin_catch</code>类似，也是维护异常对象的状态，这里就不再赘述了。感兴趣的话请自行阅读<code>libcxxabi</code>的源码吧。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>简要总结一下Itanium ABI抛出和捕获异常的主要流程：</p><p>抛出异常</p><ol><li>申请内存，用于存放<code>__cxa_exception</code>与异常对象；</li><li><code>_Unwind_RaiseException</code>查找Exception Handler。这个过程可能需要频繁比较RTTI信息；</li><li><code>_Unwind_RaiseException</code>回溯并释放栈对象。这个过程可能需要频繁查找<code>.eh_frame</code>段；</li></ol><p>捕获异常</p><ol><li>交还控制权，<code>__cxa_begin_catch</code>维护异常状态；</li><li>执行<code>catch</code>部分的代码；</li><li>执行<code>__cxa_end_catch</code>，维护异常状态，捕获异常结束。</li></ol><p>从中可以大致看出，抛出异常以及栈回溯会占用异常处理的大部分时间。比较耗费性能的部分有：申请和释放堆内存、比较RTTI信息、以及栈回溯。如果和返回错误码进行比较的话，考虑多层传递错误码的情况，函数返回本身也需要依次析构栈上的对象。这样考虑的话，异常的<strong>栈回溯</strong>也没有带来很大的额外时间开销。</p><h3 id="空间开销"><a href="#空间开销" class="headerlink" title="空间开销"></a>空间开销</h3><p>异常带来的额外空间开销主要是<code>.eh_frame</code>，其中RTTI要占很大一部分。对于比较大型的软件而言，异常和RTTI对二进制大小的影响还是很大的。</p></div><hr><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/Cpp/"><span class="chip bg-color">Cpp</span> </a><a href="/tags/%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90/"><span class="chip bg-color">原理剖析</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="wechat,qq" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script></div></div></div></div></div><style>.valine-card{margin:1.5rem auto}.valine-card .card-content{padding:20px 20px 5px 20px}#vcomments textarea{box-sizing:border-box;background:url(/medias/comment_bg.png) 100% 100% no-repeat}#vcomments p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem}#vcomments blockquote p{text-indent:.2rem}#vcomments a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#vcomments img{max-width:100%;height:auto;cursor:pointer}#vcomments ol li{list-style-type:decimal}#vcomments ol,ul{display:block;padding-left:2em;word-spacing:.05rem}#vcomments ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#vcomments ul li{list-style-type:disc}#vcomments ul ul li{list-style-type:circle}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#vcomments table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#vcomments h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#vcomments h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#vcomments h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#vcomments h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#vcomments h6{font-size:1rem;line-height:1.3rem}#vcomments p{font-size:1rem;line-height:1.5rem}#vcomments hr{margin:12px 0;border:0;border-top:1px solid #ccc}#vcomments blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#vcomments pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#vcomments code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#vcomments pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#vcomments pre[class*=language-]{padding:1.2em;margin:.5em 0}#vcomments code[class*=language-],pre[class*=language-]{color:#e8eaf6}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#vcomments b,strong{font-weight:700}#vcomments dfn{font-style:italic}#vcomments small{font-size:85%}#vcomments cite{font-style:normal}#vcomments mark{background-color:#fcf8e3;padding:.2em}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}.v .vlist .vcard{padding-top:2.5em!important}</style><div class="card valine-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;left:20px;top:15px;padding-bottom:5px"><i class="fa fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="vcomments" class="card-content" style="display:grid"></div></div><script src="/libs/valine/av-min.js"></script><script src="/libs/valine/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"98JpzSGcrl9jFqHO13vqxHvX-gzGzoHsz",appKey:"mDmr2h9PB20xvPMNqgyRnNIC",notify:!0,verify:!0,visitor:!0,avatar:"mm",pageSize:"10",lang:"zh-cn",placeholder:"just go go"})</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fa fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/posts/34895/"><div class="card-image"><img src="/medias/featureimages/18.jpg" class="responsive-img" alt="深入理解Linux网络学习笔记(四)"> <span class="card-title">深入理解Linux网络学习笔记(四)</span></div></a><div class="card-content article-content"><div class="summary block-with-text">内核是如何发送网络包的</div><div class="publish-info"><span class="publish-date"><i class="fa fa-clock-o fa-fw icon-date"></i>2024-04-02 </span><span class="publish-author"><i class="fa fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" class="post-category">计算机网络</a></span></div></div><div class="card-action article-tags"><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"><span class="chip bg-color">计算机网络</span> </a><a href="/tags/Linux/"><span class="chip bg-color">Linux</span> </a><a href="/tags/C/"><span class="chip bg-color">C</span> </a><a href="/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"><span class="chip bg-color">源码阅读</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fa fa-chevron-right"></i></div><div class="card"><a href="/posts/13357/"><div class="card-image"><img src="/medias/featureimages/23.jpg" class="responsive-img" alt="Cpp中的memory order"> <span class="card-title">Cpp中的memory order</span></div></a><div class="card-content article-content"><div class="summary block-with-text">复杂又不复杂</div><div class="publish-info"><span class="publish-date"><i class="fa fa-clock-o fa-fw icon-date"></i>2024-04-01 </span><span class="publish-author"><i class="fa fa-bookmark fa-fw icon-category"></i> <a href="/categories/Cpp/" class="post-category">Cpp</a></span></div></div><div class="card-action article-tags"><a href="/tags/Cpp/"><span class="chip bg-color">Cpp</span> </a><a href="/tags/%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90/"><span class="chip bg-color">原理剖析</span> </a><a href="/tags/Linux/"><span class="chip bg-color">Linux</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){var n,t,o,i;void 0!==window.getSelection&&((""+(n=window.getSelection())).length<Number.parseInt("120")||(t=document.getElementsByTagName("body")[0],(o=document.createElement("div")).style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"===n.getRangeAt(0).commonAncestorContainer.nodeName&&(o.innerHTML="<pre>"+o.innerHTML+"</pre>"),i=document.location.href,o.innerHTML+='<br />来源: JoyTsing<br />文章作者: JoyTsing<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者joytsing所有，请任何形式的转载都请注明出处并在文章评论区处告知。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200)))})</script><script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script><style type="text/css">code[class*=language-],pre[class*=language-]{white-space:pre!important}</style></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fa fa-list"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>$(function(){tocbot.init({tocSelector:"#toc-content",contentSelector:"#articleContent",headingsOffset:-(.4*$(window).height()-45),headingSelector:"h2, h3, h4, h5"});let t=0;var e="toc-heading-";$("#toc-content a").each(function(){$(this).attr("href","#"+e+ ++t)}),t=0,$("#articleContent").children("h2, h3, h4, h5").each(function(){$(this).attr("id",e+ ++t)});var n=parseInt(.4*$(window).height()-64);let o=$(".toc-widget");$(window).scroll(function(){var t=$(window).scrollTop();n<t?o.addClass("toc-fixed"):o.removeClass("toc-fixed")});var i="expanded";let a=$("#toc-aside"),c=$("#main-content");$("#floating-toc-btn .btn-floating").click(function(){a.hasClass(i)?(a.removeClass(i).hide(),c.removeClass("l9")):(a.addClass(i).show(),c.addClass("l9")),function(){let e=$("#artDetail");if(0!==e.length){let t=e.width();450<=t?t+=21:350<=t&&t<450?t+=18:300<=t&&t<350?t+=16:t+=14,$("#prenext-posts").width(t)}}()})})</script></main><footer class="page-footer bg-color"><div class="container row center-align"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2019</span> <a href="/about" rel="external nofollow noreferrer">JoyTsing</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br><span id="sitetime">载入运行时间...</span> <span id="busuanzi_container_site_pv">|&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次 </span><span id="busuanzi_container_site_uv">|&nbsp;<i class="fa fa-user"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br>&nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">831.6k</span>&nbsp;字 <span id="icp"><img src="/medias/icp.png" style="vertical-align:text-bottom" alt="icp"> <a href="https://beian.miit.gov.cn/" target="_blank">陕公网安备61019002002862号 滇ICP备2024026466号-1</a></span><script>function siteTime(){var e=864e5,t="2019",n=(m=new Date).getFullYear(),o=m.getMonth()+1,r=m.getDate(),a=m.getHours(),i=m.getMinutes(),l=m.getSeconds(),m=Date.UTC(t,"7","24","0","0","0"),r=Date.UTC(n,o,r,a,i,l)-m,a=Math.floor(r/31536e6),i=Math.floor(r/e-365*a),l=Math.floor((r-(365*a+i)*e)/36e5),m=Math.floor((r-(365*a+i)*e-36e5*l)/6e4),M=Math.floor((r-(365*a+i)*e-36e5*l-6e4*m)/1e3);t==n?(document.getElementById("year").innerHTML=n,document.getElementById("sitetime").innerHTML="本站已安全运行 "+i+" 天 "+l+" 小时 "+m+" 分钟 "+M+" 秒"):(document.getElementById("year").innerHTML=t+" - "+n,document.getElementById("sitetime").innerHTML="本站已安全运行 "+a+" 年 "+i+" 天 "+l+" 小时 "+m+" 分钟 "+M+" 秒")}setInterval(siteTime,1e3)</script></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/JoyTsing" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fa fa-github"></i> </a><a href="/medias/wechat.jpg" target="_blank" data-tooltip="添加我的微信: [object Object]" data-position="top" data-delay="50"><i class="fa fa-weixin"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script src="/js/search.js"></script><script type="text/javascript">$(function(){searchFunc("/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fa fa-angle-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?3a39d92b69933ae56c7eb41ffb9aa2e0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="/libs/others/busuanzi.pure.mini.js"></script><script type="text/javascript">var st,OriginTitile=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="(oﾟvﾟ)ノ Hi",clearTimeout(st)):(document.title="(*´∇｀*) 欢迎回来！",st=setTimeout(function(){document.title=OriginTitile},3e3))})</script><script type="text/javascript" color="0,0,255" pointcolor="0,0,255" opacity="0.8" zindex="-1" count="150" src="/libs/background/canvas-nest.js"></script><script src="/libs/instantpage/instantpage.js" type="module"></script><script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script><script>const hasAttr = (e,a) => a.some(_=> e.attr(_)!==undefined);
        $('a').each(function() {
          const $this = $(this);
          if(hasAttr($this,["data-fancybox","ignore-external-link"])) return;
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== '' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"left",width:150,height:200},mobile:{show:!1},react:{opacity:.7}})</script></body></html>