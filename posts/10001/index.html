<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="MySQL技术内幕-InnoDB存储引擎(二), joytsing blog"><meta name="description" content="MySQL文件和日志"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="theme-color" content="white"><title>MySQL技术内幕-InnoDB存储引擎(二) | JoyTsing</title><link rel="apple-touch-icon" href="/"><link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="/css/matery.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><style type="text/css">code[class*=language-],pre[class*=language-]{white-space:pre!important}</style><script src="/libs/jquery/jquery.min.js"></script><script src="https://cdn-go.cn/aegis/aegis-sdk/latest/aegis.min.js"></script><script>const aegis=new Aegis({id:"6ojk8FlnQlqWeL6vQo",uin:"joyblog",reportApiSpeed:!0,reportAssetSpeed:!0,spa:!0,hostUrl:"https://rumt-sg.com"});console.log("aegis load")</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="JoyTsing" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="/apple-touch-icon.png" class="logo-img" alt="LOGO"> <span class="logo-span">JoyTsing</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fa fa-home"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa fa-tags"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa fa-bookmark"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa fa-archive"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa fa-user-circle-o"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa fa-envelope"></i> <span>留言</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa fa-address-book"></i> <span>友链</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fa fa-search" title="搜索"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="/medias/avatars/touxiang2.jpg" class="logo-img circle responsive-img"><div class="logo-name">JoyTsing</div><div class="logo-desc">joytsing的个人网站</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa fa-fw fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa fa-fw fa-user-circle-o"></i> 关于</a></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa fa-fw fa-envelope"></i> 留言</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa fa-fw fa-address-book"></i> 友链</a></li><li><div class="divider"></div></li><li><a href="https://github.com/JoyTsing" class="waves-effect waves-light" target="_blank"><i class="fa fa-github-square fa-fw"></i>Follow Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#000;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/JoyTsing" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Follow Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(/medias/featureimages/4.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">MySQL技术内幕-InnoDB存储引擎(二)</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{height:calc(100vh - 250px);overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"><span class="chip bg-color">读书笔记</span> </a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="chip bg-color">数据库</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fa fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">数据库</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp; 2024-05-03</div><div class="post-date info-break-policy"><i class="fa fa-calendar-check-o fa-fw"></i>更新日期:&nbsp;&nbsp; 2024-05-14</div><div class="info-break-policy"><i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp; 4.5k</div><div class="info-break-policy"><i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp; 16 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp; <span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><a href="https://joytsing.cn/posts/9398/">上一篇文章</a>说过，MySQL数据库其实可以看做是一个存放了多个文件的容器，其中的每一种、每一个文件都有着非常重要的作用，那么接下来就先从文件的角度来一一细说，虽然这块部分可能比较枯燥，不过了解下MySQL的日志还是很不错的。（<strong>至少知道各个种类的日志又怎样的作用，又去哪里查看</strong>）</p><h2 id="一、文件"><a href="#一、文件" class="headerlink" title="一、文件"></a>一、文件</h2><h3 id="1-1-参数文件"><a href="#1-1-参数文件" class="headerlink" title="1.1 参数文件"></a>1.1 参数文件</h3><p>我们知道，Mysql实例启动后，会按照一定的顺序在指定的位置进行读取，输入命令：</p><pre class="line-numbers language-sql"><code class="language-sql"> mysql <span class="token comment" spellcheck="true">--help | grep my.cnf</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>结果如下，意思是按照<code>/etc/my.cnf</code>——&gt;<code>/etc/mysql/my.cnf</code>——&gt; <code>~/.my.cnf</code>的顺序进行读取（<strong>以读取到的最后一个文件为准</strong>）</p><p><img src="/posts/10001/image-20240513200346012.png" alt></p><p>这些配置文件的作用如其名字一样，而具体的参数可以由命令<code>show variables</code>来完成，部分结果如下：</p><p><img src="/posts/10001/image-20240513200550759.png" alt></p><p>Mysql中的参数可以分为两类：</p><ol><li>动态参数：运行在运行时进行更改。</li><li>静态参数：在实例整个生命周期内都不得进行更改。（只读）</li></ol><p>我们可以通过<code>Set</code>命令对动态参数的值进行修改，同时，动态参数还有两个作用范围：</p><ul><li>global：作用于整个实例的生命周期，如binlog_cache_size参数。</li><li>session：作用于当前会话，如autocommit参数。</li></ul><p>使用格式：</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">set</span> <span class="token punctuation">[</span><span class="token keyword">global</span> <span class="token operator">|</span> <span class="token keyword">session</span><span class="token punctuation">]</span> name<span class="token operator">=</span><span class="token keyword">value</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>通过<code>set</code>命令修改了任何类型的参数只对当前会话起作用</p></blockquote><h3 id="1-2-日志文件"><a href="#1-2-日志文件" class="headerlink" title="1.2 日志文件"></a>1.2 日志文件</h3><p>Mysql很多功能的实现都离不开日志，而日志文件当然是记录影像Mysql的各类型活动的文件，其中常见的日志包括：</p><ul><li>错误日志（error log）</li><li>二进制日志（binlog）</li><li>慢查询日志（slow query log）</li><li>查询日志（log）：记录所有对Mysql数据库请求的信息，无论这些请求是否得到了正确的执行。</li></ul><h4 id="1-2-1-错误日志"><a href="#1-2-1-错误日志" class="headerlink" title="1.2.1 错误日志"></a>1.2.1 错误日志</h4><p>错误日志主要针对Mysql的启动、运行、关闭过程。虽然名字上说是错误日志，<strong>但是他还记录一些警告或者正确的信息。</strong> 其实错误日志这一块没什么好说的，这里就教大家怎么辨别哪个日志是错误日志，输入命令：</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'log_error'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>结果：会显示错误日志对应的存储地址，当大家遇到一些数据库的相关报错问题时，请第一时间来看看错误日志上怎么说，对症下药比较快。</p><p><img src="/posts/10001/image-20240513200832561.png" alt></p><h4 id="1-2-2-慢查询日志"><a href="#1-2-2-慢查询日志" class="headerlink" title="1.2.2 慢查询日志"></a>1.2.2 慢查询日志</h4><p>慢查询日志（slow log）主要是用来定位可能存在问题的sql语句，从而进行SQL语句层面的优化。使用过程：</p><ol><li>在Mysql启动的时候设置一个阈值：<code>long_query_time</code>，默认值是10秒，但是默认不启动。</li><li><strong>那么运行时间超过该值的所有SQL语句都会记录到慢查询日志当中。</strong></li></ol><p>这里先把慢查询的3个最重要的参数放出来：</p><ul><li><code>slow_query_log</code>：慢查询开启状态。</li><li><code>slow_query_log_file</code>：慢查询日志存放的位置。</li><li><code>long_query_time</code>：慢查询的阈值。</li></ul><h5 id="慢查询测试："><a href="#慢查询测试：" class="headerlink" title="慢查询测试："></a>慢查询测试：</h5><p>1.执行命令（或者修改my.cnf文件，靠谱点）</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">set</span> <span class="token keyword">global</span> slow_query_log<span class="token operator">=</span><span class="token string">'ON'</span><span class="token punctuation">;</span> 
<span class="token keyword">set</span> <span class="token keyword">global</span> long_query_time<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/posts/10001/image-20240513201339355.png" alt></p><p>此外，和慢查询相关的参数还有：</p><ul><li><code>log_queries_not_using_indexes</code>：如果运行的SQL语句没有使用索引，那么Mysql同样会把这条语句记录到慢查询日志文件中，打开此参数可以关闭该功能。</li><li><code>log_throttle_queries_not_using_indexes</code>：表示每分钟允许记录到慢查询日志的且没有使用索引的SQL语句次数（默认是10，表示无限制）</li><li><code>log_output</code>：指定慢查询输出的格式，默认是FILE（文件），可以将它设置为TABLE，然后即可查询mysql库中的slow_log表了。</li></ul><h4 id="1-2-3-二进制日志☆"><a href="#1-2-3-二进制日志☆" class="headerlink" title="1.2.3 二进制日志☆"></a>1.2.3 二进制日志☆</h4><p>二进制日志记录了对Mysql执行更改的所有操作，<strong>不包括select、show等不影响数据的操作。</strong> 二进制日志的作用有：</p><ol><li>恢复：某些数据的恢复需要二进制日志。</li><li>复制：一般用于主从复制。</li><li>审计：用户通过二进制日志的信息来进行审计，判断是否有对数据库进行SQL注入。</li></ol><p>查看二进制文件的存放目录：</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'datadir'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/posts/10001/image-20240513201503906.png" alt></p><p>二进制文件的格式为：（后面为标志性的二进制日志序列号）</p><p><img src="/posts/10001/image-20240513201704273.png" alt></p><p>接下来说一下和二进制日志有关的几个重要参数：</p><ul><li><code>max_binlog_size</code>：<strong>指定单个二进制日志文件的最大值</strong>，若超过该值，则产生新的二进制文件，后缀名+1。</li><li><code>binlog_cache_size</code>☆：<ul><li>1.使用InnoDB存储引擎时，<strong>所有未提交的（uncommitted）的二进制日志会被记录到一个缓存中，等到该事务提交的时候直接将缓冲中的二进制日志写入到二进制文件中。</strong> 而binlog_cache_size则控制了这个缓存的大小，默认32K。</li><li>2.此外，<strong>binlog_cache_size基于会话（session），即当一个线程开始一个事务时，Mysql会自动分配一个大小为binlog_cache_size的缓存。</strong></li><li>3.当一个事务的记录大小大于阈值的话，会把缓冲的日志写入到一个临时文件中。<strong>（即这个值不能太小）建议使用<code>show global status like &#39;binlog_cache%&#39;;</code>来判断当前的binlog_cache_size是否合适，</strong></li></ul></li></ul><p><img src="/posts/10001/image-20240513202154335.png" alt></p><ul><li><p><code>sync_binlog</code>：参数sync_binlog=【N】表示每写缓冲多少次就同步到磁盘，若该值为1，则<strong>代表采用同步写磁盘的方式来写二进制日志。</strong></p></li><li><p><code>binlog_do_db</code>：表示需要写入xxx库中的日志，<strong>默认为空，表示需要同步所有库的日志到二进制日志文件中。</strong></p></li><li><p><code>binlog_ignore_db</code>：表示需要忽略xxx库中的日志。</p></li><li><p><code>log_slave_update</code>：该参数一般用于主从架构。<strong>如果当前数据库是复制中的从节点</strong>，则他不会将从主节点中取得并且执行的二进制日志写入到自己的二进制日志中，若需要写入，则需要开启该参数。</p></li><li><p><code>binlog_format</code>☆</p><ul><li><strong>STATEMENT</strong>：若设置为该值，则二进制日志文件<strong>记录的是日志的逻辑SQL语句。</strong></li><li><strong>ROW</strong>：二进制日志文件<strong>记录的是表的行更改情况。</strong> （这种模式下，将事务隔离级别设置为Read Committed会获得更好的并发性）</li><li><strong>MIXED：Mysql</strong>默认采用STATEMENT格式进行二进制日志文件的记录，但是在以下几个情况下会转成ROW模式：</li></ul><blockquote><p>1.表的存储引擎为InnoDB，这时候对表的DML操作都会以ROW格式记录。<br>2.使用了UUID()，USER()，CURRENT_USER()，FOUND_ROWS()，ROW_COUNT()等不确定函数。<br>3.使用了insert delay语句。<br>4.使用了用户定义函数（UDF）。<br>5.使用了临时表。</p></blockquote></li></ul><p>二进制文件的查看必须使用Mysql提供的mysqlbinlog工具来查看，例如：对于STATEMENT格式的二进制日志文件，在使用mysqlbinlog后，看到的就是执行的逻辑SQL语句。</p><h3 id="1-3-其他类型文件（了解）"><a href="#1-3-其他类型文件（了解）" class="headerlink" title="1.3 其他类型文件（了解）"></a>1.3 其他类型文件（了解）</h3><p><strong>套接字文件</strong><br>在UNIX系统下本地连接Mysql可以采用UNIX域套接字方式，而这种方式则需要一个套接字文件（socket），名为mysql.socket。</p><p><strong>pid文件</strong><br>当Mysql实例启动的时候，会将自己的进程Id写入一个文件中，而这个文件就是pid文件。该参数由参数pid_file控制，默认位于数据库目录下。</p><p><strong>表结构定义文件</strong><br>Mysql数据的存储是根据表进行的，<strong>每个表都有一个与之对应的文件，无论使用哪一种存储引擎，Mysql都有一个以frm为后缀名的文件，该文件记录该表的表结构定义。</strong></p><h2 id="二-InnoDB存储引擎文件☆"><a href="#二-InnoDB存储引擎文件☆" class="headerlink" title="二.InnoDB存储引擎文件☆"></a>二.InnoDB存储引擎文件☆</h2><p>上面介绍的文件都是Mysql数据库本身的文件，和我们的存储引擎无关。那么存储引擎也有属于自己的独特文件。</p><h3 id="2-1-表空间文件"><a href="#2-1-表空间文件" class="headerlink" title="2.1 表空间文件"></a>2.1 表空间文件</h3><p>InnoDB采用<strong>将存储的数据按照表空间（tablespace）进行存放的设计。</strong> 在默认配置下会<strong>有一个初始大小为10MB、名为ibdata1的文件，该文件就是默认的表空间文件。</strong></p><p><img src="/posts/10001/image-20240513203106904.png" alt></p><p>此外，用户可以通过参数<code>innodb_data_file_path</code>对表空间路径进行设置，举例如下：</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true"># 这里将/db/ibdata1和/db/ibdata2两个文件一起来组成表空间。（若俩文件在不同磁盘上，还可以做到负载均衡）</span>
<span class="token comment" spellcheck="true"># 两个文件后跟的属性含义：100M，代表ibdata1的大小为100M。</span>
<span class="token comment" spellcheck="true"># 200M:autoextend代表超过200MB时，这个文件的大小可以自动增长。</span>
innodb_data_file_path <span class="token operator">=</span><span class="token operator">/</span><span class="token number">db</span><span class="token operator">/</span>ibdata1:100M<span class="token punctuation">;</span><span class="token operator">/</span><span class="token number">db</span><span class="token operator">/</span>ibdata2:200M:autoextend<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>若设置了<code>innodb_data_file_path</code>参数，<strong>那么所有基于InnoDB存储引擎的表中的数据都会记录到该共享表空间中。</strong> 此外，若设置了参数<code>innodb_file_per_table</code>，用户可以将每个基于InnoDB的表都产生一个独立的表空间，命名规则为：<code>表名.ibd</code>（注意：<strong>这些单独的表空间文件仅存储该表的数据、索引、插入缓冲BitMap等信息，而其余的信息还是存放在默认的表空间中</strong>）</p><h3 id="2-2-重做日志文件☆"><a href="#2-2-重做日志文件☆" class="headerlink" title="2.2 重做日志文件☆"></a>2.2 重做日志文件☆</h3><p>默认情况下，每个InnoDB存储引擎至少有一个重做日志文件组（group），每个文件组下至少有2个重做日志文件。如默认的ib_logfile0和ib_logfile1。</p><p>重做日志也称为redo log，用来保证事务的原子性和持久性，重做日志中还包含着一种日志，叫undo log，也就是回滚日志，用来帮助事务回滚以及MVCC的功能。</p><h4 id="2-2-1-重做日志块（log-block）"><a href="#2-2-1-重做日志块（log-block）" class="headerlink" title="2.2.1 重做日志块（log block）"></a>2.2.1 重做日志块（log block）</h4><p>InnoDB存储引擎中，重做日志都是以512个字节进行存储的，<strong>也就意味着重做日志缓存、重做日志文件都是以块（block）的方式进行保存的，称之为重做日志块。</strong></p><p>一个块有512个字节这么大，其结构除了日志本身外，还包括：</p><ul><li>日志块头（log block header）12字节</li><li>日志块尾（log block tailer）8字节</li></ul><p><img src="/posts/10001/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1pvbmdfMDkxNQ==,size_16,color_FFFFFF,t_70.png" alt></p><h4 id="2-2-2-重做日志组（log-group）"><a href="#2-2-2-重做日志组（log-group）" class="headerlink" title="2.2.2 重做日志组（log group）"></a>2.2.2 重做日志组（log group）</h4><p>log group为重做日志组，包含多个重做日志文件。<strong>每个log group中的日志文件大小是相同的</strong>。而每个重做日志文件中存储的就是上面的log block块，因此也是根据块的方式进行物理存储的管理。<strong>在InnoDB存储引擎运行过程中，log buffer会根据一定的规则将内存中的block刷新到磁盘</strong>，规则如下：</p><ol><li>事务提交时。</li><li>当log buffer有一半的内存空间已经被使用时。</li><li>log Checkpoint时。</li></ol><p><strong>仅仅对于一个重做日志组的第一个重做日志文件（其他部分不保存）</strong>，它前2KB的部分会保存4个512字节的block，保存信息如下：</p><p><img src="/posts/10001/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1pvbmdfMDkxNQ==,size_16,color_FFFFFF,t_70-1715603673922-3.png" alt>log group和redo log file之间的关系如下：<br><img src="/posts/10001/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1pvbmdfMDkxNQ==,size_16,color_FFFFFF,t_70-1715603679083-6.png" alt></p><h4 id="2-2-3-重做日志格式和LSN"><a href="#2-2-3-重做日志格式和LSN" class="headerlink" title="2.2.3 重做日志格式和LSN"></a>2.2.3 重做日志格式和LSN</h4><p>重做日志格式：<br><img src="/posts/10001/20201212130116665.png" alt></p><ul><li>redo_log_type：重做日志的类型。</li><li>space：表空间Id。</li><li>page_no：页的偏移量。（InnoDB的存储管理是基于页的，因此重做日志格式也是基于页的）</li></ul><p>LSN（Log Sequence Number），<strong>代表日志序列号</strong>，占用8字节，单调递增，其表示的含义有：</p><ul><li>重做日志写入的总量。</li><li><strong>Checkpoint的位置</strong>。</li><li>页的版本。</li></ul><p>我们可以通过命令来查看LSN的情况：</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">ENGINE</span> <span class="token keyword">INNODB</span> <span class="token keyword">STATUS</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>部分结果：</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">---</span>
LOG
<span class="token comment" spellcheck="true">---</span>
<span class="token comment" spellcheck="true"># 表示当前的LSN</span>
Log sequence number <span class="token number">4732508</span>
<span class="token comment" spellcheck="true"># 表示刷新到重做日志文件的LSN</span>
Log flushed up <span class="token keyword">to</span>   <span class="token number">4732508</span>
<span class="token comment" spellcheck="true"># 在生产环境中，这3个值一般是不同的，因为一个事务中从日志缓冲刷新到重做日志文件并不是只是在事务提交的时候发生。</span>
<span class="token comment" spellcheck="true"># 因为比如master线程，每秒都会有从日志缓冲刷新到重做日志文件的动作发生。</span>
Pages flushed up <span class="token keyword">to</span> <span class="token number">4732508</span>
<span class="token comment" spellcheck="true"># 表示刷新到磁盘的LSN</span>
<span class="token keyword">Last</span> <span class="token keyword">checkpoint</span> at  <span class="token number">4732499</span>
<span class="token number">0</span> pending log flushes<span class="token punctuation">,</span> <span class="token number">0</span> pending chkp writes
<span class="token number">15</span> log i<span class="token operator">/</span>o<span class="token string">'s done, 0.00 log i/o'</span>s<span class="token operator">/</span>second<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-2-4-redo"><a href="#2-2-4-redo" class="headerlink" title="2.2.4 redo"></a>2.2.4 redo</h4><p><strong>重做日志用来实现事务的持久性</strong>，由两个部分组成：</p><ul><li>内存中的重做日志缓冲（redo log buffer）</li><li>重做日志文件（redo log file）</li></ul><p>redo log基本上是<strong>顺序写</strong>的，在数据库运行时不需要对redo log的文件进行读取操作，使用InnoDB存储引擎的时候，<strong>当事务提交的时候，必须将该事务的所有日志写入到重做日志文件中进行持久化</strong>，等待事务的Commit操作完成。而为了保证每次日志都写入重做日志文件中，在每次将重做日志缓冲写入重做日志文件后，InnoDB都需要调用一次fsync操作。</p><blockquote><p>fsync操作可以理解为：将日志持久化到磁盘上</p></blockquote><p>此外，mysql还提供一个参数<code>innodb_flush_log_at_trx_commit</code>用来控制重做日志刷新到磁盘的策略，有3个值：</p><ul><li>0：<strong>表示事务提交的时候不进行写入重做日志操作，而写入日志操作交给master线程来完成</strong>，主线程每1秒会进行一次重做日志文件的fsync操作。</li><li>1：表示<strong>事务提交时必须调用一次fsync操作</strong>。（性能相比其他两个要低，因为fsync操作次数多，但是保证事务的持久性）</li><li>2：事务提交时将重做日志写入重做日志文件中，<strong>但是仅写入文件系统的缓存中，不进行fsync操作</strong>。</li></ul><p>讲到这里，先对redo log和binlog进行一个比较。</p><table><thead><tr><th>比较层面</th><th>redo log</th><th>binlog</th></tr></thead><tbody><tr><td>作用层面</td><td>InnoDB存储引擎层面</td><td>Mysql数据库层</td></tr><tr><td>记录的内容形式</td><td><strong>物理格式日志</strong>：记录的是对于每个页的修改</td><td><strong>逻辑日志</strong>：记录的是对应的SQL语句</td></tr><tr><td>写入磁盘的时间点</td><td>在事务进行中不断被写入</td><td>只在事务提交完成后进行一次写入</td></tr><tr><td>对应关系</td><td>一个事务可以对应多个日志条目</td><td>对于每一个事务，仅对应事务的一个日志</td></tr></tbody></table><p>那么redo是怎么进行恢复的呢？<br>InnoDB存储引擎在启动的时候，<strong>不管上次数据库运行时是否正常关闭，都会尝试进行恢复操作。</strong> 而进行恢复的过程，离不开Checkpoint的发挥。</p><p><strong>由于Checkpoint表示已经刷新到磁盘页上的LSN，因此在恢复过程中只需要恢复Checkpoint开始的日志部分。</strong></p><p><img src="/posts/10001/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1pvbmdfMDkxNQ==,size_16,color_FFFFFF,t_70-1715603826650-11.png" alt></p><h4 id="2-2-5-undo"><a href="#2-2-5-undo" class="headerlink" title="2.2.5 undo"></a>2.2.5 undo</h4><p>当事务需要进行回滚的时候，这时就需要用到undo log了（保证原子性）。undo存放在数据库内部的一个特殊段：Segment中。其位于共享表空间内。此外，undo log还用于MVCC的实现，<strong>当用户读取一行记录的时候，若该记录已经被其他事务占用，当前事务可以通过undo读取之前的行版本信息，以此实现非锁定读取。</strong></p><p><strong>此外，undo log也会产生redo log，因为undo log也需要持久性的保护。</strong></p><h2 id="三-总结"><a href="#三-总结" class="headerlink" title="三.总结"></a>三.总结</h2><p>问题1：为什么要讲重做日志块和日志组？</p><blockquote><p>1.首先我们知道，<strong>InnoDB事务在进行提交之前，会先写到日志缓冲，在持久化到磁盘上</strong>，而这个<strong>日志缓冲也就是所谓的redo log buffer</strong>。<br>2.其次，<strong>redo log buffer像一个数组，由多个重做日志块组成</strong>，而重做日志文件也可以看成多个块构成，因此这个块的重要性可想而知。<br>3.第三点，谈到日志组，是想牵引出Checkpoint的概念。重点是什么？<strong>每个组的第一个文件的前4个重组块会包含两个Checkpoint</strong>，而这个Checkpoint会在数据恢复的时候使用到。</p></blockquote><p>问题2：知道LSN这个概念有用吗？</p><blockquote><p>1.首先，恕我无知，我一开始并没听说过这个东西。<br>2.第二，这个LSN和redo log息息相关。<strong>由于Checkpoint表示已经刷新到磁盘页上的LSN，因此在恢复过程中只需要恢复Checkpoint开始的日志部分。</strong> 而这个LSN就是所谓的日志序列。</p></blockquote><p>问题3：综上所述，redolog是干啥的？</p><blockquote><p>1.首先，<strong>redolog可以用来实现事务的持久性</strong>。redolog包含俩部分：<br>—-第一部分：redo log buffer：我们事务提交之前，先把数据写到这。（该部分易丢失）<br>—-第二部分： redo log file：我们事务提交后或者其他情况下，会把buffer中的内容持久化到文件中。（该部分是持久的，即安全），也因此redo log文件<strong>属于物理格式日志。</strong><br>2.<strong>我们数据库实例启动的时候，都会根据redo log去尝试进行数据恢复。</strong></p></blockquote><p>问题4：undolog又有啥用？</p><blockquote><p>1.首先，undolog用来回滚以及确保MVCC的实现。<br>2.<strong>其次undolog的原理就是生成对应SQL的逆向操作语句，在进行回滚的时候，执行对应的逆向SQL，达到正反消除即回滚的一个效果。</strong></p></blockquote><p>问题5：讲这么多种类型的文件有什么用？</p><blockquote><p>1.如错误日志：文章里告诉你怎么去寻找错误日志存储在哪，什么时候需要去看。（当然是报错的时候🤣🤣）<br>2.慢查询日志：用来干啥？优化SQL。<br>3.二进制日志：用来主从复制、数据恢复（使用mysqlbinlog工具进行恢复）。<br>4.redolog：这个日志一定要和二进制文件搞清楚，<strong>二进制文件是基于Mysql层面的，作用于所有的存储引擎，而redolog是基于InnoDB引擎层面的。</strong> 事务是InnoDB的特性对吧？那么其特性需要什么来实现？需要redolog来保证持久性，用它来记录事务对数据页进行了哪些更改。</p></blockquote><p>最后啰嗦一句，当面试问到你或者你自己想到Mysql事务是如何实现的时候，一定要想起来redolog和undolog。<strong>因为事务的持久性和原子性就是通过他们去实现的。</strong></p></div><hr><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"><span class="chip bg-color">读书笔记</span> </a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="chip bg-color">数据库</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="wechat,qq" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script></div></div></div></div></div><style>.valine-card{margin:1.5rem auto}.valine-card .card-content{padding:20px 20px 5px 20px}#vcomments textarea{box-sizing:border-box;background:url(/medias/comment_bg.png) 100% 100% no-repeat}#vcomments p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem}#vcomments blockquote p{text-indent:.2rem}#vcomments a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#vcomments img{max-width:100%;height:auto;cursor:pointer}#vcomments ol li{list-style-type:decimal}#vcomments ol,ul{display:block;padding-left:2em;word-spacing:.05rem}#vcomments ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#vcomments ul li{list-style-type:disc}#vcomments ul ul li{list-style-type:circle}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#vcomments table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#vcomments h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#vcomments h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#vcomments h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#vcomments h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#vcomments h6{font-size:1rem;line-height:1.3rem}#vcomments p{font-size:1rem;line-height:1.5rem}#vcomments hr{margin:12px 0;border:0;border-top:1px solid #ccc}#vcomments blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#vcomments pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#vcomments code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#vcomments pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#vcomments pre[class*=language-]{padding:1.2em;margin:.5em 0}#vcomments code[class*=language-],pre[class*=language-]{color:#e8eaf6}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#vcomments b,strong{font-weight:700}#vcomments dfn{font-style:italic}#vcomments small{font-size:85%}#vcomments cite{font-style:normal}#vcomments mark{background-color:#fcf8e3;padding:.2em}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}.v .vlist .vcard{padding-top:2.5em!important}</style><div class="card valine-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;left:20px;top:15px;padding-bottom:5px"><i class="fa fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="vcomments" class="card-content" style="display:grid"></div></div><script src="/libs/valine/av-min.js"></script><script src="/libs/valine/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"98JpzSGcrl9jFqHO13vqxHvX-gzGzoHsz",appKey:"mDmr2h9PB20xvPMNqgyRnNIC",notify:!0,verify:!0,visitor:!0,avatar:"mm",pageSize:"10",lang:"zh-cn",placeholder:"just go go"})</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fa fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/posts/3181/"><div class="card-image"><img src="/medias/featureimages/10.jpg" class="responsive-img" alt="西安市植物园与三五壹壹花鸟市场游记"> <span class="card-title">西安市植物园与三五壹壹花鸟市场游记</span></div></a><div class="card-content article-content"><div class="summary block-with-text">花开堪折直须折</div><div class="publish-info"><span class="publish-date"><i class="fa fa-clock-o fa-fw icon-date"></i>2024-05-04 </span><span class="publish-author"><i class="fa fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E6%9D%82%E8%AE%B0/" class="post-category">杂记</a></span></div></div><div class="card-action article-tags"><a href="/tags/%E6%9D%82%E8%AE%B0/"><span class="chip bg-color">杂记</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fa fa-chevron-right"></i></div><div class="card"><a href="/posts/44885/"><div class="card-image"><img src="/medias/featureimages/27.jpg" class="responsive-img" alt="MySQL实战45讲"> <span class="card-title">MySQL实战45讲</span></div></a><div class="card-content article-content"><div class="summary block-with-text">如何搞懂MySQL</div><div class="publish-info"><span class="publish-date"><i class="fa fa-clock-o fa-fw icon-date"></i>2024-04-29 </span><span class="publish-author"><i class="fa fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" class="post-category">读书笔记</a></span></div></div><div class="card-action article-tags"><a href="/tags/%E5%B7%A5%E7%A8%8B%E7%BB%8F%E9%AA%8C/"><span class="chip bg-color">工程经验</span> </a><a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"><span class="chip bg-color">读书笔记</span> </a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="chip bg-color">数据库</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){var n,t,o,i;void 0!==window.getSelection&&((""+(n=window.getSelection())).length<Number.parseInt("120")||(t=document.getElementsByTagName("body")[0],(o=document.createElement("div")).style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"===n.getRangeAt(0).commonAncestorContainer.nodeName&&(o.innerHTML="<pre>"+o.innerHTML+"</pre>"),i=document.location.href,o.innerHTML+='<br />来源: JoyTsing<br />文章作者: JoyTsing<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者joytsing所有，请任何形式的转载都请注明出处并在文章评论区处告知。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200)))})</script><script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script><style type="text/css">code[class*=language-],pre[class*=language-]{white-space:pre!important}</style></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fa fa-list"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>$(function(){tocbot.init({tocSelector:"#toc-content",contentSelector:"#articleContent",headingsOffset:-(.4*$(window).height()-45),headingSelector:"h2, h3, h4, h5"});let t=0;var e="toc-heading-";$("#toc-content a").each(function(){$(this).attr("href","#"+e+ ++t)}),t=0,$("#articleContent").children("h2, h3, h4, h5").each(function(){$(this).attr("id",e+ ++t)});var n=parseInt(.4*$(window).height()-64);let o=$(".toc-widget");$(window).scroll(function(){var t=$(window).scrollTop();n<t?o.addClass("toc-fixed"):o.removeClass("toc-fixed")});var i="expanded";let a=$("#toc-aside"),c=$("#main-content");$("#floating-toc-btn .btn-floating").click(function(){a.hasClass(i)?(a.removeClass(i).hide(),c.removeClass("l9")):(a.addClass(i).show(),c.addClass("l9")),function(){let e=$("#artDetail");if(0!==e.length){let t=e.width();450<=t?t+=21:350<=t&&t<450?t+=18:300<=t&&t<350?t+=16:t+=14,$("#prenext-posts").width(t)}}()})})</script></main><footer class="page-footer bg-color"><div class="container row center-align"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2019</span> <a href="/about" rel="external nofollow noreferrer">JoyTsing</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br><span id="sitetime">载入运行时间...</span> <span id="busuanzi_container_site_pv">|&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次 </span><span id="busuanzi_container_site_uv">|&nbsp;<i class="fa fa-user"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br>&nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">833.6k</span>&nbsp;字 <span id="icp"><img src="/medias/icp.png" style="vertical-align:text-bottom" alt="icp"> <a href="https://beian.miit.gov.cn/" target="_blank">陕公网安备61019002002862号 滇ICP备2024026466号-1</a></span><script>function siteTime(){var e=864e5,t="2019",n=(m=new Date).getFullYear(),o=m.getMonth()+1,r=m.getDate(),a=m.getHours(),i=m.getMinutes(),l=m.getSeconds(),m=Date.UTC(t,"7","24","0","0","0"),r=Date.UTC(n,o,r,a,i,l)-m,a=Math.floor(r/31536e6),i=Math.floor(r/e-365*a),l=Math.floor((r-(365*a+i)*e)/36e5),m=Math.floor((r-(365*a+i)*e-36e5*l)/6e4),M=Math.floor((r-(365*a+i)*e-36e5*l-6e4*m)/1e3);t==n?(document.getElementById("year").innerHTML=n,document.getElementById("sitetime").innerHTML="本站已安全运行 "+i+" 天 "+l+" 小时 "+m+" 分钟 "+M+" 秒"):(document.getElementById("year").innerHTML=t+" - "+n,document.getElementById("sitetime").innerHTML="本站已安全运行 "+a+" 年 "+i+" 天 "+l+" 小时 "+m+" 分钟 "+M+" 秒")}setInterval(siteTime,1e3)</script></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/JoyTsing" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fa fa-github"></i> </a><a href="/medias/wechat.jpg" target="_blank" data-tooltip="添加我的微信: [object Object]" data-position="top" data-delay="50"><i class="fa fa-weixin"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script src="/js/search.js"></script><script type="text/javascript">$(function(){searchFunc("/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fa fa-angle-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?3a39d92b69933ae56c7eb41ffb9aa2e0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="/libs/others/busuanzi.pure.mini.js"></script><script type="text/javascript">var st,OriginTitile=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="(oﾟvﾟ)ノ Hi",clearTimeout(st)):(document.title="(*´∇｀*) 欢迎回来！",st=setTimeout(function(){document.title=OriginTitile},3e3))})</script><script type="text/javascript" color="0,0,255" pointcolor="0,0,255" opacity="0.8" zindex="-1" count="150" src="/libs/background/canvas-nest.js"></script><script src="/libs/instantpage/instantpage.js" type="module"></script><script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script><script>const hasAttr = (e,a) => a.some(_=> e.attr(_)!==undefined);
        $('a').each(function() {
          const $this = $(this);
          if(hasAttr($this,["data-fancybox","ignore-external-link"])) return;
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== '' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":150,"height":200},"mobile":{"show":false},"react":{"opacity":0.7}});</script></body></html>